<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Excel'den Ürün Ağacı</title>
<!-- SheetJS (xlsx) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
    --border:#e5e7eb; --accent:#2563eb; --accent-50:#eff6ff;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:24px; background:var(--bg); color:var(--text);
       font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial;}
  h1{margin:0 0 12px; font-size:22px}
  .sub{color:var(--muted); font-size:14px; margin-bottom:18px}
  .wrap{max-width:1200px; margin:0 auto}
  .drop{border:2px dashed var(--border); background:#fff; border-radius:12px;
        padding:28px; text-align:center; cursor:pointer; transition:.15s ease;
        box-shadow:0 2px 10px rgba(0,0,0,.04);}
  .drop:hover{border-color:var(--accent); background:var(--accent-50)}
  .hidden{display:none}
  .btn{background:var(--accent); color:#fff; border:0; border-radius:10px;
       padding:10px 14px; font-weight:600; cursor:pointer}
  #status{margin-top:10px; color:var(--muted); font-size:13px}
  .grid{display:grid; grid-template-columns:1fr; gap:16px; margin-top:18px}
  @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px;
        padding:16px 16px 6px; box-shadow:0 2px 10px rgba(0,0,0,.05)}
  .card h3{margin:0 0 10px; font-size:16px}
  .tree{line-height:1.35}
  details{border-left:2px solid #e5e7eb; margin:2px 0 2px 10px; padding-left:10px}
  summary{list-style:none; cursor:pointer; padding:6px 8px; border-radius:8px}
  summary:hover{background:#f3f4f6}
  .edge{display:flex; align-items:center; gap:6px; font-size:13px; color:#374151}
  .qty{display:inline-block; min-width:64px; padding:2px 6px; border:1px solid #e5e7eb;
       border-radius:999px; font-variant-numeric:tabular-nums; background:#fafafa}
  .leaf{margin:2px 0 2px 26px; color:#374151; font-size:13px}
  .badge{font-size:12px; color:#6b7280; margin-left:6px}
  .toolbar{display:flex; gap:8px; align-items:center; margin:14px 0}
  .search{flex:1; border:1px solid var(--border); border-radius:10px; padding:10px 12px}
  .hint{font-size:12px; color:var(--muted); margin-left:6px}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Ürün Ağacı Görselleştirici</h1>
  <div class="sub">Excel dosyanı sürükle-bırak veya tıkla. İlk sayfadaki <strong>ANA BOM</strong>, <strong>HAMMADDE</strong>, <strong>ADET</strong>, <strong>UNIT</strong> sütunları kullanılır.</div>

  <label class="drop" id="drop">
    <input id="file" type="file" accept=".xlsx,.xls" class="hidden" />
    <div><strong>Dosyayı buraya sürükleyin</strong> veya tıklayın</div>
    <div id="status"></div>
  </label>

  <div class="toolbar hidden" id="tools">
    <input id="search" class="search" placeholder="Düğümlerde ara (ör. 'CAP_SMD_CER 10uF')" />
    <span class="hint">İpucu: Bir kökü kapatıp/açmak için başlığı tıklayın.</span>
  </div>

  <div id="summary" class="sub hidden"></div>
  <div id="trees" class="grid"></div>
</div>

<script>
(function(){
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const status = document.getElementById('status');
  const treesEl = document.getElementById('trees');
  const tools = document.getElementById('tools');
  const searchEl = document.getElementById('search');
  const summaryEl = document.getElementById('summary');

  function normHeader(h){
    return String(h||'').trim().toLowerCase()
      .replace(/\s+/g,' ')
      .replace(/ı/g,'i') // tr tolerant
      .replace(/[^\w ]+/g,'')
  }
  // map many variants to canonical keys
  function headerMap(headers){
    const map = {};
    headers.forEach(h=>{
      const n = normHeader(h);
      if(/ana ?bom/.test(n)) map.parent = h;
      else if(/hamm?adde/.test(n) || /material|component/.test(n)) map.child = h;
      else if(/adet|qty|quantity/.test(n)) map.qty = h;
      else if(/^unit$|birim/.test(n)) map.unit = h;
    });
    return map;
  }
  const text = v => (v==null ? '' : String(v)).trim();

  // Build adjacency from rows
  function buildGraph(rows, cols){
    const adj = new Map();          // parent -> [{child, qty, unit}]
    const parents = new Set();
    const children = new Set();

    for(const r of rows){
      const parent = text(r[cols.parent]);
      const child  = text(r[cols.child]);
      if(!parent || !child) continue;

      const qty = text(r[cols.qty]);
      const unit= text(r[cols.unit]);

      if(!adj.has(parent)) adj.set(parent, []);
      adj.get(parent).push({ child, qty, unit });

      parents.add(parent);
      children.add(child);
    }
    // roots: parents that never appear as child
    const roots = [...parents].filter(p => !children.has(p));
    // also: if no distinct roots, fall back to unique parents to show something
    const rootsSafe = roots.length ? roots : [...parents];
    return { adj, roots: rootsSafe, parents, children };
  }

  // Build recursive tree structure
  function makeNode(name, adj, seen=new Set()){
    const node = { name, children: [] };
    if(seen.has(name)) return node; // avoid cycles
    seen.add(name);
    const edges = adj.get(name) || [];
    for(const e of edges){
      const childNode = makeNode(e.child, adj, new Set(seen));
      childNode._edge = { qty: e.qty, unit: e.unit }; // annotate edge info
      node.children.push(childNode);
    }
    return node;
  }

  // Render as nested <details>
  function renderTreeCard(rootName, tree){
    const card = document.createElement('div');
    card.className = 'card';

    const title = document.createElement('h3');
    title.textContent = rootName;
    const badge = document.createElement('span');
    badge.className = 'badge';
    badge.textContent = `alt malzeme: ${countLeaves(tree)}`;
    title.appendChild(badge);
    card.appendChild(title);

    const container = document.createElement('div');
    container.className = 'tree';
    container.appendChild(renderDetails(tree, true));
    card.appendChild(container);
    return card;
  }

  function countLeaves(node){
    if(!node.children || !node.children.length) return 1;
    return node.children.reduce((a,c)=>a+countLeaves(c),0);
  }

  function renderDetails(node, isRoot=false){
    const det = document.createElement('details');
    det.open = isRoot; // kök açık

    const sum = document.createElement('summary');
    sum.innerHTML = `<strong>${escapeHtml(node.name||'(Boş)')}</strong>` +
      (node.children?.length ? ` <span class="pill">${node.children.length} çocuk</span>` : '');
    det.appendChild(sum);

    if(node.children && node.children.length){
      node.children.forEach(ch=>{
        if(ch.children && ch.children.length){
          // edge line for expandable child
          const line = document.createElement('div');
          line.className = 'edge';
          const qty = ch._edge?.qty ?? '';
          const unit = ch._edge?.unit ?? '';
          const qtyEl = document.createElement('span');
          qtyEl.className = 'qty';
          qtyEl.textContent = `${qty}${unit? ' '+unit:''}`;
          line.appendChild(qtyEl);
          const label = document.createElement('span');
          label.innerHTML = `<em>${escapeHtml(ch.name)}</em>`;
          line.appendChild(label);
          det.appendChild(line);
          // then nested details
          det.appendChild(renderDetails(ch, false));
        } else {
          // leaf
          const leaf = document.createElement('div');
          leaf.className = 'leaf';
          const qty = ch._edge?.qty ?? '';
          const unit = ch._edge?.unit ?? '';
          leaf.innerHTML = `<span class="qty">${escapeHtml(`${qty}${unit? ' '+unit:''}`)}</span> ${escapeHtml(ch.name)}`;
          det.appendChild(leaf);
        }
      });
    }
    return det;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // Search/filter highlighting
  function enableSearch(){
    searchEl.addEventListener('input', ()=>{
      const q = searchEl.value.trim().toLowerCase();
      const cards = treesEl.querySelectorAll('.card');
      cards.forEach(card=>{
        if(!q){ card.style.display=''; return; }
        const hit = card.textContent.toLowerCase().includes(q);
        card.style.display = hit ? '' : 'none';
      });
    });
  }

  // File handling
  drop.addEventListener('click', ()=>fileInput.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('hover') });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('hover'));
  drop.addEventListener('drop', e=>{
    e.preventDefault();
    drop.classList.remove('hover');
    const f = e.dataTransfer.files?.[0];
    if(f) handleFile(f);
  });
  fileInput.addEventListener('change', e=>{
    const f = e.target.files?.[0];
    if(f) handleFile(f);
  });

  async function handleFile(file){
    status.textContent = `Yükleniyor: ${file.name} …`;
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
    if(!rows.length){ status.textContent='Bu sayfada veri yok.'; return; }

    // headers mapping
    const headers = Object.keys(rows[0]);
    const cols = headerMap(headers);
    if(!cols.parent || !cols.child || !cols.qty || !cols.unit){
      status.innerHTML = 'Başlıklar bulunamadı. Gerekli sütunlar: <b>ANA BOM</b>, <b>HAMMADDE</b>, <b>ADET</b>, <b>UNIT</b>.';
      return;
    }

    const { adj, roots, parents, children } = buildGraph(rows, cols);
    treesEl.innerHTML = '';
    roots.forEach(r=>{
      const tree = makeNode(r, adj);
      treesEl.appendChild( renderTreeCard(r, tree) );
    });

    tools.classList.remove('hidden');
    summaryEl.classList.remove('hidden');
    summaryEl.innerHTML = `Kök sayısı: <b>${roots.length}</b> · Ebeveyn düğüm: <b>${parents.size}</b> · Bir kez çocuk olan düğüm: <b>${children.size}</b>`;
    status.textContent = 'Hazır.';
    enableSearch();
  }
})();
</script>
</body>
</html>

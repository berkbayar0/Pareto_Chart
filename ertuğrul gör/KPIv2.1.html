<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>KPI Hesapalama</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --accent:#2563eb; --accent-200:#bfdbfe;
    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;margin:16px;background:var(--bg);color:var(--text)}
    .drop{border:2px dashed #cbd5e1;padding:16px;text-align:center;border-radius:10px;background:#fff}
    .drop.active{border-color:var(--accent);background:#eef5ff}
    .hidden{display:none!important}
    .msg{margin-top:8px;color:#334155;font-size:14px}
    .topbar{display:flex; gap:8px; flex-wrap:wrap; margin:14px 0;background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px;}
    .btn-tab{appearance:none; border:1px solid var(--border); background:#f8fafc; color:var(--text);padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
    .btn-tab:hover{border-color:var(--accent); background:#eef5ff}
    .btn-tab.active{border-color:var(--accent); background:#e0ecff}
    .panel{background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px}
    .panel-title{font-weight:700; margin:4px 0 10px; color:#0f172a}
    .table-wrap{margin-top:8px; border:1px solid var(--border); border-radius:8px;overflow:auto; max-height:70vh; background:#fff;}
    .table-wrap table{border-collapse:collapse; font-size:13px; width:max-content; min-width:100%;table-layout: fixed;}
    .table-wrap th, .table-wrap td{border:1px solid #e5e7eb; padding:4px 8px; white-space:normal;word-wrap: break-word;overflow-wrap: break-word;width: 8ch; min-width: 8ch;max-width: 8ch;}
    .table-wrap th{background:#f3f6fb; position:sticky; top: 0px; z-index:1;padding: 4px 8px;}
    .table-wrap tbody tr:hover {background-color: #f1f5f9 !important;cursor: pointer;}
    .table-wrap tbody tr.selected {background-color: #dbeafe !important;border-left: 3px solid var(--accent);}
    .table-wrap tbody tr.selected:hover {background-color: #bfdbfe !important;}
    .info-bar{display:flex; gap:8px; flex-wrap:wrap;margin:8px 0 6px; justify-content: flex-start;align-items: center;}
    .filter-section {display: flex;gap: 8px;align-items: center;flex-wrap: wrap;}
    .filter-dropdown {padding: 6px 10px;border: 1px solid #d1d5db;border-radius: 6px;font-size: 12px;background: white;cursor: pointer;min-width: 120px;max-width: 120px;}   .clear-filters-btn {padding: 4px 8px;background: #ef4444;color: white;border: none;border-radius: 4px;font-size: 11px;cursor: pointer;}
    .chip{background:#f1f5f9; border:1px solid var(--border);border-radius:999px; padding:6px 10px; font-size:12px; color:#0f172a;}
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;}
    .loading-popup{background:white;padding:24px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);text-align:center;min-width:200px;}
    .spinner{font-size:24px;animation:spin 1s linear infinite;margin-bottom:12px;}
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading { animation: spin 1s linear infinite; }
    .ok-column {background-color: #dcfce7 }
    .nok-column {background-color: #fecaca}
    .proses-btn {padding: 8px 16px;border: 1px solid #d1d5db;background: #fff;color: #374151;border-radius: 6px;cursor: pointer;font-size: 13px;font-weight: 500;transition: all 0.2s;}
    .proses-btn:hover {border-color: var(--accent);background: #f0f9ff}
    .proses-btn.active {border-color: var(--accent);background: var(--accent);color: white;}
    .proses-section {margin-top: 15px;}
    .multi-select-dropdown { position: relative; display: inline-block; }
    .multi-select-button { padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white; cursor: pointer; min-width: 120px; max-width: 120px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    .multi-select-button:hover { border-color: #9ca3af; }
    .multi-select-dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 200px; max-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); border: 1px solid #d1d5db; border-radius: 6px; z-index: 1000; max-height: 200px; overflow-y: auto; top: 100%; left: 0; }
    .multi-select-dropdown-content.show { display: block; }
    .multi-select-option { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 12px; border-bottom: 1px solid #f3f4f6; }
    .multi-select-option:hover { background-color: #f9fafb; }
    .multi-select-option:last-child { border-bottom: none; }
    .multi-select-checkbox { margin-right: 8px; cursor: pointer; }
    .dropdown-arrow { margin-left: 8px; transition: transform 0.2s; }
    .dropdown-arrow.open { transform: rotate(180deg); }
    /*kpÄ± tablosu yapÄ±yorum*/
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .tbl{width:100%;border-collapse:collapse;font-size:13px;line-height:1.2}
    .thead tr{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%)}
    .th,.td{padding:4px 5px;border:1px solid #cbd5e1;text-align:center;line-height:1.2}
    .th{font-weight:600;background:#f1f5f9;color:#334155;font-size:12px;line-height:1.2}
    .th.kpi{font-weight:700;background:linear-gradient(135deg,#e2e8f0 0%,#cbd5e1 100%);color:#475569;font-size:13px;text-align:center;line-height:1.2}
    .row{background:linear-gradient(135deg,#fefefe 0%,#f8fafc 100%)}
    .kpi-box{text-align:left;vertical-align:top;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);border:1px solid #cbd5e1;width:fit-content;min-width:100px;max-width:200px;white-space:nowrap;line-height:1.2}
    .kpi-title{font-weight:600;color:#1e293b;font-size:14px;margin-bottom:2px;line-height:1.2}
    .kpi-sub{font-weight:500;color:#64748b;font-size:13px;line-height:1.2}
    .tgt{font-weight:600;color:#059669;font-size:12px;line-height:1.2}
    .val{font-weight:600;color:#2563eb;font-size:12px;line-height:1.2}

  </style>
</head>
<body>
  <h2>KPI Hesapalama Analizi</h2>
  <div id="dropArea" class="drop">
    <div><strong>DosyanÄ±zÄ± buraya sÃ¼rÃ¼kleyip bÄ±rakÄ±n</strong></div>
    <div style="margin:8px 0;">veya</div>
    <div>
      <button id="browseBtn" class="btn-tab">Bilgisayardan SeÃ§</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
    </div>
    <div id="msg" class="msg"></div>
      <span id="loadingSpinner" class="hidden">â³</span>
      <span id="msgText"></span>
  </div>
  <div class="topbar hidden" id="topbar">
    <button class="btn-tab active" id="tab-main"   data-target="panel-main">Ana Tablo</button>
    <button class="btn-tab"        id="tab-2"      data-target="panel-2">DuruÅŸ SÃ¼releri Analizi</button>
    <button class="btn-tab"        id="tab-3"      data-target="panel-3">OEE Analizi</button>
    <button class="btn-tab"        id="tab-4"      data-target="panel-4">Proses Analizi</button>
    <button class="btn-tab"        id="tab-5"      data-target="panel-5">KPI Tablo</button>
    <button class="btn-tab"        id="tab-6"      data-target="panel-6">Buton 6</button>
    <button class="btn-tab"        id="tab-7"      data-target="panel-7">Buton 7</button>
    <button class="btn-tab"        id="tab-8"      data-target="panel-8">Buton 8</button>
    <button class="btn-tab"        id="tab-9"      data-target="panel-9">Buton 9</button>
    <button class="btn-tab"        id="tab-10"     data-target="panel-10">Buton 10</button>
  </div>
    <div id="panel-main" class="panel hidden">
        <div class="panel-title">Ana Tablo</div>
        <div id="fileInfoBar" class="info-bar hidden">
            <span class="chip" id="chipName">ğŸ“„ â€”</span>
            <span class="chip" id="chipSize">ğŸ“¦ â€”</span>
            <span class="chip" id="chipSheet">ğŸ“‘ â€”</span>
            <span class="chip" id="chipRows">ğŸ“‹ â€”</span>
            <span class="chip" id="chipCols">ğŸ“ â€”</span>
            <div class="chip" style="display:flex;align-items:center;gap:6px;margin-left:auto;">
                <span>ğŸ“… Tarih AralÄ±ÄŸÄ±:</span>
                <input type="date" id="dateFrom" max="" style=" border: 1px solid #d1d5db;border-radius:4px;padding:2px 6px;font-size:12px;" placeholder="BaÅŸlangÄ±Ã§">
                <span>-</span>
                <input type="date" id="dateTo" max="" style="border:1px solid #d1d5db;border-radius:4px;padding:2px 6px;font-size:12px;" placeholder="BitiÅŸ">
                <button id="clearFilter" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer;">Temizle</button>
            </div>
        </div>
        <div id="mainPagination"></div>
        <div id="tableWrap" class="table-wrap"></div>
        <div id="errorSection" class="hidden" style="margin-top:30px;">     <!-- Hata Raporu Tablosu -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                <h3 style="margin:0;color:#000000;font-size:16px;">âš ï¸ Hata Raporu</h3>
                <span id="errorCount" class="chip" style="background:#ffffff;color:#000000;border-color:#d1d5db;">0 hata</span>
                <button id="toggleErrorTable" style="background:#dc2626;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">Gizle/GÃ¶ster</button>
            </div>
            <div id="errorTableContainer">
                <div id="errorTableWrap" class="table-wrap" style="max-height:400px;"></div>
            </div>
        </div>
    </div>
  <div id="panel-2"  class="panel hidden">
    <div class="panel-title">DuruÅŸ SÃ¼releri Analizi</div>
    <div class="info-bar">
        <div class="chip" style="display:flex;align-items:center;gap:6px;margin-left:auto;">
            <span>ğŸ“… Tarih AralÄ±ÄŸÄ±:</span>
            <input type="date" id="durusDateFrom" max="" style="border: 1px solid #d1d5db;border-radius:4px;padding:2px 6px;font-size:12px;" placeholder="BaÅŸlangÄ±Ã§">
            <span>-</span>
            <input type="date" id="durusDateTo" max="" style="border:1px solid #d1d5db;border-radius:4px;padding:2px 6px;font-size:12px;" placeholder="BitiÅŸ">
            <button id="durusClearFilter" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer;">Temizle</button>
        </div>
    </div>
    <div id="durusPagination"></div>
    <div id="durusTableWrap" class="table-wrap"></div>
  </div>
<div id="panel-3"  class="panel hidden">
    <div class="panel-title">OEE Analizi</div>
    <div class="info-bar">
        <div class="chip" style="display:flex;align-items:center;gap:6px;margin-left:auto;">
            <span>Tarih AralÄ±ÄŸÄ±:</span>
            <input type="date" id="grafikDateFrom" max="" style="border: 1px solid #d1d5db;border-radius:4px;padding:2px 6px;font-size:12px;" placeholder="BaÅŸlangÄ±Ã§">
            <span>-</span>
            <input type="date" id="grafikDateTo" max="" style="border:1px solid #d1d5db;border-radius:4px;padding:2px 6px;font-size:12px;" placeholder="BitiÅŸ">
            <button id="grafikClearFilter" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer;">Temizle</button>
        </div>
    </div>
    <div style="margin-top:15px;">       <!-- Sol Tablo - Toplam Ãœretim -->
        <div style="display:inline-block;vertical-align:top;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:15px;margin-right:15px;min-width:280px;">
            <h4 style="margin:0 0 12px 0;color:#374151;font-size:14px;font-weight:600;text-align:center;border-bottom:1px solid #f3f4f6;padding-bottom:8px;">Toplam Ãœretim</h4>
            <div style="font-size:13px;line-height:1.6;">
                <div style="display:flex;justify-content:space-between;padding:3px 0;">
                    <span>OK ÃœrÃ¼n:</span>
                    <span id="grafikOkUrun" style="color:#059669;font-weight:500;">0</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:3px 0;">
                    <span>NOK ÃœrÃ¼n:</span>
                    <span id="grafikNokUrun" style="color:#dc2626;font-weight:500;">0</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:3px 0;border-top:1px solid #f3f4f6;margin-top:6px;padding-top:6px;">
                    <span>Toplam:</span>
                    <span id="grafikToplam" style="font-weight:600;">0</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:3px 0;">
                    <span>Verimlilik:</span>
                    <span id="grafikVerimlilik" style="color:#2563eb;font-weight:500;">0%</span>
                </div>
            </div>
        </div>
        <div style="display:inline-block;vertical-align:top;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:15px;min-width:350px;">
            <h4 style="margin:0 0 12px 0;color:#374151;font-size:14px;font-weight:600;text-align:center;border-bottom:1px solid #f3f4f6;padding-bottom:8px;">DuruÅŸ Analizi</h4>
            <div style="font-size:13px;line-height:1.6;">
                <div style="display:flex;justify-content:space-between;padding:3px 0;">
                    <span>Toplam DuruÅŸ:</span>
                    <span id="grafikToplamDurus" style="color:#dc2626;font-weight:500;">0 dk (0dk)</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:3px 0;">
                    <span>PlanlÄ± DuruÅŸ:</span>
                    <span id="grafikPlanliDurus" style="color:#f59e0b;font-weight:500;">0 dk (0dk)</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:3px 0;">
                    <span>PlansÄ±z DuruÅŸ:</span>
                    <span id="grafikPlansizDurus" style="color:#dc2626;font-weight:500;">0 dk (0dk)</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:3px 0;border-top:1px solid #f3f4f6;margin-top:6px;padding-top:6px;">
                    <span>Toplam Ã‡alÄ±ÅŸÄ±lan(Net):</span>
                    <span id="grafikToplamCalisma" style="color:#059669;font-weight:500;">0 dk (0dk)</span>
                </div>
            </div>
        </div>
        <div style="margin-top:30px;">      <!-- AylÄ±k Analiz Tablosu -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
                <select id="yilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                    <option value="">TÃ¼m YÄ±llar</option>
                </select>
            </div>
            <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
                <table id="aylikAnaliz" style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead>
                        <tr style="background:#f8fafc;">
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:left;">Ay</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Toplam Ã‡alÄ±ÅŸÄ±lan SÃ¼re</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Planlanan DuruÅŸlar</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Planlanan DuruÅŸ %</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Personel KaynaklÄ± DuruÅŸlar</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Personel DuruÅŸ %</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Makine+Ekipman DuruÅŸlar</th>
                            <th style="padding:12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Makine+Ekipman %</th>
                        </tr>
                    </thead>
                    <tbody id="aylikAnalizBody">
                        <!-- Buraya JavaScript ile satÄ±rlar eklenecek -->
                    </tbody>
                </table>
            </div>
        </div>
        <div style="margin-top:30px;">      <!-- Ek Analiz Tablosu -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
                <select id="ekAnalizYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                    <option value="">TÃ¼m YÄ±llar</option>
                </select>
            </div>
            <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
                <h4 style="margin:0;padding:12px;background:#f8fafc;border-bottom:1px solid #e5e7eb;color:#374151;font-size:15px;font-weight:600;">ğŸ“Š Genel OEE Analiz Tablosu</h4>
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                    <thead>
                        <tr style="background:#f8fafc;">
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:left;">Ay</th>
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Ãœretilmesi Gereken (Lens AA)</th>
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Ãœretilen (Depoya Giren ÃœrÃ¼n)</th>
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Ã‡alÄ±ÅŸma PerformansÄ±</th>
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Net Ã‡alÄ±ÅŸma (Lens AA)</th>
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Kalite (Son Kontrol)</th>
                            <th style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:600;text-align:center;">Genel OEE</th>
                        </tr>
                    </thead>
                    <tbody id="ekAnalizBody">
                        <!-- JavaScript ile doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="panel-4" class="panel hidden">
    <div class="panel-title">Proses Analizi</div>       <!-- Proses iÃ§indeki butonlar -->
    <div style="display:flex;gap:8px;margin:15px 0;padding:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;">
        <button class="proses-btn active" id="smd-btn" data-target="smd-section">SMD</button>
        <button class="proses-btn" id="lens-btn" data-target="lens-section">LENS AA</button>
        <button class="proses-btn" id="eol-btn" data-target="eol-section">EOL</button>
        <button class="proses-btn" id="sizdirmazlik-btn" data-target="sizdirmazlik-section">SIZDIRMAZLIK</button>
        <button class="proses-btn" id="lazer-btn" data-target="lazer-section">LAZER</button>
        <button class="proses-btn" id="son-kontrol-btn" data-target="son-kontrol-section">SON KONTROL</button>
    </div>
    <div id="smd-section" class="proses-section">       <!-- SMD Section (default aÃ§Ä±k) -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
            <select id="smdYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                <option value="">TÃ¼m YÄ±llar</option>
            </select>
            <button onclick="showReferansTabloPopup()" style="
                padding: 6px 12px; background: #2563eb; color: white; border: none; 
                border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;
                margin-left: auto; display: flex; align-items: center; gap: 6px;
            ">ğŸ“‹Referans Tablosu
            </button>
        </div>
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:70vh;">
            <table id="smdAnalyzTable" style="width:100%;border-collapse:collapse;font-size:11px;white-space: nowrap;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Ay</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Hafta</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Dizilen Adet</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Fire (atÄ±m)</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">Dizilen Kompanent</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Dizilmesi Gereken Adet</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Net SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">PlansÄ±z DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">PlanlÄ± DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Personel DuruÅŸu</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:110px;">Makina / Program AyarÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Setup</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Makina ArÄ±zasÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">AylÄ±k Dizilen</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">AylÄ±k Dizilmesi Gereken</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">AylÄ±k Fire</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Net Ã‡alÄ±ÅŸma</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:130px;">AylÄ±k Ã‡alÄ±ÅŸma Performans</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:140px;">Ä°stasyon BazlÄ± Kalite OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:110px;">AylÄ±k Setup OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">AylÄ±k ArÄ±za DuruÅŸu</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:110px;">AylÄ±k Fire OranÄ±</th>
                    </tr>
                </thead>
                <tbody id="smdAnalyzBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="lens-section" class="proses-section hidden">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
            <select id="lensYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                <option value="">TÃ¼m YÄ±llar</option>
            </select>
        </div>

        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:110vh;">
            <table id="lensAnalyzTable" style="width:100%;border-collapse:collapse;font-size:11px;white-space: nowrap;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Ay</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Hafta</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">OK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">NOK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Makinaya Giren</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;white-space:normal;">Ãœretilmesi Gereken Adet(x/55)</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Net SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">PlansÄ±z DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">PlanlÄ± DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Personel DuruÅŸu</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Makina ArÄ±zasÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:140px;">Toplam Ãœretilmesi Gereken</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Net SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">Net Ã‡alÄ±ÅŸma</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:140px;">ArÄ±za KaynaklÄ± DuruÅŸ OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:140px;">Ä°stasyon BazlÄ± Kalite OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:130px;">Ã‡alÄ±ÅŸma Performans OranÄ±</th>
                    </tr>
                </thead>
                <tbody id="lensAnalyzBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="eol-section" class="proses-section hidden">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
            <select id="eolYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                <option value="">TÃ¼m YÄ±llar</option>
            </select>
        </div>
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:110vh;">
            <table id="eolAnalyzTable" style="width:100%;border-collapse:collapse;font-size:11px;white-space: nowrap;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Ay</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Hafta</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">OK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">NOK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">OK OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">Ã‡alÄ±ÅŸma SÃ¼resi</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">Toplam Ã‡alÄ±ÅŸma</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">PlanlÄ± DuruÅŸ</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">PlansÄ±z DuruÅŸlar</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Personel DuruÅŸu</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:90px;">Makina ArÄ±zasÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Setup SÃ¼resi</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Net SÃ¼re</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Net Ã‡alÄ±ÅŸma OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Ãœretilmesi Gereken</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">Ãœretilen ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:130px;">Setup KaynaklÄ± KayÄ±p</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:130px;">Ã‡alÄ±ÅŸma Performans OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:110px;">ArÄ±za KaynaklÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:140px;">Ä°stasyon BazlÄ± Kalite OranÄ±</th>
                    </tr>
                </thead>
                <tbody id="eolAnalyzBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="sizdirmazlik-section" class="proses-section hidden">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
            <select id="sizdirmazlikYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                <option value="">TÃ¼m YÄ±llar</option>
            </select>
        </div>
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:110vh;">
            <table id="sizdirmazlikAnalyzTable" style="width:100%;border-collapse:collapse;font-size:11px;white-space: nowrap;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Ay</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Hafta</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">OK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">NOK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">TOPLAM</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">OK OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">Kalite OranÄ±</th>
                    </tr>
                </thead>
                <tbody id="sizdirmazlikAnalyzBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="lazer-section" class="proses-section hidden">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
            <select id="lazerYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                <option value="">TÃ¼m YÄ±llar</option>
            </select>
        </div>
        
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:110vh;">
            <table id="lazerAnalyzTable" style="width:100%;border-collapse:collapse;font-size:11px;white-space: nowrap;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Ay</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Hafta</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">OK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">NOK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">AylÄ±k Toplam</th>
                    </tr>
                </thead>
                <tbody id="lazerAnalyzBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="son-kontrol-section" class="proses-section hidden">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <span style="font-weight:600;color:#374151;">YÄ±l SeÃ§imi:</span>
            <select id="sonKontrolYilFiltresi" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:white;cursor:pointer;min-width:100px;">
                <option value="">TÃ¼m YÄ±llar</option>
            </select>
        </div>
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:110vh;">
            <table id="sonKontrolAnalyzTable" style="width:100%;border-collapse:collapse;font-size:11px;white-space: nowrap;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">Ay</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:120px;">Hafta</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">ÃœrÃ¼n</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">OK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:60px;">NOK</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Toplam</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">AylÄ±k Toplam</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Hata OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:80px;">Kalite OranÄ±</th>
                        <th style="padding:8px;border:1px solid #e5e7eb;font-weight:600;text-align:center;min-width:100px;">OK OranÄ±</th>
                    </tr>
                </thead>
                <tbody id="sonKontrolAnalyzBody">
                    <!-- JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
</div>
  <div id="panel-5" class="panel hidden">
    <div class="panel-title">KPI Tablo 2025</div>
    <div style="margin-top:20px">
        <div class="card">
        <table class="tbl">
            <thead class="thead">
            <tr>
                <th class="th kpi" rowspan="2">KPI 2025</th>
                <th class="th">Target</th>
                <th class="th">Unit</th>
                <th class="th">Ocak</th>
                <th class="th">Åubat</th>
                <th class="th">Mart</th>
                <th class="th">Nisan</th>
                <th class="th">MayÄ±s</th>
                <th class="th">Haziran</th>
                <th class="th">Temmuz</th>
                <th class="th">AÄŸustos</th>
                <th class="th">EylÃ¼l</th>
                <th class="th">Ekim</th>
                <th class="th">KasÄ±m</th>
                <th class="th">AralÄ±k</th>
            </tr>
            </thead>
            <tbody>
            <tr class="row">
                <td class="kpi-box">
                <div class="kpi-title">Effective Capacity Utilization Rate (SMD)</div>
                <div class="kpi-sub">Net Kapasite KullanÄ±m OranÄ± (SMD)</div>
                </td>
                <td class="td tgt">65%</td>
                <td class="td">%</td>
                <td class="td val">-</td><td class="td val">-</td><td class="td val">-</td>
                <td class="td val">-</td><td class="td val">-</td><td class="td val">-</td>
                <td class="td val">-</td><td class="td val">-</td><td class="td val">-</td>
                <td class="td val">-</td><td class="td val">-</td><td class="td val">-</td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
    </div>
  <div id="panel-6"  class="panel hidden"><div class="panel-title">Buton 6</div>
  <div>Buraya Ã¶zelliÄŸin gelecektir.</div></div>
  <div id="panel-7"  class="panel hidden"><div class="panel-title">Buton 7</div>
  <div>Buraya Ã¶zelliÄŸin gelecektir.</div></div>
  <div id="panel-8"  class="panel hidden"><div class="panel-title">Buton 8</div>
  <div>Buraya Ã¶zelliÄŸin gelecektir.</div></div>
  <div id="panel-9"  class="panel hidden"><div class="panel-title">Buton 9</div>
  <div>Buraya Ã¶zelliÄŸin gelecektir.</div></div>
  <div id="panel-10" class="panel hidden"><div class="panel-title">Buton 10</div>
  <div>Buraya Ã¶zelliÄŸin gelecektir.</div></div>
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-popup">
      <div class="spinner">â³</div>
      <div id="loadingText">YÃ¼kleniyor...</div>
    </div>
  </div>  
    <script>
        const $ = (id) => document.getElementById(id);
        const dropArea = $('dropArea');
        const browseBtn = $('browseBtn');
        const fileInput = $('fileInput');
        const msg = $('msg');
        const topbar = $('topbar');
        const tableWrap = $('tableWrap');
        const fileInfoBar = document.getElementById('fileInfoBar');
        const chipName    = document.getElementById('chipName');
        const chipSize    = document.getElementById('chipSize');
        const chipSheet   = document.getElementById('chipSheet');
        const chipRows    = document.getElementById('chipRows');
        const chipCols    = document.getElementById('chipCols');
        const clearFilter = document.getElementById('clearFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const msgText = document.getElementById('msgText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const durusClearFilter = document.getElementById('durusClearFilter');
        const durusDateFrom = document.getElementById('durusDateFrom');
        const durusDateTo = document.getElementById('durusDateTo');
        const grafikClearFilter = document.getElementById('grafikClearFilter');
        const grafikDateFrom = document.getElementById('grafikDateFrom');
        const grafikDateTo = document.getElementById('grafikDateTo'); 
        const yilFiltresi = document.getElementById('yilFiltresi');

        let allErrorRows = [];
        let workbookRef = null;
        let allSuccessRows = []; // TÃ¼m baÅŸarÄ±lÄ± satÄ±rlarÄ± saklamak iÃ§in
        let currentHeader = [];  // Header'Ä± saklamak iÃ§in
        let currentFilters = {name: '',product: '',process: '',};       //filtreleme Ã¶zellikleri
        let uniqueValues = {name: [],product: [],process: [],};
        let currentDurusFilters = {name: [],product: [],process: []};
        let durusUniqueValues = {name: [],product: [],process: []};
        const norm = s => String(s ?? '')
            .toLowerCase()
            .replace(/[Ä±Ä°]/g, 'i').replace(/[ÅŸÅ]/g, 's').replace(/[ÄŸÄ]/g, 'g')
            .replace(/[Ã§Ã‡]/g, 'c').replace(/[Ã¶Ã–]/g, 'o').replace(/[Ã¼Ãœ]/g, 'u')
            .trim();
        function findColIndex(headerRow, keywords) {
            const H = headerRow.map(h => norm(h));
            for (let i = 0; i < H.length; i++) {
            const cell = H[i];
            if (!cell) continue;
            if (keywords.every(kw => cell.includes(kw))) return i;
            }
            return -1;
        }
        function excelDateToJSDate(serial){
            const excelEpoch = new Date(1900, 0, 1);
            return new Date(excelEpoch.getTime() + (serial - 2) * 86400000);
        }
        function numToHHMM(n){
            const frac = ((Number(n) % 1) + 1) % 1;    // gÃ¼nÃ¼n kesir kÄ±smÄ± (0..1)
            const totalMin = Math.round(frac * 24 * 60);
            const hh = String(Math.floor(totalMin / 60) % 24).padStart(2,'0');
            const mm = String(totalMin % 60).padStart(2,'0');
            return `${hh}:${mm}`;
        }
        const Hatalar_list  = Array.from({length:93}, (_,i)=>`H${i}`);
        const Duruslar_list = Array.from({length:25}, (_,i)=>`D${i}`);
        function formatMDY_HHMMSS(d){
            const M  = d.getMonth() + 1;
            const D  = d.getDate();
            const YY = String(d.getFullYear()).slice(-2);
            const hh = String(d.getHours()).padStart(2,'0');
            const mm = String(d.getMinutes()).padStart(2,'0');
            const ss = String(d.getSeconds()).padStart(2,'0');
            return `${M}.${D}.${YY} ${hh}:${mm}:${ss}`;
        }
        function filterDurusTableByDate() {     // duruÅŸlar iÃ§in tarih filtersini burda ekledim
            const fromDate = durusDateFrom.value;
            const toDate = durusDateTo.value;
            if ((!fromDate && !toDate) || !allSuccessRows.length) return;
            
            showLoading('DuruÅŸlar Filtreleniyor...');
            setTimeout(() => {
                const dateColIndex = currentHeader.findIndex(h => 
                    norm(h).includes('tarih') || norm(h).includes('date')
                );
                if (dateColIndex === -1) {
                    alert('Tarih sÃ¼tunu bulunamadÄ±!');
                    hideLoading();
                    return;
                }
                const filteredRows = allSuccessRows.filter(row => {
                    const cellDate = String(row[dateColIndex] || '').trim();
                    const dateParts = cellDate.split('.');
                    if (dateParts.length !== 3) return false;
                    const cellDateFormatted = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                    
                    let matchesFrom = true;
                    let matchesTo = true;
                    if (fromDate) matchesFrom = cellDateFormatted >= fromDate;
                    if (toDate) matchesTo = cellDateFormatted <= toDate;
                    return matchesFrom && matchesTo;
                });
                window.filteredDurusRows = filteredRows;
                currentDurusPage = 1;
                createDurusAnalysisTable();
                hideLoading();
            }, 100);
        }
        function clearDurusDateFilter() {
            durusDateFrom.value = '';
            durusDateTo.value = '';
            currentDurusPage = 1;
            window.filteredDurusRows = allSuccessRows;
            createDurusAnalysisTable();
        }
        function parseDurusSureleri(durusSureleriText) {        //d kodlarÄ±nÄ± burada tutuyorum
            if (!durusSureleriText || durusSureleriText === "0") return {};
            const durusMap = {};
            const pattern = /(\d+)\s*\*\s*([dD]\d+)/g;

            let match;
            while ((match = pattern.exec(durusSureleriText)) !== null) {
                const dakika = parseInt(match[1]);
                const durusKodu = match[2].toUpperCase(); // D4 veya d4 â†’ D4
                durusMap[durusKodu] = (durusMap[durusKodu] || 0) + dakika;
            }
            return durusMap;
        }
        function parseHataKodlari(hataKodlariText) {        // hata kodlarÄ±nÄ± burada tutuyorum 
            if (!hataKodlariText || hataKodlariText === "0") return {};
            const hataMap = {};
            const pattern = /(\d+)\s*\*\s*([hH]\d+)/g;

            let match;
            while ((match = pattern.exec(hataKodlariText)) !== null) {
                const adet = parseInt(match[1]);
                const hataKodu = match[2].toUpperCase(); // H5 veya h5 â†’ H5
                hataMap[hataKodu] = (hataMap[hataKodu] || 0) + adet;
            }
            return hataMap;
        }
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        //KPI Tablosunu oluÅŸturoyurm.////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////

        const kpiDefinitions = [
        {id:'net_kapasite_kullanim',nameEn:'Effective Capacity Utilization Rate (SMD)',nameTr:'Net Kapasite KullanÄ±m OranÄ± (SMD)',target:'65% Min.',unit:'%',calculateFunction:'getSmdDataForKpi',targetValue:65,dataKey:'netCalismaYuzdesi'},
        {id:'calisma_performansi',nameEn:'Work Performance Rate (SMD)',nameTr:'Ã‡alÄ±ÅŸma PerformansÄ± OranÄ± (SMD)',target:'75% Min.',unit:'%',calculateFunction:'getSmdDataForKpi',targetValue:75,dataKey:'calismaPerformansiYuzdesi'},
        {id:'setup_kaynakli_kayip',nameEn:'Set-up Related Lost Capacity Rate (SMD)',nameTr:'Set-up KaynaklÄ± KayÄ±p Kapasite OranÄ± (SMD)',target:'9% Max.',unit:'%',calculateFunction:'getSmdDataForKpi',targetValue:9,dataKey:'setupOraniYuzdesi',isReverse:true},
        {id:'ariza_kaynakli_kayip',nameEn:'Failure-related Lost Capacity Rate (SMD)',nameTr:'ArÄ±za KaynaklÄ± KayÄ±p Kapasite OranÄ± (SMD)',target:'0.5% Max.',unit:'%',calculateFunction:'getSmdDataForKpi',targetValue:0.5,dataKey:'arizaOraniYuzdesi',isReverse:true},
        {id:'smd_istasyon_kalite',nameEn:'Station-based Quality Rate (SMD)',nameTr:'Ä°stasyon BazlÄ± Kalite OranÄ± (SMD)',target:'95% Min.',unit:'%',calculateFunction:'getSmdDataForKpi',targetValue:95,dataKey:'istasyonKaliteOraniYuzdesi'},
        {id:'lens_aa_net_kapasite',nameEn:'Effective Capacity Utilization Rate (Lens AA 2)',nameTr:'Net Kapasite KullanÄ±m OranÄ± (LENS AA 2)',target:'65% Min.',unit:'%',calculateFunction:'getLensAADataForKpi',targetValue:65,dataKey:'netCalismaYuzdesi'},
        {id:'lens_aa_calisma_performansi',nameEn:'Work Performance Rate (Lens AA 2)',nameTr:'Ã‡alÄ±ÅŸma PerformansÄ± OranÄ± (LENS AA 2)',target:'65% Min.',unit:'%',calculateFunction:'getLensAADataForKpi',targetValue:65,dataKey:'calismaPerformansiYuzdesi'},
        {id:'lens_aa_ariza_kaynakli',nameEn:'Failure-related Lost Capacity Rate (Lens AA 2)',nameTr:'ArÄ±za KaynaklÄ± KayÄ±p Kapasite OranÄ± (LENS AA 2)',target:'10% Max.',unit:'%',calculateFunction:'getLensAADataForKpi',targetValue:10,dataKey:'arizaKaynakliDurusOraniYuzdesi',isReverse:true},
        {id:'lens_aa_istasyon_kalite',nameEn:'Station-based Quality Rate (Lens AA2)',nameTr:'Ä°stasyon BazlÄ± Kalite OranÄ± (LENS AA 2)',target:'80% Min.',unit:'%',calculateFunction:'getLensAADataForKpi',targetValue:80,dataKey:'istasyonKaliteOraniYuzdesi'},
        {id:'eol_net_kapasite',nameEn:'Effective Capacity Utilization Rate (EOL 2)',nameTr:'Net Kapasite KullanÄ±m OranÄ± (EOL 2)',target:'75% Min',unit:'%',calculateFunction:'getEOLDataForKpi',targetValue:75,dataKey:'netCalismaOraniYuzdesi'},
        {id:'eol_calisma_performansi',nameEn:'Work Performance Rate (EOL 2)',nameTr:'Ã‡alÄ±ÅŸma PerformansÄ± OranÄ± (EOL 2)',target:'65% Min',unit:'%',calculateFunction:'getEOLDataForKpi',targetValue:65,dataKey:'calismaPerformansOraniYuzdesi'},
        {id:'eol_setup_kaynakli_kayip',nameEn:'Set-up Related Lost Capacity Rate (EOL 2)',nameTr:'Set-up KaynaklÄ± KayÄ±p Kapasite OranÄ± (EOL 2)',target:'5% Max.',unit:'%',calculateFunction:'getEOLDataForKpi',targetValue:5,dataKey:'setupKaynakliKayipOraniYuzdesi',isReverse:true},
        {id:'eol_ariza_kaynakli_kayip',nameEn:'Failure-related Lost Capacity Rate (EOL 2)',nameTr:'ArÄ±za KaynaklÄ± KayÄ±p Kapasite OranÄ± (EOL 2)',target:'6% Max.',unit:'%',calculateFunction:'getEOLDataForKpi',targetValue:6,dataKey:'arizaKaynakliKayipOraniYuzdesi',isReverse:true},
        {id:'eol_istasyon_kalite',nameEn:'Station-based Quality Rate (EOL2)',nameTr:'Ä°stasyon BazlÄ± Kalite OranÄ± (EOL 2)',target:'75% Min.',unit:'%',calculateFunction:'getEOLDataForKpi',targetValue:75,dataKey:'istasyonKaliteOraniYuzdesi'},
        {id:'sizdirmazlik_istasyon_kalite',nameEn:'Station-based Quality Rate (Sealing)',nameTr:'Ä°stasyon BazlÄ± Kalite OranÄ± (SIZDIRMAZLIK)',target:'80% Min.',unit:'%',calculateFunction:'getSizdirmazlikDataForKpi',targetValue:80,dataKey:'kaliteOraniYuzdesi'},
        {id: 'personel_plansiz_durus',nameEn: 'Unplanned Downtime Rate - Staff',nameTr: 'PlansÄ±z DuruÅŸ OranÄ± - Personel',target: '3% Max.',unit: '%',calculateFunction: 'getPersonelDurusDataForKpi',targetValue: 3,dataKey: 'personelDurusYuzdesi',isReverse: true},
        {id: 'makine_ekipman_plansiz_durus',nameEn: 'Unplanned Downtime Rate - Machine',nameTr: 'PlansÄ±z DuruÅŸ OranÄ± - Makine - Ekipman',target: '2% Max.',unit: '%',calculateFunction: 'getMakineEkipmanDurusDataForKpi',targetValue: 2,dataKey: 'makineEkipmanDurusYuzdesi',isReverse: true},
        {id: 'genel_oee',nameEn: 'Overall Equipment Effectiveness (OEE)',nameTr: 'Genel Ekipman EtkinliÄŸi (OEE)',target: '45% Min.',unit: '%',calculateFunction: 'getGenelOEEDataForKpi',targetValue: 45,dataKey: 'genelOEEYuzdesi',isReverse: false}
        ];
        
        function calculateGenelOEEAnalysisForYear(secilenYil) {
            console.log(`calculateGenelOEEAnalysisForYear Ã§aÄŸrÄ±ldÄ±: ${secilenYil}`);
            
            // âœ… YIL FÄ°LTRESÄ°NÄ° ZORLA 2025 YAP
            if (!secilenYil || secilenYil === '2024') {
                secilenYil = '2025';
                console.log(`YÄ±l 2025'e Ã§evrildi: ${secilenYil}`);
            }
            
            // âœ… Ã–nce Ek Analiz tablosunu oluÅŸtur
            console.log('Ek Analiz tablosu oluÅŸturuluyor...');
            
            // Ek Analiz yÄ±l filtresini ayarla
            const ekAnalizYilFiltresi = document.getElementById('ekAnalizYilFiltresi');
            if (ekAnalizYilFiltresi) {
                ekAnalizYilFiltresi.value = secilenYil;
                console.log(`Ek Analiz yÄ±l filtresi ${secilenYil}'e ayarlandÄ±`);
            }
            
            // Ek Analiz tablosunu oluÅŸtur
            createEkAnalizTablosu();
            
            // KÄ±sa bir bekleme sÃ¼resi ekle (tablo oluÅŸturulmasÄ± iÃ§in)
            setTimeout(() => {
                console.log('Ek Analiz tablosundan veri okunuyor...');
                
                // Åimdi tablodaki Genel OEE deÄŸerlerini oku
                const ekAnalizTableBody = document.getElementById('ekAnalizBody');
                const aylikKpiData = {};
                
                // BoÅŸ veri ile baÅŸlat
                for (let ay = 1; ay <= 12; ay++) {
                    aylikKpiData[ay] = {
                        genelOEEYuzdesi: '-'
                    };
                }
                
                if (!ekAnalizTableBody) {
                    console.error('Ek Analiz tablo gÃ¶vdesi bulunamadÄ±!');
                    return aylikKpiData;
                }
                
                // Tablodan aylÄ±k verileri oku
                const tableRows = ekAnalizTableBody.querySelectorAll('tr');
                console.log(`Ek Analiz tablosunda ${tableRows.length} satÄ±r bulundu`);
                
                tableRows.forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length < 7) {
                        console.log(`SatÄ±r ${index}: Yetersiz sÃ¼tun (${cells.length})`);
                        return;
                    }
                    
                    // Ä°lk sÃ¼tun ay bilgisi
                    const ayText = cells[0].textContent.trim();6
                    const ayIndex = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                                    'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'].indexOf(ayText);
                    
                    if (ayIndex >= 0) {
                        const ay = ayIndex + 1;
                        console.log(`${ay}. ay (${ayText}) iÅŸleniyor...`);
                        
                        // Genel OEE - 7. sÃ¼tun (index 6) - Son sÃ¼tun
                        const genelOEECell = cells[6];
                        if (genelOEECell) {
                            const genelOEEText = genelOEECell.textContent.trim();
                            console.log(`${ay}. ay Genel OEE hÃ¼cre iÃ§eriÄŸi: "${genelOEEText}"`);
                            
                            if (genelOEEText.includes('%')) {
                                const genelOEEMatch = genelOEEText.match(/(\d+\.?\d*)%/);
                                if (genelOEEMatch) {
                                    aylikKpiData[ay].genelOEEYuzdesi = genelOEEMatch[1];
                                    console.log(`âœ… Genel OEE ${ay}. ay: ${genelOEEMatch[1]}%`);
                                } else {
                                    console.log(`âŒ ${ay}. ay: YÃ¼zde deÄŸeri bulunamadÄ±`);
                                }
                            } else {
                                console.log(`âŒ ${ay}. ay: % iÅŸareti bulunamadÄ±`);
                            }
                        } else {
                            console.log(`âŒ ${ay}. ay: Genel OEE hÃ¼cresi bulunamadÄ±`);
                        }
                    } else {
                        console.log(`Bilinmeyen ay: "${ayText}"`);
                    }
                });
                
                console.log(`âœ… Genel OEE ${secilenYil} yÄ±lÄ± KPI verileri:`, aylikKpiData);
                return aylikKpiData;
                
            }, 100); // 100ms bekle
            
            // GeÃ§ici olarak boÅŸ veri dÃ¶ndÃ¼r
            const tempData = {};
            for (let ay = 1; ay <= 12; ay++) {
                tempData[ay] = { genelOEEYuzdesi: '-' };
            }
            return tempData;
        }
        function getGenelOEEDataForKpi() {
            if (!allSuccessRows.length) {
                console.log('Genel OEE KPI: allSuccessRows boÅŸ');
                return {};
            }
            
            const secilenYillar = getAllYears(); // TÃ¼m yÄ±llarÄ± al
            const yilData = {};
            
            // 2025 yÄ±lÄ±nÄ± Ã¶ncelikle iÅŸle
            const yil = '2025';
            console.log(`Genel OEE KPI iÃ§in ${yil} yÄ±lÄ± iÅŸleniyor...`);
            
            // Ã–nce Ek Analiz tablosunu oluÅŸtur
            createEkAnalizTablosu();
            
            // Sonra veriyi al
            setTimeout(() => {
                const genelOEEData = calculateGenelOEEAnalysisForYear(yil);
                yilData[yil] = genelOEEData;
                
                console.log('Genel OEE KPI toplam veri:', yilData);
                
                // KPI tablosunu yeniden oluÅŸtur
                createKpiTable();
            }, 200);
            
            // GeÃ§ici boÅŸ veri dÃ¶ndÃ¼r
            const tempYilData = {};
            secilenYillar.forEach(yil => {
                tempYilData[yil] = {};
                for (let ay = 1; ay <= 12; ay++) {
                    tempYilData[yil][ay] = { genelOEEYuzdesi: '-' };
                }
            });
            
            return tempYilData;
        }
        function getMakineEkipmanDurusDataForKpi() {
            if (!allSuccessRows.length) {
                console.log('Makine Ekipman DuruÅŸ KPI: allSuccessRows boÅŸ');
                return {};
            }
            
            const secilenYillar = getAllYears(); // TÃ¼m yÄ±llarÄ± al
            const yilData = {};
            
            secilenYillar.forEach(yil => {
                console.log(`Makine Ekipman DuruÅŸ KPI iÃ§in ${yil} yÄ±lÄ± iÅŸleniyor...`);
                const makineEkipmanDurusData = calculateMakineEkipmanDurusAnalysisForYear(yil);
                yilData[yil] = makineEkipmanDurusData;
            });
            
            console.log('Makine Ekipman DuruÅŸ KPI toplam veri:', yilData);
            return yilData;
        }
        function calculateMakineEkipmanDurusAnalysisForYear(secilenYil) {
            console.log(`calculateMakineEkipmanDurusAnalysisForYear Ã§aÄŸrÄ±ldÄ±: ${secilenYil}`);
            
            // âœ… YIL FÄ°LTRESÄ°NÄ° ZORLA 2025 YAP
            if (!secilenYil || secilenYil === '2024') {
                secilenYil = '2025';
                console.log(`Makine Ekipman DuruÅŸ yÄ±lÄ± 2025'e Ã§evrildi: ${secilenYil}`);
            }
            
            const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                        'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            
            
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            const baslamaSaatIndex = findColIndex(currentHeader, ['baslama', 'saat']);
            const bitisSaatIndex = findColIndex(currentHeader, ['bitis', 'saat']);
            const durusSureleriIndex = findColIndex(currentHeader, ['durus', 'sureleri']);
            
            if (dateColIndex < 0 || baslamaSaatIndex < 0 || bitisSaatIndex < 0 || durusSureleriIndex < 0) {
                console.error('Makine Ekipman duruÅŸ analizi iÃ§in gerekli sÃ¼tunlar bulunamadÄ±!');
                return {};
            }
            
            // YÄ±l filtresine gÃ¶re verileri filtrele
            const filteredData = allSuccessRows.filter(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                return dateParts.length === 3 && dateParts[2] === String(secilenYil);
            });
            
            // AylÄ±k verileri topla (OEE Analizi sayfasÄ±ndakiyle aynÄ± mantÄ±k)
            const aylikMakineEkipmanDurusData = {};
            
            for (let i = 1; i <= 12; i++) {
                aylikMakineEkipmanDurusData[i] = {
                    toplamCalisma: 0,
                    makineEkipmanDurus: 0,
                    makineEkipmanDurusYuzdesi: '-'
                };
            }
            
            filteredData.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length !== 3) return;
                    
                const ay = parseInt(dateParts[1]);
                if (ay < 1 || ay > 12) return;
                
                const startTime = row[baslamaSaatIndex] || '';
                const endTime = row[bitisSaatIndex] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                
                const durusSureleriText = row[durusSureleriIndex] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                
                // Makine+Ekipman kaynaklÄ± duruÅŸlar (D17: Makina ArÄ±zasÄ± + D9,D11: Makine/Program DuruÅŸlarÄ±)
                const makinaArizasi = durusMap['D17'] || 0;
                const makineProgramDurus = (durusMap['D9'] || 0) + (durusMap['D11'] || 0);
                const makineEkipmanKaynakliDuruslar = makinaArizasi + makineProgramDurus;
                
                aylikMakineEkipmanDurusData[ay].toplamCalisma += workingTime.totalMinutes;
                aylikMakineEkipmanDurusData[ay].makineEkipmanDurus += makineEkipmanKaynakliDuruslar;
            });
            
            // Makine Ekipman duruÅŸ yÃ¼zdelerini hesapla (OEE Analizi sayfasÄ±ndakiyle aynÄ± formÃ¼l)
            for (let ay = 1; ay <= 12; ay++) {
                const data = aylikMakineEkipmanDurusData[ay];
                
                if (data.toplamCalisma > 0) {
                    const makineEkipmanYuzde = ((data.makineEkipmanDurus / data.toplamCalisma) * 100).toFixed(1);
                    data.makineEkipmanDurusYuzdesi = makineEkipmanYuzde;
                    
                    console.log(`Makine Ekipman DuruÅŸ ${ay}. ay: ${data.makineEkipmanDurus} dk / ${data.toplamCalisma} dk = ${makineEkipmanYuzde}%`);
                } else {
                    data.makineEkipmanDurusYuzdesi = '0.0';
                }
            }
            
            console.log(`Makine Ekipman DuruÅŸ ${secilenYil} yÄ±lÄ± KPI verileri:`, aylikMakineEkipmanDurusData);
            return aylikMakineEkipmanDurusData;
        }
        function getPersonelDurusDataForKpi() {
            if (!allSuccessRows.length) {
                console.log('Personel DuruÅŸ KPI: allSuccessRows boÅŸ');
                return {};
            }
            const secilenYillar = getAllYears();
            const yilData = {};
            secilenYillar.forEach(yil => {
                console.log(`Personel DuruÅŸ KPI iÃ§in ${yil} yÄ±lÄ± iÅŸleniyor...`);
                const personelDurusData = calculatePersonelDurusAnalysisForYear(yil);
                yilData[yil] = personelDurusData;
            });
            console.log('Personel DuruÅŸ KPI toplam veri:', yilData);
            return yilData;
        }
        function calculatePersonelDurusAnalysisForYear(secilenYil) {
            console.log(`calculatePersonelDurusAnalysisForYear Ã§aÄŸrÄ±ldÄ±: ${secilenYil}`);
            
            // âœ… YIL FÄ°LTRESÄ°NÄ° ZORLA 2025 YAP
            if (!secilenYil || secilenYil === '2024') {
                secilenYil = '2025';
                console.log(`Personel DuruÅŸ yÄ±lÄ± 2025'e Ã§evrildi: ${secilenYil}`);
            }
            
            const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                        'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            const baslamaSaatIndex = findColIndex(currentHeader, ['baslama', 'saat']);
            const bitisSaatIndex = findColIndex(currentHeader, ['bitis', 'saat']);
            const durusSureleriIndex = findColIndex(currentHeader, ['durus', 'sureleri']);
            
            if (dateColIndex < 0 || baslamaSaatIndex < 0 || bitisSaatIndex < 0 || durusSureleriIndex < 0) {
                console.error('Personel duruÅŸ analizi iÃ§in gerekli sÃ¼tunlar bulunamadÄ±!');
                return {};
            }
            const filteredData = allSuccessRows.filter(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                return dateParts.length === 3 && dateParts[2] === String(secilenYil);
            });
            const aylikPersonelDurusData = {};
            
            for (let i = 1; i <= 12; i++) {
                aylikPersonelDurusData[i] = {
                    toplamCalisma: 0,
                    personelDurus: 0,
                    personelDurusYuzdesi: '-'
                };
            }
            
            filteredData.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length !== 3) return;
                    
                const ay = parseInt(dateParts[1]);
                if (ay < 1 || ay > 12) return;
                
                const startTime = row[baslamaSaatIndex] || '';
                const endTime = row[bitisSaatIndex] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                const durusSureleriText = row[durusSureleriIndex] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                const personelKaynakliDuruslar = durusMap['D19'] || 0;
                
                aylikPersonelDurusData[ay].toplamCalisma += workingTime.totalMinutes;
                aylikPersonelDurusData[ay].personelDurus += personelKaynakliDuruslar;
            });
            for (let ay = 1; ay <= 12; ay++) {
                const data = aylikPersonelDurusData[ay];
                if (data.toplamCalisma > 0) {
                    const personelYuzde = ((data.personelDurus / data.toplamCalisma) * 100).toFixed(1);
                    data.personelDurusYuzdesi = personelYuzde;
                    console.log(`Personel DuruÅŸ ${ay}. ay: ${data.personelDurus} dk / ${data.toplamCalisma} dk = ${personelYuzde}%`);
                } else {
                    data.personelDurusYuzdesi = '0.0';
                }
            }
            console.log(`Personel DuruÅŸ ${secilenYil} yÄ±lÄ± KPI verileri:`, aylikPersonelDurusData);
            return aylikPersonelDurusData;
        }
        function getEOLDataForKpi() {
            if (!allSuccessRows.length) {
                console.log('EOL KPI: allSuccessRows boÅŸ');
                return {};
            }
            createEolAnalysisTable();
            
            const secilenYillar = getAllYears();
            const yilData = {};
            
            secilenYillar.forEach(yil => {
                console.log(`EOL KPI iÃ§in ${yil} yÄ±lÄ± iÅŸleniyor...`);
                
                const eolYilElement = document.getElementById('eolYilFiltresi');
                if (eolYilElement) {
                    eolYilElement.value = yil;
                }
                createEolAnalysisTable();
                
                const eolData = calculateEOLAnalysisForYear(yil);
                yilData[yil] = eolData;
            });
            
            console.log('EOL KPI toplam veri:', yilData);
            return yilData;
        }
        function calculateEOLAnalysisForYear(secilenYil) {
            console.log(`calculateEOLAnalysisForYear Ã§aÄŸrÄ±ldÄ±: ${secilenYil}`);
            
            const eolTableBody = document.getElementById('eolAnalyzBody');
            if (!eolTableBody) {
                console.error('EOL tablosu bulunamadÄ±!');
                return {};
            }
            
            const aylikKpiData = {};
            
            // BoÅŸ veri ile baÅŸlat
            for (let ay = 1; ay <= 12; ay++) {
                aylikKpiData[ay] = {
                    netCalismaOraniYuzdesi: '-',
                    calismaPerformansOraniYuzdesi: '-',
                    setupKaynakliKayipOraniYuzdesi: '-',
                    arizaKaynakliKayipOraniYuzdesi: '-',
                    istasyonKaliteOraniYuzdesi: '-'
                };
            }
            
            // Tablodan verileri oku
            const tableRows = eolTableBody.querySelectorAll('tr');
            console.log(`EOL tablosunda ${tableRows.length} satÄ±r bulundu`);
            
            tableRows.forEach((row, index) => {
                const cells = row.cells;
                if (cells.length < 22) {
                    console.log(`SatÄ±r ${index}: Yetersiz sÃ¼tun (${cells.length})`);
                    return;
                }
                
                // Ä°lk hÃ¼cre ay bilgisi
                const ayText = cells[0].textContent.trim();
                const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                            'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
                const ayIndex = aylar.indexOf(ayText);
                
                if (ayIndex >= 0) {
                    const ay = ayIndex + 1;
                    console.log(`EOL ${ay}. ay iÅŸleniyor: ${ayText}`);
                    
                    const netCalismaCell = cells[15];
                    if (netCalismaCell && netCalismaCell.textContent.includes('%')) {
                        const netCalismaText = netCalismaCell.textContent.trim();
                        const netCalismaMatch = netCalismaText.match(/(\d+\.?\d*)%/);
                        if (netCalismaMatch) {
                            aylikKpiData[ay].netCalismaOraniYuzdesi = netCalismaMatch[1];
                            console.log(`Net Ã‡alÄ±ÅŸma ${ay}. ay: ${netCalismaMatch[1]}%`);
                        }
                    }
                    
                    const setupKayipCell = cells[18];
                    if (setupKayipCell && setupKayipCell.textContent.includes('%')) {
                        const setupKayipText = setupKayipCell.textContent.trim();
                        const setupKayipMatch = setupKayipText.match(/(\d+\.?\d*)%/);
                        if (setupKayipMatch) {
                            aylikKpiData[ay].setupKaynakliKayipOraniYuzdesi = setupKayipMatch[1];
                            console.log(`Setup KayÄ±p ${ay}. ay: ${setupKayipMatch[1]}%`);
                        }
                    }
                    
                    const calismaPerformansCell = cells[19];
                    if (calismaPerformansCell && calismaPerformansCell.textContent.includes('%')) {
                        const calismaPerformansText = calismaPerformansCell.textContent.trim();
                        const calismaPerformansMatch = calismaPerformansText.match(/(\d+\.?\d*)%/);
                        if (calismaPerformansMatch) {
                            aylikKpiData[ay].calismaPerformansOraniYuzdesi = calismaPerformansMatch[1];
                            console.log(`Ã‡alÄ±ÅŸma Performans ${ay}. ay: ${calismaPerformansMatch[1]}%`);
                        }
                    }
                    
                    const arizaKaynakliCell = cells[20];
                    if (arizaKaynakliCell && arizaKaynakliCell.textContent.includes('%')) {
                        const arizaKaynakliText = arizaKaynakliCell.textContent.trim();
                        const arizaKaynakliMatch = arizaKaynakliText.match(/(\d+\.?\d*)%/);
                        if (arizaKaynakliMatch) {
                            aylikKpiData[ay].arizaKaynakliKayipOraniYuzdesi = arizaKaynakliMatch[1];
                            console.log(`ArÄ±za KaynaklÄ± ${ay}. ay: ${arizaKaynakliMatch[1]}%`);
                        }
                    }
                    
                    const istasyonKaliteCell = cells[21];
                    if (istasyonKaliteCell && istasyonKaliteCell.textContent.includes('%')) {
                        const istasyonKaliteText = istasyonKaliteCell.textContent.trim();
                        const istasyonKaliteMatch = istasyonKaliteText.match(/(\d+\.?\d*)%/);
                        if (istasyonKaliteMatch) {
                            aylikKpiData[ay].istasyonKaliteOraniYuzdesi = istasyonKaliteMatch[1];
                            console.log(`Ä°stasyon Kalite ${ay}. ay: ${istasyonKaliteMatch[1]}%`);
                        }
                    }
                    
                    console.log(`EOL ${ay}. ay tamamlandÄ±:`, aylikKpiData[ay]);
                }
            });
            
            console.log(`EOL ${secilenYil} yÄ±lÄ± KPI verileri:`, aylikKpiData);
            return aylikKpiData;
        }
        function getSizdirmazlikDataForKpi() {
            if (!allSuccessRows.length) {
                console.log('SIZDIRMAZLIK KPI: allSuccessRows boÅŸ');
                return {};
            }
            
            const secilenYillar = getAllYears(); // TÃ¼m yÄ±llarÄ± al
            const yilData = {};
            
            secilenYillar.forEach(yil => {
                console.log(`SIZDIRMAZLIK KPI iÃ§in ${yil} yÄ±lÄ± iÅŸleniyor...`);
                const sizdirmazlikData = calculateSizdirmazlikAnalysisForYear(yil);
                yilData[yil] = sizdirmazlikData;
            });
            
            console.log('SIZDIRMAZLIK KPI toplam veri:', yilData);
            return yilData;
        }
        function calculateSizdirmazlikAnalysisForYear(secilenYil) {
            // Ã–nce SIZDIRMAZLIK tablosunu oluÅŸtur (eÄŸer yoksa)
            createSizdirmazlikAnalysisTable();
            
            // Åimdi tablodaki deÄŸerleri oku
            const sizdirmazlikTableBody = document.getElementById('sizdirmazlikAnalyzBody');
            const aylikKpiData = {};
            
            // Tablodan aylÄ±k verileri oku
            const tableRows = sizdirmazlikTableBody ? sizdirmazlikTableBody.querySelectorAll('tr') : [];
            
            for (let ay = 1; ay <= 12; ay++) {
                aylikKpiData[ay] = {
                    kaliteOraniYuzdesi: '-'
                };
            }
            
            tableRows.forEach(row => {
                const cells = row.cells;
                if (cells.length < 8) return; // SIZDIRMAZLIK tablosu minimum 8 sÃ¼tunlu
                
                // Ä°lk sÃ¼tun ay bilgisi
                const ayText = cells[0].textContent.trim();
                const ayIndex = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                                'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'].indexOf(ayText);
                
                if (ayIndex >= 0) {
                    const ay = ayIndex + 1;
                    
                    // Kalite OranÄ± (19) - 8. sÃ¼tun (index 7) - Son sÃ¼tun
                    const kaliteOraniCell = cells[7];
                    if (kaliteOraniCell && kaliteOraniCell.textContent.includes('%')) {
                        const kaliteOraniText = kaliteOraniCell.textContent.trim();
                        const kaliteOraniMatch = kaliteOraniText.match(/(\d+\.?\d*)%/);
                        if (kaliteOraniMatch) {
                            aylikKpiData[ay].kaliteOraniYuzdesi = kaliteOraniMatch[1];
                        }
                    }
                    
                    console.log(`SIZDIRMAZLIK ${ay}. ay: Kalite=${aylikKpiData[ay].kaliteOraniYuzdesi}%`);
                }
            });
            
            return aylikKpiData;
        }
        function getLensAADataForKpi() {
            if (!allSuccessRows.length) return {};
            const secilenYillar = getAllYears(); // TÃ¼m yÄ±llarÄ± al
            const yilData = {};
            
            secilenYillar.forEach(yil => {
                const lensAAData = calculateLensAAAnalysisForYear(yil);
                yilData[yil] = lensAAData;
            });
            
            return yilData;
        }
        function calculateLensAAAnalysisForYear(secilenYil) {
            // Ã–nce LENS AA tablosunu oluÅŸtur (eÄŸer yoksa)
            createLensAnalysisTable();
            
            // Åimdi tablodaki deÄŸerleri oku
            const lensTableBody = document.getElementById('lensAnalyzBody');
            const aylikKpiData = {};
            
            // Tablodan aylÄ±k verileri oku
            const tableRows = lensTableBody ? lensTableBody.querySelectorAll('tr') : [];
            
            for (let ay = 1; ay <= 12; ay++) {
                aylikKpiData[ay] = {
                    netCalismaYuzdesi: '-',
                    calismaPerformansiYuzdesi: '-',
                    arizaKaynakliDurusOraniYuzdesi: '-',
                    istasyonKaliteOraniYuzdesi: '-'
                };
            }
            
            tableRows.forEach(row => {
                const cells = row.cells;
                if (cells.length < 22) return; // LENS AA tablosu minimum 22 sÃ¼tunlu
                
                // Ä°lk sÃ¼tun ay bilgisi
                const ayText = cells[0].textContent.trim();
                const ayIndex = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                                'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'].indexOf(ayText);
                
                if (ayIndex >= 0) {
                    const ay = ayIndex + 1;
                    
                    // Net Ã‡alÄ±ÅŸma OranÄ± - 19. sÃ¼tun (index 18)
                    const netCalismaCell = cells[18];
                    if (netCalismaCell && netCalismaCell.textContent.includes('%')) {
                        const netCalismaText = netCalismaCell.textContent.trim();
                        const netCalismaMatch = netCalismaText.match(/(\d+\.?\d*)%/);
                        if (netCalismaMatch) {
                            aylikKpiData[ay].netCalismaYuzdesi = netCalismaMatch[1];
                        }
                    }
                    
                    // ArÄ±za KaynaklÄ± DuruÅŸ OranÄ± - 20. sÃ¼tun (index 19)
                    const arizaKaynakliCell = cells[19];
                    if (arizaKaynakliCell && arizaKaynakliCell.textContent.includes('%')) {
                        const arizaKaynakliText = arizaKaynakliCell.textContent.trim();
                        const arizaKaynakliMatch = arizaKaynakliText.match(/(\d+\.?\d*)%/);
                        if (arizaKaynakliMatch) {
                            aylikKpiData[ay].arizaKaynakliDurusOraniYuzdesi = arizaKaynakliMatch[1];
                        }
                    }
                    
                    // Ä°stasyon BazlÄ± Kalite OranÄ± - 21. sÃ¼tun (index 20) âœ…
                    const istasyonKaliteCell = cells[20];
                    if (istasyonKaliteCell && istasyonKaliteCell.textContent.includes('%')) {
                        const istasyonKaliteText = istasyonKaliteCell.textContent.trim();
                        const istasyonKaliteMatch = istasyonKaliteText.match(/(\d+\.?\d*)%/);
                        if (istasyonKaliteMatch) {
                            aylikKpiData[ay].istasyonKaliteOraniYuzdesi = istasyonKaliteMatch[1];
                        }
                    }
                    
                    // Ã‡alÄ±ÅŸma Performans OranÄ± - 22. sÃ¼tun (index 21) - Son sÃ¼tun
                    const calismaPerformansCell = cells[21];
                    if (calismaPerformansCell && calismaPerformansCell.textContent.includes('%')) {
                        const calismaPerformansText = calismaPerformansCell.textContent.trim();
                        const calismaPerformansMatch = calismaPerformansText.match(/(\d+\.?\d*)%/);
                        if (calismaPerformansMatch) {
                            aylikKpiData[ay].calismaPerformansiYuzdesi = calismaPerformansMatch[1];
                        }
                    }
                    
                    console.log(`LENS AA ${ay}. ay: Net=${aylikKpiData[ay].netCalismaYuzdesi}%, ArÄ±za=${aylikKpiData[ay].arizaKaynakliDurusOraniYuzdesi}%, Kalite=${aylikKpiData[ay].istasyonKaliteOraniYuzdesi}%, Performans=${aylikKpiData[ay].calismaPerformansiYuzdesi}%`);
                }
            });
            
            return aylikKpiData;
        }
        function getSmdDataForKpi() {
            if (!allSuccessRows.length) return {};
            const secilenYillar = getAllYears(); // TÃ¼m yÄ±llarÄ± al
            const yilData = {};
            
            secilenYillar.forEach(yil => {
                const smdData = calculateSmdAnalysisForYear(yil);
                yilData[yil] = smdData;
            });
            
            return yilData;
        }
        
        function calculateSmdAnalysisForYear(secilenYil) {
            createSmdAnalysisTable();
            
            const smdTableBody = document.getElementById('smdAnalyzBody');
            const aylikKpiData = {};
            const tableRows = smdTableBody ? smdTableBody.querySelectorAll('tr') : [];
            
            for (let ay = 1; ay <= 12; ay++) {
                aylikKpiData[ay] = {
                    netCalismaYuzdesi: '-',
                    calismaPerformansiYuzdesi: '-',
                    setupOraniYuzdesi: '-',
                    arizaOraniYuzdesi: '-',
                    istasyonKaliteOraniYuzdesi: '-'
                };
            }
            
            tableRows.forEach(row => {
                const cells = row.cells;
                if (cells.length < 25) return; // SMD tablosu minimum 25 sÃ¼tunlu
                
                // Ä°lk sÃ¼tun ay bilgisi
                const ayText = cells[0].textContent.trim();
                const ayIndex = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                                'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'].indexOf(ayText);
                
                if (ayIndex >= 0) {
                    const ay = ayIndex + 1;
                    
                    // Net Ã‡alÄ±ÅŸma OranÄ± - 20. sÃ¼tun (index 19)
                    const netCalismaCell = cells[19];
                    if (netCalismaCell && netCalismaCell.textContent.includes('%')) {
                        const netCalismaText = netCalismaCell.textContent.trim();
                        const netCalismaMatch = netCalismaText.match(/(\d+\.?\d*)%/);
                        if (netCalismaMatch) {
                            aylikKpiData[ay].netCalismaYuzdesi = netCalismaMatch[1];
                        }
                    }
                    
                    // Ã‡alÄ±ÅŸma PerformansÄ± - 21. sÃ¼tun (index 20)
                    const calismaPerformansCell = cells[20];
                    if (calismaPerformansCell && calismaPerformansCell.textContent.includes('%')) {
                        const calismaPerformansText = calismaPerformansCell.textContent.trim();
                        const calismaPerformansMatch = calismaPerformansText.match(/(\d+\.?\d*)%/);
                        if (calismaPerformansMatch) {
                            aylikKpiData[ay].calismaPerformansiYuzdesi = calismaPerformansMatch[1];
                        }
                    }
                    
                    // Ä°stasyon BazlÄ± Kalite OranÄ± - 22. sÃ¼tun (index 21) âœ…
                    const istasyonKaliteCell = cells[21];
                    if (istasyonKaliteCell && istasyonKaliteCell.textContent.includes('%')) {
                        const istasyonKaliteText = istasyonKaliteCell.textContent.trim();
                        const istasyonKaliteMatch = istasyonKaliteText.match(/(\d+\.?\d*)%/);
                        if (istasyonKaliteMatch) {
                            aylikKpiData[ay].istasyonKaliteOraniYuzdesi = istasyonKaliteMatch[1];
                        }
                    }
                    
                    // Setup OranÄ± - 23. sÃ¼tun (index 22)
                    const setupOraniCell = cells[22];
                    if (setupOraniCell && setupOraniCell.textContent.includes('%')) {
                        const setupOraniText = setupOraniCell.textContent.trim();
                        const setupOraniMatch = setupOraniText.match(/(\d+\.?\d*)%/);
                        if (setupOraniMatch) {
                            aylikKpiData[ay].setupOraniYuzdesi = setupOraniMatch[1];
                        }
                    }
                    
                    // ArÄ±za DuruÅŸu - 24. sÃ¼tun (index 23)
                    const arizaOraniCell = cells[23];
                    if (arizaOraniCell && arizaOraniCell.textContent.includes('%')) {
                        const arizaOraniText = arizaOraniCell.textContent.trim();
                        const arizaOraniMatch = arizaOraniText.match(/(\d+\.?\d*)%/);
                        if (arizaOraniMatch) {
                            aylikKpiData[ay].arizaOraniYuzdesi = arizaOraniMatch[1];
                        }
                    }
                    
                    console.log(`SMD ${ay}. ay: Net=${aylikKpiData[ay].netCalismaYuzdesi}%, Performans=${aylikKpiData[ay].calismaPerformansiYuzdesi}%, Kalite=${aylikKpiData[ay].istasyonKaliteOraniYuzdesi}%, Setup=${aylikKpiData[ay].setupOraniYuzdesi}%, ArÄ±za=${aylikKpiData[ay].arizaOraniYuzdesi}%`);
                }
            });
            
            return aylikKpiData;
        }
        // createKpiTable fonksiyonunu tamamlayÄ±n (yaklaÅŸÄ±k satÄ±r 580-650 arasÄ±):

function createKpiTable() {
    if (!allSuccessRows.length) {
        console.log('KPI Tablo: Veri yok');
        return;
    }
    
    const kpiTableBody = document.querySelector('#panel-5 tbody');
    if (!kpiTableBody) {
        console.log('KPI Tablo: tbody bulunamadÄ±');
        return;
    }
    
    console.log('KPI Tablosu oluÅŸturuluyor...');
    
    let tableBodyHtml = '';
    
    kpiDefinitions.forEach((kpiDef) => {
        console.log(`KPI iÅŸleniyor: ${kpiDef.nameEn}`);
        
        let allYearData = {};
        
        try {
            if (kpiDef.calculateFunction === 'getSmdDataForKpi') {
                allYearData = getSmdDataForKpi();
            } else if (kpiDef.calculateFunction === 'getLensAADataForKpi') {
                allYearData = getLensAADataForKpi();
            } else if (kpiDef.calculateFunction === 'getEOLDataForKpi') {
                allYearData = getEOLDataForKpi();
            } else if (kpiDef.calculateFunction === 'getSizdirmazlikDataForKpi') {
                console.log('SIZDIRMAZLIK KPI hesaplanÄ±yor...');
                allYearData = getSizdirmazlikDataForKpi();
            } else if (kpiDef.calculateFunction === 'getPersonelDurusDataForKpi') {
                console.log('Personel DuruÅŸ KPI hesaplanÄ±yor...');
                allYearData = getPersonelDurusDataForKpi();
            } else if (kpiDef.calculateFunction === 'getMakineEkipmanDurusDataForKpi') {
                console.log('Makine Ekipman DuruÅŸ KPI hesaplanÄ±yor...');
                allYearData = getMakineEkipmanDurusDataForKpi();
            } else if (kpiDef.calculateFunction === 'getGenelOEEDataForKpi') {
                console.log('Genel OEE KPI hesaplanÄ±yor...');
                allYearData = getGenelOEEDataForKpi();
            }
            
            console.log(`${kpiDef.nameEn} iÃ§in yÄ±l verisi:`, allYearData);
        } catch (error) {
            console.error(`${kpiDef.nameEn} iÃ§in hata:`, error);
            allYearData = {};
        }
        
        // âœ… YIL SEÃ‡Ä°MÄ°NÄ° 2025'E SABÄ°TLE
        const yillar = Object.keys(allYearData).sort();
        let secilenYil = '2025'; // â† HER ZAMAN 2025 KULLAN
        
        console.log(`${kpiDef.nameEn} iÃ§in mevcut yÄ±llar:`, yillar);
        console.log(`${kpiDef.nameEn} iÃ§in seÃ§ilen yÄ±l: ${secilenYil}`);
        
        // EÄŸer 2025 yÄ±lÄ± verisi yoksa, veri bulunamadÄ± mesajÄ± gÃ¶ster
        if (!allYearData[secilenYil]) {
            console.log(`${kpiDef.nameEn} iÃ§in ${secilenYil} yÄ±lÄ± verisi bulunamadÄ±!`);
            tableBodyHtml += `
                <tr class="row">
                    <td class="kpi-box">
                        <div class="kpi-title">${kpiDef.nameEn}</div>
                        <div class="kpi-sub">${kpiDef.nameTr}</div>
                    </td>
                    <td class="td tgt">${kpiDef.target}</td>
                    <td class="td">${kpiDef.unit}</td>
                    <td class="td val" colspan="12" style="text-align:center;color:#666;">2025 yÄ±lÄ± verisi bulunamadÄ±</td>
                </tr>`;
            return;
        }
        
        const kpiData = allYearData[secilenYil];
        console.log(`${kpiDef.nameEn} - ${secilenYil} yÄ±lÄ± verisi:`, kpiData);
        
        // AylÄ±k deÄŸerleri oluÅŸtur
        let monthCells = '';
        const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                      'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
        
        for (let ay = 1; ay <= 12; ay++) {
            const ayData = kpiData[ay];
            let value = '-';
            let backgroundColor = '';
            
            if (ayData && ayData[kpiDef.dataKey] && ayData[kpiDef.dataKey] !== '-') {
                const numericValue = parseFloat(ayData[kpiDef.dataKey]);
                value = `${ayData[kpiDef.dataKey]}%`;
                
                // Renk kodlamasÄ±
                if (kpiDef.isReverse) {
                    // Ters mantÄ±k: dÃ¼ÅŸÃ¼k iyi (Setup, ArÄ±za, DuruÅŸ KPI'larÄ±)
                    backgroundColor = numericValue <= kpiDef.targetValue ? '#dcfce7' : '#fecaca';
                } else {
                    // Normal mantÄ±k: yÃ¼ksek iyi (diÄŸer KPI'lar)
                    backgroundColor = numericValue >= kpiDef.targetValue ? '#dcfce7' : '#fecaca';
                }
            }
            
            monthCells += `<td class="td val" style="background-color:${backgroundColor};">${value}</td>`;
        }
        
        tableBodyHtml += `
            <tr class="row">
                <td class="kpi-box">
                    <div class="kpi-title">${kpiDef.nameEn}</div>
                    <div class="kpi-sub">${kpiDef.nameTr}</div>
                </td>
                <td class="td tgt">${kpiDef.target}</td>
                <td class="td">${kpiDef.unit}</td>
                ${monthCells}
            </tr>`;
    });
    
    kpiTableBody.innerHTML = tableBodyHtml;
    console.log('KPI Tablosu oluÅŸturuldu');
}

function getAllYears() {
    const dateColIndex = currentHeader.findIndex(h => 
        norm(h).includes('tarih') || norm(h).includes('date')
    );
    if (dateColIndex < 0) return [];
            
            const yillar = new Set();
            allSuccessRows.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length === 3) {
                    yillar.add(dateParts[2]);
                }
            });
            
            return Array.from(yillar).sort();
        }
        
        window.getEOLDataForKpi = getEOLDataForKpi;
        window.calculateEOLAnalysisForYear = calculateEOLAnalysisForYear;
        window.getLensAADataForKpi = getLensAADataForKpi;
        window.calculateLensAAAnalysisForYear = calculateLensAAAnalysisForYear;
        window.getSmdDataForKpi = getSmdDataForKpi;
        window.calculateSmdAnalysisForYear = calculateSmdAnalysisForYear;
        window.getSizdirmazlikDataForKpi = getSizdirmazlikDataForKpi;
        window.calculateSizdirmazlikAnalysisForYear = calculateSizdirmazlikAnalysisForYear;
        window.getPersonelDurusDataForKpi = getPersonelDurusDataForKpi;
        window.calculatePersonelDurusAnalysisForYear = calculatePersonelDurusAnalysisForYear;
        window.getMakineEkipmanDurusDataForKpi = getMakineEkipmanDurusDataForKpi;
        window.calculateMakineEkipmanDurusAnalysisForYear = calculateMakineEkipmanDurusAnalysisForYear;
        window.getGenelOEEDataForKpi = getGenelOEEDataForKpi;
        window.calculateGenelOEEAnalysisForYear = calculateGenelOEEAnalysisForYear;
        
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        //OEE sekmesini oluÅŸturuyorum gÃ¼n 1//////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////

        function calculateGrafikStats() {
            if (!allSuccessRows.length) {
                document.getElementById('grafikOkUrun').textContent = '0';
                document.getElementById('grafikNokUrun').textContent = '0';
                document.getElementById('grafikToplam').textContent = '0';
                document.getElementById('grafikVerimlilik').textContent = '0%';
                document.getElementById('grafikToplamCalisma').textContent = '0 dk (0dk)';
                document.getElementById('grafikToplamDurus').textContent = '0 dk (0:00)';
                document.getElementById('grafikPlanliDurus').textContent = '0 dk (0:00)';
                document.getElementById('grafikPlansizDurus').textContent = '0 dk (0:00)';
                return;
            }
            let filteredRows = allSuccessRows;      // Tarih filtresi uygula
            const fromDate = grafikDateFrom.value;
            const toDate = grafikDateTo.value;
            
            if (fromDate || toDate) {
                const dateColIndex = currentHeader.findIndex(h => 
                    norm(h).includes('tarih') || norm(h).includes('date')
                );
                if (dateColIndex >= 0) {
                    filteredRows = allSuccessRows.filter(row => {
                        const cellDate = String(row[dateColIndex] || '').trim();
                        const dateParts = cellDate.split('.');
                        if (dateParts.length !== 3) return false;
                        
                        const cellDateFormatted = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                        
                        let matchesFrom = true;
                        let matchesTo = true;
                        
                        if (fromDate) matchesFrom = cellDateFormatted >= fromDate;
                        if (toDate) matchesTo = cellDateFormatted <= toDate;

                        return matchesFrom && matchesTo;
                    });
                }
            }
            const idxOK = findColIndex(currentHeader, ['ok']);
            const idxBaslamaSaat = findColIndex(currentHeader, ['baslama', 'saat']);
            const idxBitisSaat = findColIndex(currentHeader, ['bitis', 'saat']);
            const idxDurusSureleri = findColIndex(currentHeader, ['durus', 'sureleri']);
            const idxHataKodlari = findColIndex(currentHeader, ['hata', 'kod']);

            let totalOK = 0;
            let totalNOK = 0;
            let totalNetSure = 0;
            let totalToplamDurus = 0;
            let totalPlanliDurus = 0;
            let totalPlansizDurus = 0;

            filteredRows.forEach(row => {
                const okUrun = parseInt(row[idxOK]) || 0;
                totalOK += okUrun;

                const hataKodlariText = row[idxHataKodlari] || '';
                const hataMap = parseHataKodlari(hataKodlariText);
                const nokUrun = Object.values(hataMap).reduce((toplam, adet) => toplam + adet, 0);
                totalNOK += nokUrun;

                const startTime = row[idxBaslamaSaat] || '';
                const endTime = row[idxBitisSaat] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                const durusSureleriText = row[idxDurusSureleri] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                const kurulumSuresi = durusMap['D4'] || 0;
                const makinaArizasi = durusMap['D17'] || 0;
                const personelDurus = durusMap['D19'] || 0;
                const planliDurus = (durusMap['D12'] || 0) + (durusMap['D13'] || 0) + (durusMap['D18'] || 0) + (durusMap['D21'] || 0);
                const plansizDurus = (durusMap['D0'] || 0) + (durusMap['D1'] || 0) + (durusMap['D2'] || 0) + 
                                    (durusMap['D3'] || 0) + (durusMap['D5'] || 0) + (durusMap['D6'] || 0) + 
                                    (durusMap['D7'] || 0) + (durusMap['D8'] || 0) + (durusMap['D10'] || 0) + 
                                    (durusMap['D14'] || 0) + (durusMap['D15'] || 0) + (durusMap['D16'] || 0) + 
                                    (durusMap['D19'] || 0) + (durusMap['D20'] || 0) + (durusMap['D22'] || 0) + 
                                    (durusMap['D23'] || 0) + (durusMap['D24'] || 0);
                const makineProgramDurus = (durusMap['D9'] || 0) + (durusMap['D11'] || 0);
                
                const toplamDurus = kurulumSuresi + makinaArizasi + planliDurus + plansizDurus + makineProgramDurus;
                const Planlananduruslar = kurulumSuresi + planliDurus;
                const netSure = workingTime.totalMinutes - toplamDurus; // DuruÅŸlar tablosundaki Net SÃ¼re

                totalNetSure += netSure;
                totalToplamDurus += toplamDurus;
                totalPlanliDurus += Planlananduruslar;
                totalPlansizDurus += (plansizDurus + makinaArizasi + makineProgramDurus);
            });
            const toplam = totalOK + totalNOK;
            const verimlilik = toplam > 0 ? ((totalOK / toplam) * 100).toFixed(1) : 0;

            document.getElementById('grafikOkUrun').textContent = totalOK.toLocaleString();
            document.getElementById('grafikNokUrun').textContent = totalNOK.toLocaleString();
            document.getElementById('grafikToplam').textContent = toplam.toLocaleString();
            document.getElementById('grafikVerimlilik').textContent = verimlilik + '%';

            const formatDurusTime = (dakika) => {
                const gun = Math.floor(dakika / (24 * 60));
                const saat = Math.floor((dakika % (24 * 60)) / 60);
                const kalanDakika = dakika % 60;
                let result = `${dakika} dk (`;
                if (gun > 0) {
                    result += `${gun}g `;
                }
                if (saat > 0 || gun > 0) {
                    result += `${saat}s `;
                }
                result += `${kalanDakika}dk)`;
                
                return result;
            };
            document.getElementById('grafikToplamCalisma').textContent = formatDurusTime(totalNetSure);
            document.getElementById('grafikToplamDurus').textContent = formatDurusTime(totalToplamDurus);
            document.getElementById('grafikPlanliDurus').textContent = formatDurusTime(totalPlanliDurus);
            document.getElementById('grafikPlansizDurus').textContent = formatDurusTime(totalPlansizDurus);
        }
        function clearGrafikDateFilter() {
            grafikDateFrom.value = '';
            grafikDateTo.value = '';
            calculateGrafikStats();
        }
        function populateYilFiltresi() {
            if (!allSuccessRows.length) return;
            
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            if (dateColIndex < 0) return;

            const yillar = new Set();
            allSuccessRows.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length === 3) {
                    yillar.add(dateParts[2]);
                }
            });
            const yilArray = Array.from(yillar).sort();
            yilFiltresi.innerHTML = '<option value="">TÃ¼m YÄ±llar</option>';
            
            yilArray.forEach(yil => {
                const isSelected = yil === '2025' ? ' selected' : '';
                yilFiltresi.innerHTML += `<option value="${yil}"${isSelected}>${yil}</option>`;
            });
            if (!yilArray.includes('2025')) {
                const currentYear = new Date().getFullYear().toString();
                if (yilArray.includes(currentYear)) {
                    yilFiltresi.value = currentYear;
                }
            } else {
                yilFiltresi.value = '2025';
                setTimeout(() => {
                    createAylikAnaliz();
                }, 100);
            }
        }
        // createAylikAnaliz fonksiyonunu gÃ¼ncelleyin - sonuna toplam satÄ±rÄ± ekleyin:

        function createAylikAnaliz() {
            if (!allSuccessRows.length) {
                document.getElementById('aylikAnalizBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">Veri yÃ¼klenmedi</td></tr>';
                return;
            }
            const secilenYil = yilFiltresi.value;
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            
            if (dateColIndex < 0) return;

            let filteredRows = allSuccessRows;
            if (secilenYil) {
                filteredRows = allSuccessRows.filter(row => {
                    const cellDate = String(row[dateColIndex] || '').trim();
                    const dateParts = cellDate.split('.');
                    return dateParts.length === 3 && dateParts[2] === secilenYil;
                });
            }
            const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                        'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            
            const idxBaslamaSaat = findColIndex(currentHeader, ['baslama', 'saat']);
            const idxBitisSaat = findColIndex(currentHeader, ['bitis', 'saat']);
            const idxDurusSureleri = findColIndex(currentHeader, ['durus', 'sureleri']);

            const aylikData = {};       // AylÄ±k veriler           
            for (let i = 1; i <= 12; i++) {     // Her ayÄ± baÅŸlat
                aylikData[i] = {
                    toplamCalisma: 0,
                    planlananDurus: 0,
                    personelDurus: 0,
                    makineEkipmanDurus: 0
                };
            }
            filteredRows.forEach(row => {       // Verileri iÅŸle
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length !== 3) return;
                
                const ay = parseInt(dateParts[1]);
                if (ay < 1 || ay > 12) return;
                
                const startTime = row[idxBaslamaSaat] || '';
                const endTime = row[idxBitisSaat] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                
                const durusSureleriText = row[idxDurusSureleri] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                
                const kurulumSuresi = durusMap['D4'] || 0;
                const planliDurus = (durusMap['D12'] || 0) + (durusMap['D13'] || 0) + (durusMap['D18'] || 0) + (durusMap['D21'] || 0);
                const planlananDuruslar = kurulumSuresi + planliDurus;
                
                const personelKaynakliDuruslar = durusMap['D19'] || 0;
                
                const makinaArizasi = durusMap['D17'] || 0;
                const makineProgramDurus = (durusMap['D9'] || 0) + (durusMap['D11'] || 0);
                const makineEkipmanDuruslar = makinaArizasi + makineProgramDurus;
                
                aylikData[ay].toplamCalisma += workingTime.totalMinutes;
                aylikData[ay].planlananDurus += planlananDuruslar;
                aylikData[ay].personelDurus += personelKaynakliDuruslar;
                aylikData[ay].makineEkipmanDurus += makineEkipmanDuruslar;
            });
            
            let tbody = '';
            let toplamCalismaGenel = 0;
            let toplamPlanlananGenel = 0;
            let toplamPersonelGenel = 0;
            let toplamMakineEkipmanGenel = 0;
            let planlananYuzdeToplam = 0;
            let personelYuzdeToplam = 0;
            let makineYuzdeToplam = 0;
            let aktifAySayisi = 0;
            
            for (let i = 1; i <= 12; i++) {
                const data = aylikData[i];
                
                // EÄŸer ay iÃ§in veri varsa hesaplamalara dahil et
                if (data.toplamCalisma > 0) {
                    aktifAySayisi++;
                    toplamCalismaGenel += data.toplamCalisma;
                    toplamPlanlananGenel += data.planlananDurus;
                    toplamPersonelGenel += data.personelDurus;
                    toplamMakineEkipmanGenel += data.makineEkipmanDurus;
                }
                
                const planlananYuzde = data.toplamCalisma > 0 ? ((data.planlananDurus / data.toplamCalisma) * 100).toFixed(1) : '0.0';
                const personelYuzde = data.toplamCalisma > 0 ? ((data.personelDurus / data.toplamCalisma) * 100).toFixed(1) : '0.0';
                const makineYuzde = data.toplamCalisma > 0 ? ((data.makineEkipmanDurus / data.toplamCalisma) * 100).toFixed(1) : '0.0';
                
                // YÃ¼zde deÄŸerleri toplamÄ± (ortalama hesabÄ± iÃ§in)
                if (data.toplamCalisma > 0) {
                    planlananYuzdeToplam += parseFloat(planlananYuzde);
                    personelYuzdeToplam += parseFloat(personelYuzde);
                    makineYuzdeToplam += parseFloat(makineYuzde);
                }
                
                tbody += `
                <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;font-weight:500;">${aylar[i-1]}</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;">${formatAylikSure(data.toplamCalisma)}</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;">${formatAylikSure(data.planlananDurus)}</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;color:#f59e0b;font-weight:500;">${planlananYuzde}%</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;">${formatAylikSure(data.personelDurus)}</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;color:#dc2626;font-weight:500;">${personelYuzde}%</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;">${formatAylikSure(data.makineEkipmanDurus)}</td>
                    <td style="padding:10px 12px;border:1px solid #e5e7eb;text-align:center;color:#dc2626;font-weight:500;">${makineYuzde}%</td>
                </tr>`;
            }
            
            // Ortalama yÃ¼zde deÄŸerlerini hesapla
            const ortalamaPlanliYuzde = aktifAySayisi > 0 ? (planlananYuzdeToplam / aktifAySayisi).toFixed(1) : '0.0';
            const ortalamaPersonelYuzde = aktifAySayisi > 0 ? (personelYuzdeToplam / aktifAySayisi).toFixed(1) : '0.0';
            const ortalamaMakineYuzde = aktifAySayisi > 0 ? (makineYuzdeToplam / aktifAySayisi).toFixed(1) : '0.0';
            
            // Toplam satÄ±rÄ±nÄ± ekle
            tbody += `
            <tr style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); font-weight: bold; border-top: 2px solid #cbd5e1; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);font-weight:700;color:#475569;border-radius:6px 0 0 6px;">TOPLAM / ORTALAMA</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;font-weight:700;color:#1e293b;">${formatAylikSure(toplamCalismaGenel)}</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;font-weight:700;color:#1e293b;">${formatAylikSure(toplamPlanlananGenel)}</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;color:#f59e0b;font-weight:700;font-size:14px;">${ortalamaPlanliYuzde}%</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;font-weight:700;color:#1e293b;">${formatAylikSure(toplamPersonelGenel)}</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;color:#dc2626;font-weight:700;font-size:14px;">${ortalamaPersonelYuzde}%</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;font-weight:700;color:#1e293b;">${formatAylikSure(toplamMakineEkipmanGenel)}</td>
                <td style="padding:12px;border:1px solid #cbd5e1;text-align:center;color:#dc2626;font-weight:700;font-size:14px;border-radius:0 6px 6px 0;">${ortalamaMakineYuzde}%</td>
            </tr>`;
            
            document.getElementById('aylikAnalizBody').innerHTML = tbody;
        }
        function createEkAnalizTablosu() {
            if (!allSuccessRows.length) {
                document.getElementById('ekAnalizBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666;">Veri yÃ¼klenmedi</td></tr>';
                return;
            }
            
            let secilenYil = document.getElementById('ekAnalizYilFiltresi').value;
            
            // âœ… YIL FÄ°LTRESÄ°NÄ° ZORLA 2025 YAP
            if (!secilenYil || secilenYil === '2024') {
                secilenYil = '2025';
                
                // Dropdown'Ä± da gÃ¼ncelle
                const ekAnalizYilFiltresi = document.getElementById('ekAnalizYilFiltresi');
                if (ekAnalizYilFiltresi) {
                    ekAnalizYilFiltresi.value = secilenYil;
                }
                console.log(`Ek Analiz yÄ±lÄ± 2025'e Ã§evrildi: ${secilenYil}`);
            }
            const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                        'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            const ayRenkleri = [
                '#fef3f3', '#f0fdfa', '#fef3f3', '#f0fdfa', '#fef3f3', '#f0fdfa',
                '#fef3f3', '#f0fdfa', '#fef3f3', '#f0fdfa', '#fef3f3', '#f0fdfa'
            ];
            
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            const urunAdiIndex = findColIndex(currentHeader, ['urun', 'adi']);
            const prosesAdiIndex = findColIndex(currentHeader, ['proses', 'adi']);
            const okIndex = findColIndex(currentHeader, ['ok']);
            const nokIndex = findColIndex(currentHeader, ['hata', 'kod']);
            const baslamaSaatIndex = findColIndex(currentHeader, ['baslama', 'saat']);
            const bitisSaatIndex = findColIndex(currentHeader, ['bitis', 'saat']);
            const durusSureleriIndex = findColIndex(currentHeader, ['durus', 'sureleri']);
            
            if (dateColIndex < 0 || prosesAdiIndex < 0) {
                document.getElementById('ekAnalizBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666;">Gerekli sÃ¼tunlar bulunamadÄ±</td></tr>';
                return;
            }
            
            // YÄ±l filtresine gÃ¶re verileri filtrele
            const filteredData = allSuccessRows.filter(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                return dateParts.length === 3 && dateParts[2] === String(secilenYil);
            });
            
            // AylÄ±k verileri topla
            const aylikEkAnalizData = {};
            
            for (let i = 1; i <= 12; i++) {
                aylikEkAnalizData[i] = {
                    // Lens AA verileri
                    lensAAToplamSure: 0,
                    lensAANetSure: 0,
                    lensAAToplamDurus: 0,
                    // Son Kontrol verileri
                    sonKontrolOkUrun: 0,
                    sonKontrolToplamUrun: 0
                };
            }
            
            filteredData.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length !== 3) return;
                    
                const ay = parseInt(dateParts[1]);
                if (ay < 1 || ay > 12) return;
                
                const prosesAdi = String(row[prosesAdiIndex] || '').toLowerCase();
                const okUrun = parseInt(row[okIndex]) || 0;
                
                // NOK hesaplama
                let nokUrun = 0;
                if (nokIndex >= 0) {
                    const hataKodlariText = row[nokIndex] || '';
                    const hataMap = parseHataKodlari(hataKodlariText);
                    nokUrun = Object.values(hataMap).reduce((toplam, adet) => toplam + adet, 0);
                }
                
                // SÃ¼re hesaplamasÄ±
                const startTime = row[baslamaSaatIndex] || '';
                const endTime = row[bitisSaatIndex] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                
                // DuruÅŸ hesaplamalarÄ±
                const durusSureleriText = row[durusSureleriIndex] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                const kurulumSuresi = durusMap['D4'] || 0;
                const makinaArizasi = durusMap['D17'] || 0;
                const personelDurus = durusMap['D19'] || 0;
                const planliDurus = (durusMap['D12'] || 0) + (durusMap['D13'] || 0) + (durusMap['D18'] || 0) + (durusMap['D21'] || 0);
                const plansizDurus = (durusMap['D0'] || 0) + (durusMap['D1'] || 0) + (durusMap['D2'] || 0) + 
                                    (durusMap['D3'] || 0) + (durusMap['D5'] || 0) + (durusMap['D6'] || 0) + 
                                    (durusMap['D7'] || 0) + (durusMap['D8'] || 0) + (durusMap['D10'] || 0) + 
                                    (durusMap['D14'] || 0) + (durusMap['D15'] || 0) + (durusMap['D16'] || 0) + 
                                    (durusMap['D19'] || 0) + (durusMap['D20'] || 0) + (durusMap['D22'] || 0) + 
                                    (durusMap['D23'] || 0) + (durusMap['D24'] || 0);
                const makineProgramDurus = (durusMap['D9'] || 0) + (durusMap['D11'] || 0);
                const toplamDurus = kurulumSuresi + makinaArizasi + planliDurus + plansizDurus + makineProgramDurus;
                const netSure = workingTime.totalMinutes - toplamDurus;
                
                // LENS AA verileri (proses adÄ±nda 'lens aa' geÃ§enler)
                if (prosesAdi.includes('lens aa')) {
                    aylikEkAnalizData[ay].lensAAToplamSure += workingTime.totalMinutes;
                    aylikEkAnalizData[ay].lensAANetSure += netSure;
                    aylikEkAnalizData[ay].lensAAToplamDurus += toplamDurus;
                }
                
                if (prosesAdi.includes('son kontrol')) {
                    // Sadece SVC Ã¼rÃ¼nlerini filtrele
                    const urunAdi = String(row[urunAdiIndex] || '').toLowerCase();
                    if (urunAdi.includes('svc')) {
                        aylikEkAnalizData[ay].sonKontrolOkUrun += okUrun;
                        aylikEkAnalizData[ay].sonKontrolToplamUrun += (okUrun + nokUrun);
                    }
                }
            });
            
            let tbody = '';
            
            for (let i = 1; i <= 12; i++) {
                const data = aylikEkAnalizData[i];
                const ayRengi = ayRenkleri[i - 1];
                
                // 1. Ãœretilmesi Gereken (Lens AA) = (Toplam SÃ¼re * 60) / 55
                const uretilmesiGereken = data.lensAAToplamSure > 0 ? 
                    Math.round((data.lensAAToplamSure * 60) / 55) : 0;
                
                // 2. Ãœretilen (Son Kontrol OK Ã¼rÃ¼nler - SVC filtresi gerekirse eklenebilir)
                const uretilen = data.sonKontrolOkUrun;
                
                // 3. Ã‡alÄ±ÅŸma PerformansÄ± = Ãœretilen / Ãœretilmesi Gereken * 100
                const calismaPerformansi = uretilmesiGereken > 0 ? 
                    ((uretilen / uretilmesiGereken) * 100).toFixed(1) : '0.0';
                
                // 4. Net Ã‡alÄ±ÅŸma (Lens AA) = Net SÃ¼re / Toplam SÃ¼re * 100
                const netCalismaYuzdesi = data.lensAAToplamSure > 0 ? 
                    ((data.lensAANetSure / data.lensAAToplamSure) * 100).toFixed(1) : '0.0';
                
                // 5. Kalite (Son Kontrol) = OK / Toplam * 100
                const kaliteYuzdesi = data.sonKontrolToplamUrun > 0 ? 
                    ((data.sonKontrolOkUrun / data.sonKontrolToplamUrun) * 100).toFixed(1) : '0.0';

                const calismaPerformansDecimal = parseFloat(calismaPerformansi) / 100;
                const netCalismaDecimal = parseFloat(netCalismaYuzdesi) / 100;  
                const kaliteDecimal = parseFloat(kaliteYuzdesi) / 100;
                
                const genelOEE = (calismaPerformansDecimal * netCalismaDecimal * kaliteDecimal * 100).toFixed(1);

                
                tbody += `
                <tr style="background-color:${ayRengi};">
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;font-weight:500;">${aylar[i-1]}</td>
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${uretilmesiGereken.toLocaleString()}</td>
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${uretilen.toLocaleString()}</td>
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#7c3aed;">${calismaPerformansi}%</td>
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#ea580c;">${netCalismaYuzdesi}%</td>
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${kaliteYuzdesi}%</td>
                    <td style="padding:8px 12px;border:1px solid #e5e7eb;text-align:center;font-weight:700;color:#16a34a;background:#dcfce7;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">${genelOEE}%</td>
                </tr>`;
            }
            
            document.getElementById('ekAnalizBody').innerHTML = tbody;
        }

        function populateEkAnalizYilFiltresi() {
            if (!allSuccessRows.length) return;
            
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            if (dateColIndex < 0) return;

            const yillar = new Set();
            allSuccessRows.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length === 3) {
                    yillar.add(dateParts[2]);
                }
            });

            const yilArray = Array.from(yillar).sort();
            const ekAnalizYilFiltresi = document.getElementById('ekAnalizYilFiltresi');
            ekAnalizYilFiltresi.innerHTML = '<option value="">TÃ¼m YÄ±llar</option>';
            
            yilArray.forEach(yil => {
                ekAnalizYilFiltresi.innerHTML += `<option value="${yil}">${yil}</option>`;
            });
            
            if (yilArray.length > 0) {
                // âœ… VARSAYILAN YIL OLARAK 2025'Ä° SEÃ‡
                const defaultYear = yilArray.includes('2025') ? '2025' : yilArray[yilArray.length - 1];
                ekAnalizYilFiltresi.value = defaultYear;
                
                console.log(`Ek Analiz varsayÄ±lan yÄ±l: ${defaultYear}`);
                
                setTimeout(() => {
                    createEkAnalizTablosu();
                }, 50);
            }
        }
        function formatGunSaatDakika(dakika) {
            if (dakika === 0) return '0g 0s 0dk';
            
            const gun = Math.floor(dakika / (24 * 60));
            const saat = Math.floor((dakika % (24 * 60)) / 60);
            const kalanDakika = dakika % 60;
            
            return `${gun}g ${saat}s ${kalanDakika}dk`;
        }
        function formatAylikSure(dakika) {
            if (dakika === 0) return '0g 0s 0dk (0 dk)';
            
            const gun = Math.floor(dakika / (24 * 60));
            const saat = Math.floor((dakika % (24 * 60)) / 60);
            const kalanDakika = dakika % 60;
            
            return `${gun}g ${saat}s ${kalanDakika}dk (${dakika} dk)`;
        }
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////DuruÅŸ sÃ¼releri analizi sekmesi/////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        
        let currentDurusPage = 1;       //duruÅŸlar tablosu hazÄ±rlama fonksiyonu
        const durusRowsPerPage = 400;

        function createMultiSelectDropdown(containerId, options, selectedValues, placeholder, onChangeCallback) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const selectedText = selectedValues.length === 0 ? placeholder : 
                                 selectedValues.length === 1 ? selectedValues[0] :
                                 `${selectedValues.length} seÃ§ildi`;
            
            container.innerHTML = `
                <div class="multi-select-dropdown">
                    <button type="button" class="multi-select-button" onclick="toggleMultiSelectDropdown('${containerId}')">
                        <span class="selected-text">${selectedText}</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="multi-select-dropdown-content" id="${containerId}-content">
                        ${options.map(option => `
                            <div class="multi-select-option" onclick="toggleMultiSelectOption('${containerId}', '${option.replace(/'/g, "\\'")}')">
                                <input type="checkbox" class="multi-select-checkbox" ${selectedValues.includes(option) ? 'checked' : ''}>
                                <span>${option}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Store callback function
            container.dataset.callback = onChangeCallback.name;
        }
        
        function toggleMultiSelectDropdown(containerId) {
            const content = document.getElementById(containerId + '-content');
            const arrow = document.querySelector(`#${containerId} .dropdown-arrow`);
            
            // Ã–nce diÄŸer tÃ¼m dropdown'larÄ± kapat
            document.querySelectorAll('.multi-select-dropdown-content').forEach(dropdown => {
                if (dropdown.id !== containerId + '-content') {
                    dropdown.classList.remove('show');
                }
            });
            document.querySelectorAll('.dropdown-arrow').forEach(arr => {
                if (arr !== arrow) {
                    arr.classList.remove('open');
                }
            });
            
            // Bu dropdown'Ä± aÃ§/kapat
            content.classList.toggle('show');
            arrow.classList.toggle('open');
        }
        
        function toggleMultiSelectOption(containerId, option) {
            const container = document.getElementById(containerId);
            const checkbox = event.target.closest('.multi-select-option').querySelector('.multi-select-checkbox');
            checkbox.checked = !checkbox.checked;
            
            // SeÃ§ili deÄŸerleri gÃ¼ncelle
            updateMultiSelectValues(containerId);
            
            // Callback'i Ã§aÄŸÄ±r
            const callbackName = container.dataset.callback;
            if (window[callbackName]) {
                window[callbackName]();
            }
        }
        
        function updateMultiSelectValues(containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('.multi-select-checkbox');
            const selectedValues = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const optionText = checkbox.nextElementSibling.textContent;
                    selectedValues.push(optionText);
                }
            });
            
            // SeÃ§ili deÄŸerleri filtrelere kaydet
            if (containerId.includes('Name')) {
                currentDurusFilters.name = selectedValues;
            } else if (containerId.includes('Product')) {
                currentDurusFilters.product = selectedValues;
            } else if (containerId.includes('Process')) {
                currentDurusFilters.process = selectedValues;
            }
            
            // Button textini gÃ¼ncelle
            const button = container.querySelector('.selected-text');
            const placeholder = containerId.includes('Name') ? 'TÃ¼m Ä°simler' :
                               containerId.includes('Product') ? 'TÃ¼m ÃœrÃ¼nler' :
                               'TÃ¼m Prosesler';
            
            const selectedText = selectedValues.length === 0 ? placeholder :
                                selectedValues.length === 1 ? selectedValues[0] :
                                `${selectedValues.length} seÃ§ildi`;
            button.textContent = selectedText;
        }
        
        // Dropdown'larÄ±n dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda kapat
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select-dropdown')) {
                document.querySelectorAll('.multi-select-dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-arrow').forEach(arrow => {
                    arrow.classList.remove('open');
                });
            }
        });

        function createDurusAnalysisTable() {
            const headers = [
                'ID', 'Name', 'Tarih', 'ÃœrÃ¼n AdÄ±', 'Proses AdÄ±', 'OK ÃœrÃ¼n', 'NOK ÃœrÃ¼n', 'Ã‡alÄ±ÅŸÄ±lan SÃ¼re (saat)',
                'Ã‡alÄ±ÅŸÄ±lan SÃ¼re (dk)', 'Net SÃ¼re', 'Kurulum SÃ¼resi', 'Makina ArÄ±zasÄ±',
                'Personel DuruÅŸu', 'PlanlÄ± DuruÅŸ', 'PlansÄ±z DuruÅŸ', 'Makina/ Program DuruÅŸlarÄ±',
                'Toplam DuruÅŸ', 'Planlanan DuruÅŸlar', 'Personel KaynaklÄ± DuruÅŸlar',
                'Makina+Ekipman KaynaklÄ± DuruÅŸlar'
            ];
            const durusTableWrap = document.getElementById('durusTableWrap');

            if (!allSuccessRows.length) {
                durusTableWrap.innerHTML = '<div style="padding:12px;color:#666">Ã–nce veri yÃ¼kleyin</div>';
                return;
            }
            const startIndex = (currentDurusPage - 1) * durusRowsPerPage;
            const endIndex = startIndex + durusRowsPerPage;
            const filteredRows = window.filteredDurusRows || allSuccessRows;
            const totalPages = Math.ceil(filteredRows.length / durusRowsPerPage);
            const pageRows = filteredRows.slice(startIndex, endIndex);
            const idxID = findColIndex(currentHeader, ['id']);
            const idxName = findColIndex(currentHeader, ['name']);
            const idxTarih = findColIndex(currentHeader, ['tarih']);
            const idxUrunAdi = findColIndex(currentHeader, ['urun', 'adi']);
            const idxProsesAdi = findColIndex(currentHeader, ['proses', 'adi']);
            const idxOK = findColIndex(currentHeader, ['ok']);
            const idxBaslamaSaat = findColIndex(currentHeader, ['baslama', 'saat']);
            const idxBitisSaat = findColIndex(currentHeader, ['bitis', 'saat']);
            const idxDurusSureleri = findColIndex(currentHeader, ['durus', 'sureleri']);
            const idxHataKodlari = findColIndex(currentHeader, ['hata', 'kod']); // ya da ['hata', 'adet']

            const pagination = `
            <div style="position:sticky;top:0;z-index:10;padding:8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb;background:#f8fafc;margin-bottom:8px;border-radius:8px;box-shadow:0 -1px 6px rgba(0,0,0,0.1);">
                <div class="filter-section">
                    <span style="font-weight:500;font-size:12px;color:#374151;">Filtreler:</span>
                    <div id="durusDropdownName"></div>
                    <div id="durusDropdownProduct"></div>
                    <div id="durusDropdownProcess"></div>
                    <button class="clear-filters-btn" onclick="clearDurusFilters()">Temizle</button>
                </div>
                <div style="display:flex;align-items:center;">
                    <button onclick="goToDurusPage(${currentDurusPage - 1})" ${currentDurusPage === 1 ? 'disabled' : ''} 
                            style="padding:6px 12px;margin:0 4px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;color:#374151;transition:all 0.2s;${currentDurusPage === 1 ? 'opacity:0.5;cursor:not-allowed;' : ''}">
                        â—€
                    </button>
                    <span style="margin:0 12px;font-weight:500;font-size:13px;color:#374151;">
                        Sayfa ${currentDurusPage} / ${totalPages} (${filteredRows.length} kayÄ±t)
                    </span>
                    <button onclick="goToDurusPage(${currentDurusPage + 1})" ${currentDurusPage === totalPages ? 'disabled' : ''} 
                            style="padding:6px 12px;margin:0 4px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;color:#374151;transition:all 0.2s;${currentDurusPage === totalPages ? 'opacity:0.5;cursor:not-allowed;' : ''}">
                        â–¶
                    </button>
                </div>
            </div>`;
            const columnWidths = [
                '3ch',   // ID
                '20ch',  // Name  
                '12ch',  // Tarih
                '12ch',  // ÃœrÃ¼n AdÄ±
                '20ch',  // Proses AdÄ±
                '8ch', '8ch', '10ch', '10ch', '8ch', '10ch', '10ch', '10ch', '8ch', '8ch', '11ch', '10ch', '11ch', '10ch', '11ch'
            ];
            const colgroup = '<colgroup>' + columnWidths.map(width => `<col style="width:${width}">`).join('') + '</colgroup>';
            const ths = headers.map(h => `<th style="white-space:normal;word-wrap:break-word;width:8ch;min-width:8ch;max-width:8ch;">${esc(h)}</th>`).join('');        
        
            let tbody = '';

            let totalOK = 0;
            let totalNOK = 0;
            let totalWorkingMinutes = 0;
            let totalNetSure = 0;
            let totalKurulum = 0;
            let totalMakinaAriza = 0;
            let totalPersonelDurus = 0;
            let totalPlanliDurus = 0;
            let totalPlansizDurus = 0;
            let totalMakineProgram = 0;
            let totalToplamDurus = 0;
            let totalPlanlanan = 0;
            let totalPersonelKaynakli = 0;
            let totalMakineEkipman = 0;

            for (const row of pageRows) {
                const id = row[idxID] || '';
                const name = row[idxName] || '';
                const tarih = row[idxTarih] || '';
                const urunAdi = row[idxUrunAdi] || '';
                const prosesAdi = row[idxProsesAdi] || '';
                const okUrun = row[idxOK] || '';
                const startTime = row[idxBaslamaSaat] || '';
                const endTime = row[idxBitisSaat] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                const durusSureleriText = row[idxDurusSureleri] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                const hataKodlariText = row[idxHataKodlari] || '';
                const hataMap = parseHataKodlari(hataKodlariText);
                const nokUrun = Object.values(hataMap).reduce((toplam, adet) => toplam + adet, 0);
                const kurulumSuresi = durusMap['D4'] || 0;      //d4 iÃ§in sÃ¼releri sakladÄ±ÄŸÄ±m map
                const makinaArizasi = durusMap['D17'] || 0;
                const personelDurus = durusMap['D19'] || 0;
                const planliDurus = (durusMap['D12'] || 0) + (durusMap['D13'] || 0) + (durusMap['D18'] || 0) + (durusMap['D21'] || 0);
                const plansizDurus = (durusMap['D0'] || 0) + (durusMap['D1'] || 0) + (durusMap['D2'] || 0) + 
                                        (durusMap['D3'] || 0) + (durusMap['D5'] || 0) + (durusMap['D6'] || 0) + 
                                        (durusMap['D7'] || 0) + (durusMap['D8'] || 0) + (durusMap['D10'] || 0) + 
                                        (durusMap['D14'] || 0) + (durusMap['D15'] || 0) + (durusMap['D16'] || 0) + 
                                        (durusMap['D19'] || 0) + (durusMap['D20'] || 0) + (durusMap['D22'] || 0) + 
                                        (durusMap['D23'] || 0) + (durusMap['D24'] || 0);
                const makineProgramDurus = (durusMap['D9'] || 0) + (durusMap['D11'] || 0);
                const toplamDurus = kurulumSuresi + makinaArizasi + planliDurus + plansizDurus + makineProgramDurus;
                const Planlananduruslar = kurulumSuresi + planliDurus;
                const personelKaynakliDuruslar = personelDurus;
                const makineEkipmanDuruslar = makinaArizasi + makineProgramDurus;
                const netSure = workingTime.totalMinutes - toplamDurus;

                totalOK += parseInt(okUrun) || 0;
                totalNOK += parseInt(nokUrun) || 0;
                totalWorkingMinutes += workingTime.totalMinutes;
                totalNetSure += netSure;
                totalKurulum += kurulumSuresi;
                totalMakinaAriza += makinaArizasi;
                totalPersonelDurus += personelDurus;
                totalPlanliDurus += planliDurus;
                totalPlansizDurus += plansizDurus;
                totalMakineProgram += makineProgramDurus;
                totalToplamDurus += toplamDurus;
                totalPlanlanan += Planlananduruslar;
                totalPersonelKaynakli += personelKaynakliDuruslar;
                totalMakineEkipman += makineEkipmanDuruslar;

                tbody += `<tr>
                    <td>${esc(id)}</td>
                    <td>${esc(name)}</td>
                    <td>${esc(tarih)}</td>
                    <td>${esc(urunAdi)}</td>
                    <td>${esc(prosesAdi)}</td>
                    <td class="ok-column">${esc(okUrun)}</td>
                    <td class="nok-column">${esc(nokUrun)}</td>
                    <td>${workingTime.formatted}</td>
                    <td>${workingTime.totalMinutes}</td>
                    <td>${netSure}</td>
                    <td>${kurulumSuresi}</td>
                    <td>${makinaArizasi}</td>
                    <td>${personelDurus}</td>
                    <td>${planliDurus}</td>
                    <td>${plansizDurus}</td>
                    <td>${makineProgramDurus}</td>
                    <td>${toplamDurus}</td>
                    <td>${Planlananduruslar}</td>
                    <td>${personelKaynakliDuruslar}</td>
                    <td>${makineEkipmanDuruslar}</td>
                </tr>`;
            }
            const totalHours = Math.floor(totalWorkingMinutes / 60);
            const totalMinutes = totalWorkingMinutes % 60;
            const totalWorkingFormatted = `${totalHours}:${String(totalMinutes).padStart(2, '0')}`;
            const durusPagination = document.getElementById('durusPagination');
            durusPagination.innerHTML = pagination;   
            tbody += `<tr style="background-color: #f3f4f6; font-weight: bold; border-top: 2px solid #374151;">
                <td colspan="5" style="text-align: center; background-color: #e5e7eb;">TOPLAM</td>
                <td class="ok-column" style="font-weight: bold;">${totalOK}</td>
                <td class="nok-column" style="font-weight: bold;">${totalNOK}</td>
                <td>${totalWorkingFormatted}</td>
                <td>${totalWorkingMinutes}</td>
                <td>${totalNetSure}</td>
                <td>${totalKurulum}</td>
                <td>${totalMakinaAriza}</td>
                <td>${totalPersonelDurus}</td>
                <td>${totalPlanliDurus}</td>
                <td>${totalPlansizDurus}</td>
                <td>${totalMakineProgram}</td>
                <td>${totalToplamDurus}</td>
                <td>${totalPlanlanan}</td>
                <td>${totalPersonelKaynakli}</td>
                <td>${totalMakineEkipman}</td>
            </tr>`;
            durusTableWrap.innerHTML = `<table>${colgroup}<thead><tr>${ths}</tr></thead><tbody>${tbody}</tbody></table>`;
            setTimeout(() => {
                setupDurusMultiSelectFilters();
            }, 10);
        }
        function goToDurusPage(page) {
            const totalPages = Math.ceil(allSuccessRows.length / durusRowsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentDurusPage = page;
                createDurusAnalysisTable();
            }
        }
        function calculateWorkingTime(startTime, endTime) {
            if (!startTime || !endTime) return { formatted: '0:00', totalMinutes: 0 };
            
            try {
                // HH:MM formatÄ±nÄ± parse et
                const parseTime = (timeStr) => {
                    const match = String(timeStr).match(/^(\d{1,2}):(\d{2})$/);
                    if (!match) return null;
                    return { hours: parseInt(match[1]), minutes: parseInt(match[2]) };
                };
                const start = parseTime(startTime);
                const end = parseTime(endTime);
                
                if (!start || !end) return { formatted: '0:00', totalMinutes: 0 };
                
                const startMinutes = start.hours * 60 + start.minutes;
                let endMinutes = end.hours * 60 + end.minutes;
                if (endMinutes <= startMinutes) {
                    endMinutes += 24 * 60;
                }
                const totalMinutes = endMinutes - startMinutes;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return { 
                    formatted: `${hours}:${String(minutes).padStart(2, '0')}`, 
                    totalMinutes: totalMinutes 
                };
            } catch (error) {
                return { formatted: '0:00', totalMinutes: 0 };
            }
        }
        function extractDurusUniqueValues() {       //duruÅŸlar iÃ§in filtreleme yapan unique deÄŸer toplamna fonksiyonu
            if (!allSuccessRows.length) return;
            
            const nameIdx = findColIndex(currentHeader, ['name']);
            const productIdx = findColIndex(currentHeader, ['urun', 'adi']);
            const processIdx = findColIndex(currentHeader, ['proses', 'adi']);
            
            const nameSet = new Set();
            const productSet = new Set();
            const processSet = new Set();
            
            allSuccessRows.forEach(row => {
                if (nameIdx >= 0 && row[nameIdx]) nameSet.add(String(row[nameIdx]).trim());
                if (productIdx >= 0 && row[productIdx]) productSet.add(String(row[productIdx]).trim());
                if (processIdx >= 0 && row[processIdx]) processSet.add(String(row[processIdx]).trim());
            });
            
            durusUniqueValues.name = Array.from(nameSet).sort();
            durusUniqueValues.product = Array.from(productSet).sort();
            durusUniqueValues.process = Array.from(processSet).sort();
        }
        function applyDurusFilters() {      //filtrele duruÅŸlar
            if (!allSuccessRows.length) return;
            const nameIdx = findColIndex(currentHeader, ['name']);
            const productIdx = findColIndex(currentHeader, ['urun', 'adi']);
            const processIdx = findColIndex(currentHeader, ['proses', 'adi']);
            
            let filteredRows = allSuccessRows.filter(row => {
                let matches = true;
                
                // Ä°sim filtresi - Ã§oklu seÃ§im
                if (currentDurusFilters.name.length > 0 && nameIdx >= 0) {
                    const nameVal = String(row[nameIdx] || '').toLowerCase();
                    matches = matches && currentDurusFilters.name.some(filterName => 
                        nameVal.includes(filterName.toLowerCase())
                    );
                }
                
                // ÃœrÃ¼n filtresi - Ã§oklu seÃ§im
                if (currentDurusFilters.product.length > 0 && productIdx >= 0) {
                    const productVal = String(row[productIdx] || '').toLowerCase();
                    matches = matches && currentDurusFilters.product.some(filterProduct => 
                        productVal.includes(filterProduct.toLowerCase())
                    );
                }
                
                // Proses filtresi - Ã§oklu seÃ§im
                if (currentDurusFilters.process.length > 0 && processIdx >= 0) {
                    const processVal = String(row[processIdx] || '').toLowerCase();
                    matches = matches && currentDurusFilters.process.some(filterProcess => 
                        processVal.includes(filterProcess.toLowerCase())
                    );
                }
                
                return matches;
            });
            const fromDate = durusDateFrom.value;
            const toDate = durusDateTo.value;
            if (fromDate || toDate) {
                const dateColIndex = currentHeader.findIndex(h => 
                    norm(h).includes('tarih') || norm(h).includes('date')
                );
                
                if (dateColIndex >= 0) {
                    filteredRows = filteredRows.filter(row => {
                        const cellDate = String(row[dateColIndex] || '').trim();
                        const dateParts = cellDate.split('.');
                        if (dateParts.length !== 3) return false;
                        
                        const cellDateFormatted = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                        
                        let matchesFrom = true;
                        let matchesTo = true;
                        
                        if (fromDate) matchesFrom = cellDateFormatted >= fromDate;
                        if (toDate) matchesTo = cellDateFormatted <= toDate;
                        
                        return matchesFrom && matchesTo;
                    });
                }
            }
            currentDurusPage = 1;
            window.filteredDurusRows = filteredRows; // Global'e kaydet
            createDurusAnalysisTable();
        }
        function clearDurusFilters() {
            currentDurusFilters = { name: [], product: [], process: [] };
            durusDateFrom.value = '';
            durusDateTo.value = '';
            currentDurusPage = 1;
            window.filteredDurusRows = allSuccessRows;
            createDurusAnalysisTable();
        }
        function setupDurusMultiSelectFilters() {
            // Ã‡oklu seÃ§im dropdown'larÄ±nÄ± oluÅŸtur
            createMultiSelectDropdown(
                'durusDropdownName', 
                durusUniqueValues.name, 
                currentDurusFilters.name, 
                'TÃ¼m Ä°simler',
                applyDurusFilters
            );
            
            createMultiSelectDropdown(
                'durusDropdownProduct', 
                durusUniqueValues.product, 
                currentDurusFilters.product, 
                'TÃ¼m ÃœrÃ¼nler',
                applyDurusFilters
            );
            
            createMultiSelectDropdown(
                'durusDropdownProcess', 
                durusUniqueValues.process, 
                currentDurusFilters.process, 
                'TÃ¼m Prosesler',
                applyDurusFilters
            );
        }
        window.applyDurusFilters = applyDurusFilters;

        function normalizeDateTimeCell(v){
            if (v instanceof Date && !isNaN(v)) {
                return formatMDY_HHMMSS(v);
            }
            if (typeof v === 'number' && isFinite(v)) {
                return formatMDY_HHMMSS(excelDateToJSDate(v));
            }
            if (typeof v === 'string'){
                const s = v.trim();
                if (s === '') return '';
                if (!isNaN(s)) return formatMDY_HHMMSS(excelDateToJSDate(parseFloat(s)));
                const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2})(?:\s+(\d{1,2}):([0-5]\d)(?::([0-5]\d))?)?$/);
                if (m){
                const M  = +m[1], D = +m[2], YY = String(+m[3]).padStart(2,'0');
                const hh = String(+m[4] || 0).padStart(2,'0');
                const mm = String(+m[5] || 0).padStart(2,'0');
                const ss = String(+m[6] || 0).padStart(2,'0');
                return `${M}.${D}.${YY} ${hh}:${mm}:${ss}`;
                }
                const d = new Date(s);
                if (!isNaN(d)) return formatMDY_HHMMSS(d);

                return s; // anlamlÄ± deÄŸilse dokunma
            }
            return '';
        }
        
        function normalizeTimeCell(v){
            if (v instanceof Date && !isNaN(v)) {
                const hh = String(v.getHours()).padStart(2,'0');
                const mm = String(v.getMinutes()).padStart(2,'0');
                return `${hh}:${mm}`;
            }
            if (typeof v === 'number' && isFinite(v)) {
                // Excel'in gÃ¼nÃ¼n kesri â†’ HH:MM
                const totalMin = Math.round((v % 1) * 24 * 60);
                const hh = String(Math.floor(totalMin / 60) % 24).padStart(2,'0');
                const mm = String(totalMin % 60).padStart(2,'0');
                return `${hh}:${mm}`;
            }
            if (typeof v === 'string'){
                const s = v.trim();
                if (s === '') return '';
                // "HH:MM" ya da "HH:MM:SS" gelirse HH:MM'e indir
                const m = s.match(/^(\d{1,2}):([0-5]\d)(?::[0-5]\d)?$/);
                if (m) return String(m[1]).padStart(2,'0') + ':' + m[2];
                // "0.7123" gibi sayÄ±sal string gelirse de Ã§evir
                if (!isNaN(s)) return normalizeTimeCell(parseFloat(s));
                return s;
            }
            return '';
        }
        function isValidMDYDateTime(s){
            return /^(?:[1-9]|1[0-2])\.(?:[1-9]|[12]\d|3[01])\.\d{2}\s(?:[01]\d|2[0-3]):[0-5]\d:[0-5]\d$/
                    .test(String(s||'').trim());
        }
        function isValidDateFormat(str){
            return /^\d{2}\.\d{2}\.\d{4}$/.test(String(str));
        }
        function isTimeStringValid(timeString){
            if (typeof timeString === "number") return timeString >= 0 && timeString <= 1;
            if (typeof timeString === "string") return /^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(timeString);
            return false;
        }
        function isPatternMatch(input){
            if (typeof input !== "string") return false;
            const cleaned = input.replace(/\s/g,'');
            return /^(\d+\*[A-Za-z0-9_]+)(\+\d+\*[A-Za-z0-9_]+)*$/.test(cleaned);
        }
        function extractTextValues(input){
            if (!input || typeof input !== "string") return [];
            const pattern = /\b\d+\s*\*\s*([A-Za-z0-9_]+)\s*\b/g;
            const out=[]; let m;
            while((m=pattern.exec(input))!==null){ if(m[1]) out.push(m[1].toUpperCase()); }
            return out;
        }

        const containsAll = (list, allow) => list.every(x => allow.includes(x));

        function isPatternValid(text, validList){
            if (!text || text === "0") return true;            // boÅŸ/0 = sorun yok
            if (!isPatternMatch(text)) return false;
            const codes = extractTextValues(text);
            return containsAll(codes, validList);
        }
        function showLoading(text = 'YÃ¼kleniyor...') {
          loadingText.textContent = text;
          loadingOverlay.classList.remove('hidden');
        }
        function hideLoading() {
          loadingOverlay.classList.add('hidden');
        }
        function filterTableByDate() {    // tarihe fÃ¶re filtreleme burada 
          const fromDate = dateFrom.value;
          const toDate = dateTo.value;
          if ((!fromDate && !toDate) || !allSuccessRows.length) return;
          showLoading('Filtreleniyor...');
          setTimeout(() => {
              const dateColIndex = currentHeader.findIndex(h => 
                  norm(h).includes('tarih') || norm(h).includes('date')
              );
              if (dateColIndex === -1) {
                  alert('Tarih sÃ¼tunu bulunamadÄ±!');
                  hideLoading();
                  return;
              }
              const filteredRows = allSuccessRows.filter(row => {
                  const cellDate = String(row[dateColIndex] || '').trim();
                  const dateParts = cellDate.split('.');
                  if (dateParts.length !== 3) return false;
                  
                  const cellDateFormatted = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                  
                  let matchesFrom = true;
                  let matchesTo = true;
                  
                  if (fromDate) {
                      matchesFrom = cellDateFormatted >= fromDate;
                  }
                  if (toDate) {
                      matchesTo = cellDateFormatted <= toDate;
                  }
                  
                  return matchesFrom && matchesTo;
              });
              const aoaFiltered = [currentHeader, ...filteredRows];
              tableWrap.innerHTML = aoaToTable(aoaFiltered);
              chipRows.textContent = `ğŸ“‹ GÃ¶sterilen: ${filteredRows.length} / Toplam: ${allSuccessRows.length}`;
              
              hideLoading();
          }, 100);
        }
        function clearDateFilter() {
            dateFrom.value = '';
            dateTo.value = '';
            if (allSuccessRows.length) {
                const aoaAll = [currentHeader, ...allSuccessRows];
                tableWrap.innerHTML = aoaToTable(aoaAll);
                const errorCount = allErrorRows.length;
                chipRows.textContent = `ğŸ“‹ BaÅŸarÄ±lÄ±: ${allSuccessRows.length} / HatalÄ±: ${allErrorRows.length}`;
            }
        }
        ['dragenter','dragover'].forEach(evt => {
            dropArea.addEventListener(evt, e => {
            e.preventDefault(); e.stopPropagation();
            dropArea.classList.add('active');
            });
        });
        ['dragleave','dragend','drop'].forEach(evt => {
            dropArea.addEventListener(evt, e => {
            e.preventDefault(); e.stopPropagation();
            dropArea.classList.remove('active');
            });
        });
        dropArea.addEventListener('drop', e => {
            const file = e.dataTransfer?.files?.[0];
            if (file) handleFile(file);
        });
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) handleFile(file);
        });
        const esc = (x) => String(x ?? '').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////prosesler analizi/////////////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////

        const smdYilFiltresi = document.getElementById('smdYilFiltresi');
        const lensYilFiltresi = document.getElementById('lensYilFiltresi');
        const eolYilFiltresi = document.getElementById('eolYilFiltresi');
        const sizdirmazlikYilFiltresi = document.getElementById('sizdirmazlikYilFiltresi');
        const lazerYilFiltresi = document.getElementById('lazerYilFiltresi');
        const sonKontrolYilFiltresi = document.getElementById('sonKontrolYilFiltresi');
        let referansTablosu = {
            'DMS-BOT':         { sure: 290, dizilenAdet: 92,  panelKameraSayisi: 12 },
            'DMS-TOP':         { sure: 245, dizilenAdet: 78,  panelKameraSayisi: 12 },
            'SVC-BOT':         { sure: 462, dizilenAdet: 75,  panelKameraSayisi: 21 },
            'SVC-TOP':         { sure: 275, dizilenAdet: 45,  panelKameraSayisi: 21 },
            'TOFAÅ BOT':       { sure: 815, dizilenAdet: 117, panelKameraSayisi: 25 },
            'TOFAÅ TOP':       { sure: 906, dizilenAdet: 102, panelKameraSayisi: 25 },
            'FORD 123R1 BOT':  { sure: 435, dizilenAdet: 37,  panelKameraSayisi: 42 },
            'FORD 122R2 TOP':  { sure: 338, dizilenAdet: 58,  panelKameraSayisi: 12 },
            'FORD 124 BOT':    { sure: 42,  dizilenAdet: 42,  panelKameraSayisi: 42 },
            'FORD 124 TOP':    { sure: 436, dizilenAdet: 4,   panelKameraSayisi: 42 },
            'FORD 123R1 TOP':  { sure: 152, dizilenAdet: 9,   panelKameraSayisi: 42 },
            'FORD 122R2 BOT':  { sure: 276, dizilenAdet: 77,  panelKameraSayisi: 12 }
        };

        function showReferansTabloPopup() {
            const popupHtml = `
                <div id="referansPopup" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center;
                ">
                    <div style="
                        background: white; border-radius: 12px; padding: 20px; 
                        max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">
                            <h3 style="margin: 0; color: #374151; font-size: 18px; font-weight: 600;">âš¡Referans Tablosu DeÄŸerleri</h3>
                            <button onclick="closeReferansPopup()" style="
                                background: #ef4444; color: white; border: none; border-radius: 6px; 
                                padding: 6px 12px; cursor: pointer; font-size: 14px; font-weight: 500;
                            ">âœ•</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 10px; border: 1px solid #d1d5db; text-align: left; font-weight: 600;">ÃœrÃ¼n AdÄ±</th>
                                        <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">SÃ¼re (sn)</th>
                                        <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">Dizilen Adet</th>
                                    </tr>
                                </thead>
                                <tbody id="referansTableBody">
                                    ${Object.entries(referansTablosu).map(([urun, values]) => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 500;">${urun}</td>
                                            <td style="padding: 8px; border: 1px solid #d1d5db; text-align: center;">
                                                <input type="number" value="${values.sure}" 
                                                       data-urun="${urun}" data-field="sure"
                                                       style="width: 80px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center;">
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #d1d5db; text-align: center;">
                                                <input type="number" value="${values.dizilenAdet}" 
                                                       data-urun="${urun}" data-field="dizilenAdet"
                                                       style="width: 80px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center;">
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <button onclick="resetReferansToDefaults()" style="
                                background: #6b7280; color: white; border: none; border-radius: 6px; 
                                padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 500;
                            ">VarsayÄ±lana DÃ¶n</button>
                            <button onclick="saveReferansValues()" style="
                                background: #059669; color: white; border: none; border-radius: 6px; 
                                padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 500;
                            ">Kaydet ve Uygula</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', popupHtml);
        }

        function closeReferansPopup() {
            const popup = document.getElementById('referansPopup');
            if (popup) popup.remove();
        }

        function resetReferansToDefaults() {
            referansTablosu = {
                'DMS-BOT': { sure: 290, dizilenAdet: 92 },
                'DMS-TOP': { sure: 245, dizilenAdet: 78 },
                'SVC-BOT': { sure: 462, dizilenAdet: 75 },
                'SVC-TOP': { sure: 275, dizilenAdet: 45 },
                'TOFAÅ BOT': { sure: 815, dizilenAdet: 117 },
                'TOFAÅ TOP': { sure: 906, dizilenAdet: 102 },
                'FORD BOT': { sure: 0, dizilenAdet: 0 },
                'FORD TOP': { sure: 0, dizilenAdet: 0 }
            };
            
            // Input'larÄ± gÃ¼ncelle
            document.querySelectorAll('#referansTableBody input').forEach(input => {
                const urun = input.dataset.urun;
                const field = input.dataset.field;
                if (referansTablosu[urun]) {
                    input.value = referansTablosu[urun][field];
                }
            });
        }

        function saveReferansValues() {
            // Input deÄŸerlerini oku ve kaydet
            document.querySelectorAll('#referansTableBody input').forEach(input => {
                const urun = input.dataset.urun;
                const field = input.dataset.field;
                const value = parseInt(input.value) || 0;
                
                if (!referansTablosu[urun]) {
                    referansTablosu[urun] = { sure: 0, dizilenAdet: 0 };
                }
                referansTablosu[urun][field] = value;
            });
            
            // Popup'Ä± kapat
            closeReferansPopup();
            
            // SMD tablosunu yeniden oluÅŸtur
            createSmdAnalysisTable();
        }

        function calculateDizilenKompanent(fullProductName, dizilenAdet, fire) {
            // ÃœrÃ¼n adÄ±ndan referans tablosundaki key'i bul
            let referansKey = null;
            let referansDeger = 0;
            console.log('Aranan Ã¼rÃ¼n:', fullProductName); // Debug iÃ§in
            console.log('Dizilen Adet (OK):', dizilenAdet); // Debug iÃ§in
            console.log('Fire (NOK):', fire); // Debug iÃ§in
            
            // Ã–nce tam eÅŸleÅŸme ara
            if (referansTablosu[fullProductName]) {
                referansKey = fullProductName;
                referansDeger = referansTablosu[referansKey].dizilenAdet;
            } else {
                // EÄŸer tam eÅŸleÅŸme yoksa, benzer eÅŸleÅŸme ara
                const productUpper = fullProductName.toUpperCase();
                console.log('BÃ¼yÃ¼k harf Ã¼rÃ¼n:', productUpper); // Debug iÃ§in
                
                for (const key of Object.keys(referansTablosu)) {
                    const keyUpper = key.toUpperCase();
                    console.log('Kontrol edilen key:', keyUpper); // Debug iÃ§in
                    
                    // Daha esnek eÅŸleÅŸme - parÃ§alÄ± eÅŸleÅŸme
                    if (productUpper.includes('SVC') && keyUpper.includes('SVC')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    } else if (productUpper.includes('DMS') && keyUpper.includes('DMS')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    } else if (productUpper.includes('TOFAÅ') && keyUpper.includes('TOFAÅ')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    } else if (productUpper.includes('FORD') && keyUpper.includes('FORD')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansDeger = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    }
                }
            }
            
            if (!referansKey || referansDeger === 0) {
                console.log('Referans bulunamadÄ± iÃ§in - dÃ¶ndÃ¼rÃ¼yor'); // Debug iÃ§in
                return '-'; // Referans bulunamadÄ±
            }
            
            const dizilenKompanent = (dizilenAdet * referansDeger) + fire;
            console.log(`Hesaplama: (${dizilenAdet} * ${referansDeger}) + ${fire} = ${dizilenKompanent}`); // Debug iÃ§in
            
            return dizilenKompanent;
        }

        function populateYilFiltresiForProses(selectElement) {
            if (!allSuccessRows.length) return;
            
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            if (dateColIndex < 0) return;

            const yillar = new Set();
            allSuccessRows.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length === 3) {
                    yillar.add(dateParts[2]);
                }
            });
            const yilArray = Array.from(yillar).sort();
            selectElement.innerHTML = '<option value="">TÃ¼m YÄ±llar</option>';
            yilArray.forEach(yil => {
                selectElement.innerHTML += `<option value="${yil}">${yil}</option>`;
            });
        }
        function getDarkerColor(hexColor) {            // Hex rengi daha koyu bir tona Ã§evir
            const colorMap = {
                '#fef3f3': '#f87171', // AÃ§Ä±k kÄ±rmÄ±zÄ± -> Koyu kÄ±rmÄ±zÄ±
                '#f0f9ff': '#60a5fa', // AÃ§Ä±k mavi -> Koyu mavi
                '#f0fdf4': '#4ade80', // AÃ§Ä±k yeÅŸil -> Koyu yeÅŸil
                '#fffbeb': '#facc15', // AÃ§Ä±k sarÄ± -> Koyu sarÄ±
                '#fdf4ff': '#a855f7', // AÃ§Ä±k mor -> Koyu mor
                '#fff1f2': '#f472b6', // AÃ§Ä±k pembe -> Koyu pembe
                '#f0fdfa': '#2dd4bf', // AÃ§Ä±k turkuaz -> Koyu turkuaz
                '#fefce8': '#a3e635', // AÃ§Ä±k lime -> Koyu lime
                '#f8fafc': '#64748b', // AÃ§Ä±k gri -> Koyu gri
                '#fdf2f8': '#ec4899', // AÃ§Ä±k fuÅŸya -> Koyu fuÅŸya
                '#ecfeff': '#06b6d4', // AÃ§Ä±k cyan -> Koyu cyan
                '#faf5ff': '#8b5cf6'  // AÃ§Ä±k lavanta -> Koyu lavanta
            };
            return colorMap[hexColor] || '#6b7280';
        }
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            
            // Ocak ayÄ± Ã¶zel durumu
            if (d.getMonth() === 0) { // Ocak ayÄ±
                if (d.getDate() <= 7) { // OcaÄŸÄ±n ilk 7 gÃ¼nÃ¼
                    const firstDay = new Date(d.getFullYear(), 0, 1);
                    const firstDayOfWeek = (firstDay.getDay() + 6) % 7;
                    const firstWeekEnd = new Date(firstDay.getTime() + (6 - firstDayOfWeek) * 86400000);
                    
                    if (d <= firstWeekEnd) {
                        return 1; // W1
                    }
                }
                const jan1 = new Date(d.getFullYear(), 0, 1);
                const jan1DayOfWeek = (jan1.getDay() + 6) % 7;
                const firstWeekEnd = new Date(jan1.getTime() + (6 - jan1DayOfWeek) * 86400000);
                const daysSinceFirstWeekEnd = Math.floor((d.getTime() - firstWeekEnd.getTime()) / 86400000);
                
                return Math.floor(daysSinceFirstWeekEnd / 7) + 2; // W2'den baÅŸla
            }
            const dayOfWeek = (d.getDay() + 6) % 7;
            const target = new Date(d.getTime() - dayOfWeek * 86400000);
            
            const jan4 = new Date(target.getFullYear(), 0, 4);
            const jan4DayOfWeek = (jan4.getDay() + 6) % 7;
            const firstWeekStart = new Date(jan4.getTime() - jan4DayOfWeek * 86400000);
            
            const weekNumber = Math.floor((target.getTime() - firstWeekStart.getTime()) / (7 * 86400000)) + 1;
            return Math.max(1, weekNumber);
        }
        function getMonthWeeks(year, month) {
            const weeks = [];
            
            const yearStart = new Date(year, 0, 1);
            const yearEnd = new Date(year, 11, 31);
            
            let weekNumber = 1;
            let currentWeekStart = new Date(year, 0, 1);
            
            // Ocak ayÄ± W1 iÃ§in Ã¶zel durum
            if (month === 1) {
                // Ocak W1: OcaÄŸÄ±n ilk gÃ¼nÃ¼nden o haftanÄ±n sonuna kadar
                const firstDay = new Date(year, 0, 1); // 1 Ocak
                const firstDayOfWeek = (firstDay.getDay() + 6) % 7; // Pazartesi = 0
                const firstWeekEnd = new Date(firstDay.getTime() + (6 - firstDayOfWeek) * 86400000);
                
                const startDay = String(firstDay.getDate()).padStart(2, '0');
                const endDay = String(firstWeekEnd.getDate()).padStart(2, '0');
                const shortRange = `(${startDay}-${endDay})`;
                
                weeks.push({
                    weekNum: `W1`,
                    startDate: firstDay.toLocaleDateString('tr-TR'),
                    endDate: firstWeekEnd.toLocaleDateString('tr-TR'),
                    range: `${firstDay.toLocaleDateString('tr-TR')} - ${firstWeekEnd.toLocaleDateString('tr-TR')}`,
                    shortRange: shortRange,
                    weekNumber: 1
                });
                
                // W2'den itibaren normal hesaplama
                currentWeekStart = new Date(firstWeekEnd.getTime() + 86400000); // Ertesi gÃ¼n
                weekNumber = 2;
            } else {
                // DiÄŸer aylar iÃ§in normal hesaplama
                const firstDayOfWeek = (currentWeekStart.getDay() + 6) % 7; // Pazartesi = 0
                currentWeekStart.setDate(currentWeekStart.getDate() - firstDayOfWeek);
            }
            
            while (currentWeekStart <= yearEnd) {
                const weekEnd = new Date(currentWeekStart.getTime() + 6 * 86400000);
                const monthDayCounts = {};
                
                // HaftanÄ±n her gÃ¼nÃ¼ iÃ§in ay sayÄ±mÄ± (baÅŸlangÄ±Ã§ ve bitiÅŸ dahil)
                for (let d = new Date(currentWeekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                    const monthIndex = d.getMonth() + 1; // 1-12
                    monthDayCounts[monthIndex] = (monthDayCounts[monthIndex] || 0) + 1;
                }
                
                let maxDays = 0;
                let majorityMonth = null;
                
                Object.entries(monthDayCounts).forEach(([monthKey, dayCount]) => {
                    if (dayCount > maxDays) {
                        maxDays = dayCount;
                        majorityMonth = parseInt(monthKey);
                    }
                });
                
                if (majorityMonth === month && weekNumber <= 52) {
                    const startDay = String(currentWeekStart.getDate()).padStart(2, '0');
                    const endDay = String(weekEnd.getDate()).padStart(2, '0');
                    const shortRange = `(${startDay}-${endDay})`;
                    
                    weeks.push({
                        weekNum: `W${weekNumber}`,
                        startDate: currentWeekStart.toLocaleDateString('tr-TR'),
                        endDate: weekEnd.toLocaleDateString('tr-TR'),
                        range: `${currentWeekStart.toLocaleDateString('tr-TR')} - ${weekEnd.toLocaleDateString('tr-TR')}`,
                        shortRange: shortRange,
                        weekNumber: weekNumber
                    });
                }
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                weekNumber++;
            }
            return weeks;
        }
        function calculateDizilmesiGerekenAdet(fullProductName, netSure) {
            // ÃœrÃ¼n adÄ±ndan referans tablosundaki key'i bul
            let referansKey = null;
            let referansSure = 0;
            let referansDizilenAdet = 0;
            
            console.log('Dizilmesi Gereken - Aranan Ã¼rÃ¼n:', fullProductName); // Debug iÃ§in
            
            // Ã–nce tam eÅŸleÅŸme ara
            if (referansTablosu[fullProductName]) {
                referansKey = fullProductName;
                referansSure = referansTablosu[referansKey].sure;
                referansDizilenAdet = referansTablosu[referansKey].dizilenAdet;
            } else {
                // EÄŸer tam eÅŸleÅŸme yoksa, benzer eÅŸleÅŸme ara
                const productUpper = fullProductName.toUpperCase();
                
                for (const key of Object.keys(referansTablosu)) {
                    const keyUpper = key.toUpperCase();
                    
                    // Daha esnek eÅŸleÅŸme - parÃ§alÄ± eÅŸleÅŸme
                    if (productUpper.includes('SVC') && keyUpper.includes('SVC')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    } else if (productUpper.includes('DMS') && keyUpper.includes('DMS')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    } else if (productUpper.includes('TOFAÅ') && keyUpper.includes('TOFAÅ')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    } else if (productUpper.includes('FORD') && keyUpper.includes('FORD')) {
                        if (productUpper.includes('BOT') && keyUpper.includes('BOT')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        } else if (productUpper.includes('TOP') && keyUpper.includes('TOP')) {
                            referansKey = key;
                            referansSure = referansTablosu[key].sure;
                            referansDizilenAdet = referansTablosu[key].dizilenAdet;
                            break;
                        }
                    }
                }
            }
            
            if (!referansKey || referansSure === 0 || referansDizilenAdet === 0) {
                console.log('Dizilmesi Gereken - Referans bulunamadÄ±'); // Debug iÃ§in
                return '-'; // Referans bulunamadÄ±
            }
            const productUpper = fullProductName.toUpperCase();
            let carpan = 1;
            if (productUpper.includes('SVC')) {
                carpan = 21;
            } else if (productUpper.includes('DMS')) {
                carpan = 12;
            } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                carpan = 25;
            } else if (productUpper.includes('FORD')) {
                carpan = 25; // FORD iÃ§in varsayÄ±lan deÄŸer
            }
            // FormÃ¼l: ((net sÃ¼re*60)/Ã¼rÃ¼ne ait referans sÃ¼re)*Ã¼rÃ¼ne ait referans dizilen adet*(21/12/25)
            const netSureSaniye = netSure * 60; // Dakikadan saniyeye Ã§evir
            const dizilmesiGereken = Math.round((netSureSaniye / referansSure) * referansDizilenAdet * carpan);
            
            console.log(`Dizilmesi Gereken Hesaplama: ((${netSure}*60)/${referansSure})*${referansDizilenAdet}*${carpan} = ${dizilmesiGereken}`); // Debug iÃ§in
            
            return dizilmesiGereken;
        }
        function createProsesAnalysisTable(tableBodyId, yilFiltresiElement, columnCount, prosesFilters = []) {
            if (!allSuccessRows.length) {
                document.getElementById(tableBodyId).innerHTML = `<tr><td colspan="${columnCount}" style="text-align:center;padding:20px;color:#666;">Veri yÃ¼klenmedi</td></tr>`;
                return;
            }
            const secilenYil = yilFiltresiElement.value || new Date().getFullYear();
            const aylar = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 
                        'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            const ayRenkleri = [
                '#fef3f3', '#f0f9ff', '#f0fdf4', '#fffbeb', '#fdf4ff', '#fff1f2',
                '#f0fdfa', '#fefce8', '#f8fafc', '#fdf2f8', '#ecfeff', '#faf5ff'
            ];
            const dateColIndex = currentHeader.findIndex(h => 
                norm(h).includes('tarih') || norm(h).includes('date')
            );
            const urunAdiIndex = findColIndex(currentHeader, ['urun', 'adi']);
            const prosesAdiIndex = findColIndex(currentHeader, ['proses', 'adi']);
            const okIndex = findColIndex(currentHeader, ['ok']);
            const nokIndex = findColIndex(currentHeader, ['hata', 'kod']);
            const baslamaSaatIndex = findColIndex(currentHeader, ['baslama', 'saat']);
            const bitisSaatIndex = findColIndex(currentHeader, ['bitis', 'saat']);
            const durusSureleriIndex = findColIndex(currentHeader, ['durus', 'sureleri']);
            
            if (dateColIndex < 0 || prosesAdiIndex < 0) {
                document.getElementById(tableBodyId).innerHTML = `<tr><td colspan="${columnCount}" style="text-align:center;padding:20px;color:#666;">Gerekli sÃ¼tunlar bulunamadÄ±</td></tr>`;
                return;
            }
            
            const filteredData = allSuccessRows.filter(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                return dateParts.length === 3 && dateParts[2] === String(secilenYil);
            });
            
            // Proses filtresi uygula (sadece prosesFilters varsa)
            const prosesData = prosesFilters.length > 0 ? 
                filteredData.filter(row => {
                    const prosesAdi = String(row[prosesAdiIndex] || '').toLowerCase();
                    return prosesFilters.some(filter => prosesAdi.includes(filter.toLowerCase()));
                }) : filteredData;
            
            const weeklyData = {};
            
            prosesData.forEach(row => {
                const cellDate = String(row[dateColIndex] || '').trim();
                const dateParts = cellDate.split('.');
                if (dateParts.length !== 3) return;
                    
                const tarih = new Date(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0]));
                const ay = tarih.getMonth() + 1;
                
                // *** Hafta kontrolÃ¼nÃ¼ deÄŸiÅŸtir - doÄŸrudan aralÄ±k kontrolÃ¼ yap ***
                const weeks = getMonthWeeks(parseInt(secilenYil), ay);
                let matchedWeek = null;
                
                // Tarih hangi hafta aralÄ±ÄŸÄ±na giriyor?
                for (const week of weeks) {
                    const weekStartParts = week.startDate.split('.');
                    const weekEndParts = week.endDate.split('.');
                    
                    const weekStart = new Date(
                        parseInt(weekStartParts[2]), 
                        parseInt(weekStartParts[1]) - 1, 
                        parseInt(weekStartParts[0])
                    );
                    const weekEnd = new Date(
                        parseInt(weekEndParts[2]), 
                        parseInt(weekEndParts[1]) - 1, 
                        parseInt(weekEndParts[0])
                    );
                    
                    // Tarih hafta aralÄ±ÄŸÄ±nda mÄ±? (baÅŸlangÄ±Ã§ ve bitiÅŸ dahil)
                    if (tarih >= weekStart && tarih <= weekEnd) {
                        matchedWeek = week;
                        break;
                    }
                }
                
                if (!matchedWeek) {
                    console.log(`Tarih ${cellDate} hiÃ§bir hafta aralÄ±ÄŸÄ±na girmiyor (Ay: ${ay})`);
                    return; // Bu tarih hiÃ§bir hafta aralÄ±ÄŸÄ±na girmiyor
                }
                
                console.log(`Tarih ${cellDate} â†’ ${matchedWeek.weekNum} ${matchedWeek.shortRange} aralÄ±ÄŸÄ±na giriyor`);
                    
                const urunAdi = String(row[urunAdiIndex] || '');
                const prosesAdi = String(row[prosesAdiIndex] || '');
                const okUrun = parseInt(row[okIndex]) || 0;
                
                // ... geri kalan kod aynÄ± kalacak ...
                
                const weekKey = `${ay}-${matchedWeek.weekNumber}`;
                const productKey = urunAdiIndex >= 0 ? `${urunAdi}-${prosesAdi}` : prosesAdi;
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        ay: ay,
                        weekNumber: matchedWeek.weekNumber,
                        products: {}
                    };
                }
                
                let nokUrun = 0;
                if (nokIndex >= 0) {
                    const hataKodlariText = row[nokIndex] || '';
                    const hataMap = parseHataKodlari(hataKodlariText);
                    nokUrun = Object.values(hataMap).reduce((toplam, adet) => toplam + adet, 0);
                }
                
                // SÃ¼re hesaplamasÄ±
                const startTime = row[baslamaSaatIndex] || '';
                const endTime = row[bitisSaatIndex] || '';
                const workingTime = calculateWorkingTime(startTime, endTime);
                
                // DuruÅŸ hesaplamalarÄ±
                const durusSureleriText = row[durusSureleriIndex] || '';
                const durusMap = parseDurusSureleri(durusSureleriText);
                
                // DuruÅŸ kodlarÄ±na gÃ¶re sÃ¼releri hesapla
                const kurulumSuresi = durusMap['D4'] || 0;
                const makinaArizasi = durusMap['D17'] || 0;
                const personelDurus = durusMap['D19'] || 0;
                const planliDurus = (durusMap['D12'] || 0) + (durusMap['D13'] || 0) + (durusMap['D18'] || 0) + (durusMap['D21'] || 0);
                const plansizDurus = (durusMap['D0'] || 0) + (durusMap['D1'] || 0) + (durusMap['D2'] || 0) + 
                                    (durusMap['D3'] || 0) + (durusMap['D5'] || 0) + (durusMap['D6'] || 0) + 
                                    (durusMap['D7'] || 0) + (durusMap['D8'] || 0) + (durusMap['D10'] || 0) + 
                                    (durusMap['D14'] || 0) + (durusMap['D15'] || 0) + (durusMap['D16'] || 0) + 
                                    (durusMap['D19'] || 0) + (durusMap['D20'] || 0) + (durusMap['D22'] || 0) + 
                                    (durusMap['D23'] || 0) + (durusMap['D24'] || 0);
                const makineProgramDurus = (durusMap['D9'] || 0) + (durusMap['D11'] || 0);
                const toplamDurus = kurulumSuresi + makinaArizasi + planliDurus + plansizDurus + makineProgramDurus;
                const netSure = workingTime.totalMinutes - toplamDurus;
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        ay: ay,
                        weekNumber: weekNumber,
                        products: {}
                    };
                }
                
                if (!weeklyData[weekKey].products[productKey]) {
                    weeklyData[weekKey].products[productKey] = {
                        urunAdi: urunAdi,
                        prosesAdi: prosesAdi,
                        okUrun: 0,
                        nokUrun: 0,
                        toplamUrun: 0,
                        toplamSure: 0,
                        netSure: 0,
                        toplamDurus: 0,
                        plansizDurus: 0,
                        planliDurus: 0,
                        personelDurus: 0,
                        makinaArizasi: 0,
                        setupSuresi: 0,
                        makineProgramDurus: 0,
                        arizaSuresi: 0
                    };
                }
                
                const product = weeklyData[weekKey].products[productKey];
                product.okUrun += okUrun;
                product.nokUrun += nokUrun;
                product.toplamUrun += (okUrun + nokUrun);
                product.toplamSure += workingTime.totalMinutes;
                product.netSure += netSure;
                product.toplamDurus += toplamDurus;
                product.plansizDurus += plansizDurus;
                product.planliDurus += planliDurus;
                product.personelDurus += personelDurus;
                product.makinaArizasi += makinaArizasi;
                product.setupSuresi += kurulumSuresi;
                product.makineProgramDurus += makineProgramDurus;
                product.arizaSuresi += makinaArizasi;
            });
            
            let tbody = '';
            
            for (let ay = 1; ay <= 12; ay++) {
                const weeks = getMonthWeeks(parseInt(secilenYil), ay);
                const ayRengi = ayRenkleri[ay - 1];
                
                if (weeks.length === 0) continue;
                
                let ayRowspanTotal = 0;
                let ayWeeksData = [];
                
                weeks.forEach(week => {
                    const weekKey = `${ay}-${week.weekNumber}`;
                    const weekData = weeklyData[weekKey];
                    
                    if (weekData && Object.keys(weekData.products).length > 0) {
                        // Sadece deÄŸeri 0'dan bÃ¼yÃ¼k olan Ã¼rÃ¼nleri filtrele
                        const validProducts = Object.values(weekData.products).filter(product => 
                            product.okUrun > 0 || product.nokUrun > 0
                        );
                        
                        if (validProducts.length > 0) {
                            ayRowspanTotal += validProducts.length;
                            ayWeeksData.push({
                                week: week,
                                weekData: { ...weekData, products: validProducts },
                                productCount: validProducts.length
                            });
                        }
                    }
                });
                
                if (ayRowspanTotal === 0) continue;
                
                let ayFirstRow = true;
                
                ayWeeksData.forEach((weekInfo, weekIndex) => {
                    const { week, weekData, productCount } = weekInfo;
                    
                    if (weekData && weekData.products && weekData.products.length > 0) {
                        const products = weekData.products;
                        
                        products.forEach((product, productIndex) => {
                            const isFirstProductOfWeek = productIndex === 0;
                            const weekRowspan = productCount;
                            
                            tbody += `<tr style="background-color:${ayRengi};">`;
                            
                            if (ayFirstRow) {
                                tbody += `<td rowspan="${ayRowspanTotal}" style="padding:4px;border:1px solid #e5e7eb;text-align:center;background:${ayRengi};font-weight:600;vertical-align:middle;border-left:4px solid ${getDarkerColor(ayRengi)};">${aylar[ay-1]}</td>`;
                                ayFirstRow = false;
                            }
                            if (isFirstProductOfWeek) {
                                tbody += `<td rowspan="${weekRowspan}" style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;white-space:nowrap;vertical-align:middle;">${week.weekNum} ${week.shortRange}</td>`;
                            }
                            
                            if (tableBodyId === 'smdAnalyzBody') {
                                // SMD Tablosu - ÃœrÃ¼n adÄ± ve proses adÄ±nÄ± birleÅŸtir
                                const fullProductName = product.prosesAdi ? `${product.urunAdi} - ${product.prosesAdi}` : product.urunAdi;
                                const dizilenAdet = product.okUrun; // Toplam Ã¼retilen
                                const fire = product.nokUrun; // Fire = NOK Ã¼rÃ¼n
                                const dizilenKompanent = calculateDizilenKompanent(fullProductName, dizilenAdet, fire);
                                
                                // Dizilmesi Gereken Adet hesaplamasÄ±
                                const dizilmesiGerekenAdet = calculateDizilmesiGerekenAdet(fullProductName, product.netSure);
                                
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;font-weight:500;">${esc(fullProductName)}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${dizilenAdet}</td>`; // Dizilen Adet (OK + NOK)
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${fire}</td>`; // Fire (NOK)
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${dizilenKompanent}</td>`; // Dizilen Kompanent
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#7c3aed;">${dizilmesiGerekenAdet}</td>`; // Dizilmesi Gereken Adet âœ…
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.toplamSure} dk</td>`; // Toplam SÃ¼re
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.netSure} dk</td>`; // Net SÃ¼re
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.toplamDurus} dk</td>`; // Toplam DuruÅŸ
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.plansizDurus} dk</td>`; // PlansÄ±z DuruÅŸ
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.planliDurus} dk</td>`; // PlanlÄ± DuruÅŸ
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.personelDurus} dk</td>`; // Personel DuruÅŸu
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.makineProgramDurus} dk</td>`; // Makina/Program AyarÄ±
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.setupSuresi} dk</td>`; // Setup
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.makinaArizasi} dk</td>`; // Makina ArÄ±zasÄ±
                                
                                if (productIndex === 0 && weekIndex === 0) {
                                    const darkerColor = getDarkerColor(ayRengi);
                                    const cellStyle = `
                                        padding:4px;
                                        border:1px solid #e5e7eb;
                                        text-align:center;
                                        font-weight:700;
                                        color:#000000;
                                        font-size:12px;
                                        background:${ayRengi};
                                        vertical-align:middle;
                                        border-left:3px solid ${darkerColor};
                                        box-shadow: inset 2px 0 4px rgba(0,0,0,0.05);
                                        line-height: 1.3;
                                    `;
                                    
                                    // AylÄ±k Dizilen (17. sÃ¼tun) - Bu ayÄ±n tÃ¼m Dizilen Kompanent + Fire toplamÄ±
                                    let aylikToplamDizilen = 0;
                                    let dmsAylikDizilen = 0;
                                    let svcAylikDizilen = 0;
                                    let tofasAylikDizilen = 0;
                                    let fordAylikDizilen = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                const dizilenAdet = prod.okUrun; // Toplam Ã¼retilen
                                                const fire = prod.nokUrun; // Fire = NOK Ã¼rÃ¼n
                                                const dizilenKompanent = calculateDizilenKompanent(productName, dizilenAdet, fire);
                                                
                                                // Dizilen Kompanent sayÄ±sal deÄŸer ise hesapla, deÄŸilse 0
                                                const dizilenKompanentSayi = (typeof dizilenKompanent === 'number') ? dizilenKompanent : 0;
                                                const toplamDizilen = dizilenKompanentSayi + fire; // Dizilen Kompanent + Fire
                                                
                                                aylikToplamDizilen += toplamDizilen;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikDizilen += toplamDizilen;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikDizilen += toplamDizilen;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikDizilen += toplamDizilen;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikDizilen += toplamDizilen;
                                                }
                                            });
                                        }
                                    });
                                    
                                    // Alt satÄ±rda gÃ¶sterilecek markalarÄ± filtrele (sadece 0'dan bÃ¼yÃ¼k olanlar)
                                    const markaDetaylar = [];
                                    if (dmsAylikDizilen > 0) markaDetaylar.push(`DMS: ${dmsAylikDizilen}`);
                                    if (svcAylikDizilen > 0) markaDetaylar.push(`SVC: ${svcAylikDizilen}`);
                                    if (tofasAylikDizilen > 0) markaDetaylar.push(`TOFAÅ: ${tofasAylikDizilen}`);
                                    if (fordAylikDizilen > 0) markaDetaylar.push(`FORD: ${fordAylikDizilen}`);
                                    
                                    const markaDetayText = markaDetaylar.length > 0 ?
                                        markaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamDizilen}${markaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${markaDetayText}</span>` : ''}</td>`;
                                    
                                    let aylikToplamDizilmesiGereken = 0;
                                    let dmsAylikDizilmesiGereken = 0;
                                    let svcAylikDizilmesiGereken = 0;
                                    let tofasAylikDizilmesiGereken = 0;
                                    let fordAylikDizilmesiGereken = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // Dizilmesi Gereken hesaplama
                                                const dizilmesiGereken = calculateDizilmesiGerekenAdet(productName, prod.netSure);
                                                const dizilmesiGerekenSayi = (typeof dizilmesiGereken === 'number') ? dizilmesiGereken : 0;
                                                
                                                aylikToplamDizilmesiGereken += dizilmesiGerekenSayi;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikDizilmesiGereken += dizilmesiGerekenSayi;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikDizilmesiGereken += dizilmesiGerekenSayi;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikDizilmesiGereken += dizilmesiGerekenSayi;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikDizilmesiGereken += dizilmesiGerekenSayi;
                                                }
                                            });
                                        }
                                    });
                                    
                                    // Dizilmesi gereken iÃ§in markalarÄ± filtrele (sadece 0'dan bÃ¼yÃ¼k olanlar)
                                    const dizilmesiGerekenMarkaDetaylar = [];
                                    if (dmsAylikDizilmesiGereken > 0) dizilmesiGerekenMarkaDetaylar.push(`DMS: ${dmsAylikDizilmesiGereken}`);
                                    if (svcAylikDizilmesiGereken > 0) dizilmesiGerekenMarkaDetaylar.push(`SVC: ${svcAylikDizilmesiGereken}`);
                                    if (tofasAylikDizilmesiGereken > 0) dizilmesiGerekenMarkaDetaylar.push(`TOFAÅ: ${tofasAylikDizilmesiGereken}`);
                                    if (fordAylikDizilmesiGereken > 0) dizilmesiGerekenMarkaDetaylar.push(`FORD: ${fordAylikDizilmesiGereken}`);
                                    
                                    const dizilmesiGerekenMarkaDetayText = dizilmesiGerekenMarkaDetaylar.length > 0 ? 
                                        dizilmesiGerekenMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamDizilmesiGereken}${dizilmesiGerekenMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${dizilmesiGerekenMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    // AylÄ±k Fire (19. sÃ¼tun) - Bu ayÄ±n tÃ¼m Fire deÄŸerlerinin toplamÄ±
                                    let aylikToplamFire = 0;
                                    let dmsAylikFire = 0;
                                    let svcAylikFire = 0;
                                    let tofasAylikFire = 0;
                                    let fordAylikFire = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // Fire = NOK Ã¼rÃ¼n sayÄ±sÄ±
                                                const fire = prod.nokUrun;
                                                aylikToplamFire += fire;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikFire += fire;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikFire += fire;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikFire += fire;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikFire += fire;
                                                }
                                            });
                                        }
                                    });
                                    const fireMarkaDetaylar = [];
                                    if (dmsAylikFire > 0) fireMarkaDetaylar.push(`DMS: ${dmsAylikFire}`);
                                    if (svcAylikFire > 0) fireMarkaDetaylar.push(`SVC: ${svcAylikFire}`);
                                    if (tofasAylikFire > 0) fireMarkaDetaylar.push(`TOFAÅ: ${tofasAylikFire}`);
                                    if (fordAylikFire > 0) fireMarkaDetaylar.push(`FORD: ${fordAylikFire}`);
                                    
                                    const fireMarkaDetayText = fireMarkaDetaylar.length > 0 ? 
                                        fireMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamFire}${fireMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${fireMarkaDetayText}</span>` : ''}</td>`;
                    
                                    let aylikToplamNetSure = 0;
                                    let aylikToplamSure = 0;
                                    let dmsNetCalisma = 0;
                                    let svcNetCalisma = 0;
                                    let tofasNetCalisma = 0;
                                    let fordNetCalisma = 0;
                                    let dmsToplamSure = 0;
                                    let svcToplamSure = 0;
                                    let tofasToplamSure = 0;
                                    let fordToplamSure = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamNetSure += prod.netSure;
                                                aylikToplamSure += prod.toplamSure;
                                                
                                                if (productUpper.includes('DMS')) {
                                                    dmsNetCalisma += prod.netSure;
                                                    dmsToplamSure += prod.toplamSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcNetCalisma += prod.netSure;
                                                    svcToplamSure += prod.toplamSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasNetCalisma += prod.netSure;
                                                    tofasToplamSure += prod.toplamSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordNetCalisma += prod.netSure;
                                                    fordToplamSure += prod.toplamSure;
                                                }
                                            });
                                        }
                                    });
                                    const netCalismaYuzdesi = aylikToplamSure > 0 ? 
                                        ((aylikToplamNetSure / aylikToplamSure) * 100).toFixed(1) : '0.0';
                                    
                                    const netCalismaMarkaDetaylar = [];
                                    if (dmsToplamSure > 0) {
                                        const dmsYuzde = ((dmsNetCalisma / dmsToplamSure) * 100).toFixed(1);
                                        netCalismaMarkaDetaylar.push(`DMS: ${dmsYuzde}%`);
                                    }
                                    if (svcToplamSure > 0) {
                                        const svcYuzde = ((svcNetCalisma / svcToplamSure) * 100).toFixed(1);
                                        netCalismaMarkaDetaylar.push(`SVC: ${svcYuzde}%`);
                                    }
                                    if (tofasToplamSure > 0) {
                                        const tofasYuzde = ((tofasNetCalisma / tofasToplamSure) * 100).toFixed(1);
                                        netCalismaMarkaDetaylar.push(`TOFAÅ: ${tofasYuzde}%`);
                                    }
                                    if (fordToplamSure > 0) {
                                        const fordYuzde = ((fordNetCalisma / fordToplamSure) * 100).toFixed(1);
                                        netCalismaMarkaDetaylar.push(`FORD: ${fordYuzde}%`);
                                    }
                                    const netCalismaMarkaDetayText = netCalismaMarkaDetaylar.length > 0 ? 
                                        netCalismaMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${netCalismaYuzdesi}%${netCalismaMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${netCalismaMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    const aylikCalismaPerformans = aylikToplamDizilmesiGereken > 0 ? 
                                        ((aylikToplamDizilen / aylikToplamDizilmesiGereken) * 100).toFixed(1) : '0.0';
                                    
                                    // Marka bazÄ±nda Ã§alÄ±ÅŸma performans hesaplama
                                    const calismaPerformansMarkaDetaylar = [];
                                    if (dmsAylikDizilmesiGereken > 0) {
                                        const dmsPerformans = ((dmsAylikDizilen / dmsAylikDizilmesiGereken) * 100).toFixed(1);
                                        calismaPerformansMarkaDetaylar.push(`DMS: ${dmsPerformans}%`);
                                    }
                                    if (svcAylikDizilmesiGereken > 0) {
                                        const svcPerformans = ((svcAylikDizilen / svcAylikDizilmesiGereken) * 100).toFixed(1);
                                        calismaPerformansMarkaDetaylar.push(`SVC: ${svcPerformans}%`);
                                    }
                                    if (tofasAylikDizilmesiGereken > 0) {
                                        const tofasPerformans = ((tofasAylikDizilen / tofasAylikDizilmesiGereken) * 100).toFixed(1);
                                        calismaPerformansMarkaDetaylar.push(`TOFAÅ: ${tofasPerformans}%`);
                                    }
                                    if (fordAylikDizilmesiGereken > 0) {
                                        const fordPerformans = ((fordAylikDizilen / fordAylikDizilmesiGereken) * 100).toFixed(1);
                                        calismaPerformansMarkaDetaylar.push(`FORD: ${fordPerformans}%`);
                                    }
                                    const calismaPerformansMarkaDetayText = calismaPerformansMarkaDetaylar.length > 0 ? 
                                        calismaPerformansMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikCalismaPerformans}%${calismaPerformansMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${calismaPerformansMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    const aylikFireOraniDecimal = aylikToplamDizilen > 0 ? 
                                        (aylikToplamFire / aylikToplamDizilen) : 0;
                                    const istasyonKaliteOrani = ((1 - aylikFireOraniDecimal) * 100).toFixed(2);
                                    
                                    // Marka bazÄ±nda istasyon kalite oranlarÄ± - alt alta gÃ¶sterim
                                    const istasyonKaliteMarkaDetaylar = [];
                                    if (dmsAylikDizilen > 0) {
                                        const dmsFireOraniDecimal = dmsAylikFire / dmsAylikDizilen;
                                        const dmsIstasyonKalite = ((1 - dmsFireOraniDecimal) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`DMS: ${dmsIstasyonKalite}%`);
                                    }
                                    if (svcAylikDizilen > 0) {
                                        const svcFireOraniDecimal = svcAylikFire / svcAylikDizilen;
                                        const svcIstasyonKalite = ((1 - svcFireOraniDecimal) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`SVC: ${svcIstasyonKalite}%`);
                                    }
                                    if (tofasAylikDizilen > 0) {
                                        const tofasFireOraniDecimal = tofasAylikFire / tofasAylikDizilen;
                                        const tofasIstasyonKalite = ((1 - tofasFireOraniDecimal) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`TOFAÅ: ${tofasIstasyonKalite}%`);
                                    }
                                    if (fordAylikDizilen > 0) {
                                        const fordFireOraniDecimal = fordAylikFire / fordAylikDizilen;
                                        const fordIstasyonKalite = ((1 - fordFireOraniDecimal) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`FORD: ${fordIstasyonKalite}%`);
                                    }
                                    
                                    // Alt alta gÃ¶sterim iÃ§in <br> ile ayÄ±r
                                    const istasyonKaliteMarkaDetayText = istasyonKaliteMarkaDetaylar.length > 0 ? 
                                        istasyonKaliteMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${istasyonKaliteOrani}%${istasyonKaliteMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${istasyonKaliteMarkaDetayText}</span>` : ''}</td>`;

                                    let aylikToplamSetupSuresi = 0;
                                    let aylikToplamNetSureSetup = 0;
                                    let dmsSetupSuresi = 0;
                                    let svcSetupSuresi = 0;
                                    let tofasSetupSuresi = 0;
                                    let fordSetupSuresi = 0;
                                    let dmsNetSureSetup = 0;
                                    let svcNetSureSetup = 0;
                                    let tofasNetSureSetup = 0;
                                    let fordNetSureSetup = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamSetupSuresi += prod.setupSuresi;
                                                aylikToplamNetSureSetup += prod.netSure;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsSetupSuresi += prod.setupSuresi;
                                                    dmsNetSureSetup += prod.netSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcSetupSuresi += prod.setupSuresi;
                                                    svcNetSureSetup += prod.netSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasSetupSuresi += prod.setupSuresi;
                                                    tofasNetSureSetup += prod.netSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordSetupSuresi += prod.setupSuresi;
                                                    fordNetSureSetup += prod.netSure;
                                                }
                                            });
                                        }
                                    });
                                    
                                    // Setup oranÄ± hesaplama
                                    const setupOraniYuzdesi = aylikToplamNetSureSetup > 0 ? 
                                        ((aylikToplamSetupSuresi / aylikToplamNetSureSetup) * 100).toFixed(1) : '0.0';
                                    
                                    // Marka bazÄ±nda setup oranlarÄ± - alt alta gÃ¶sterim
                                    const setupMarkaDetaylar = [];
                                    if (dmsNetSureSetup > 0) {
                                        const dmsSetupYuzde = ((dmsSetupSuresi / dmsNetSureSetup) * 100).toFixed(1);
                                        setupMarkaDetaylar.push(`DMS: ${dmsSetupYuzde}%`);
                                    }
                                    if (svcNetSureSetup > 0) {
                                        const svcSetupYuzde = ((svcSetupSuresi / svcNetSureSetup) * 100).toFixed(1);
                                        setupMarkaDetaylar.push(`SVC: ${svcSetupYuzde}%`);
                                    }
                                    if (tofasNetSureSetup > 0) {
                                        const tofasSetupYuzde = ((tofasSetupSuresi / tofasNetSureSetup) * 100).toFixed(1);
                                        setupMarkaDetaylar.push(`TOFAÅ: ${tofasSetupYuzde}%`);
                                    }
                                    if (fordNetSureSetup > 0) {
                                        const fordSetupYuzde = ((fordSetupSuresi / fordNetSureSetup) * 100).toFixed(1);
                                        setupMarkaDetaylar.push(`FORD: ${fordSetupYuzde}%`);
                                    }
                                    
                                    // Alt alta gÃ¶sterim iÃ§in <br> ile ayÄ±r
                                    const setupMarkaDetayText = setupMarkaDetaylar.length > 0 ? 
                                        setupMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${setupOraniYuzdesi}%${setupMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${setupMarkaDetayText}</span>` : ''}</td>`;
                                    let aylikToplamArizaSuresi = 0;
                                    let aylikToplamSureAriza = 0;
                                    let dmsArizaSuresi = 0;
                                    let svcArizaSuresi = 0;
                                    let tofasArizaSuresi = 0;
                                    let fordArizaSuresi = 0;
                                    let dmsToplamSureAriza = 0;
                                    let svcToplamSureAriza = 0;
                                    let tofasToplamSureAriza = 0;
                                    let fordToplamSureAriza = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamArizaSuresi += prod.makinaArizasi;
                                                aylikToplamSureAriza += prod.toplamSure;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsArizaSuresi += prod.makinaArizasi;
                                                    dmsToplamSureAriza += prod.toplamSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcArizaSuresi += prod.makinaArizasi;
                                                    svcToplamSureAriza += prod.toplamSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasArizaSuresi += prod.makinaArizasi;
                                                    tofasToplamSureAriza += prod.toplamSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordArizaSuresi += prod.makinaArizasi;
                                                    fordToplamSureAriza += prod.toplamSure;
                                                }
                                            });
                                        }
                                    });
                                    
                                    // ArÄ±za duruÅŸu oranÄ± hesaplama
                                    const arizaOraniYuzdesi = aylikToplamSureAriza > 0 ? 
                                        ((aylikToplamArizaSuresi / aylikToplamSureAriza) * 100).toFixed(3) : '0.0';
                                    
                                    // Marka bazÄ±nda arÄ±za duruÅŸu oranlarÄ± - alt alta gÃ¶sterim
                                    const arizaMarkaDetaylar = [];
                                    if (dmsToplamSureAriza > 0) {
                                        const dmsArizaYuzde = ((dmsArizaSuresi / dmsToplamSureAriza) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`DMS: ${dmsArizaYuzde}%`);
                                    }
                                    if (svcToplamSureAriza > 0) {
                                        const svcArizaYuzde = ((svcArizaSuresi / svcToplamSureAriza) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`SVC: ${svcArizaYuzde}%`);
                                    }
                                    if (tofasToplamSureAriza > 0) {
                                        const tofasArizaYuzde = ((tofasArizaSuresi / tofasToplamSureAriza) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`TOFAÅ: ${tofasArizaYuzde}%`);
                                    }
                                    if (fordToplamSureAriza > 0) {
                                        const fordArizaYuzde = ((fordArizaSuresi / fordToplamSureAriza) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`FORD: ${fordArizaYuzde}%`);
                                    }
                                    const arizaMarkaDetayText = arizaMarkaDetaylar.length > 0 ? 
                                        arizaMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${arizaOraniYuzdesi}%${arizaMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${arizaMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    const aylikFireOrani = aylikToplamDizilen > 0 ? 
                                        ((aylikToplamFire / aylikToplamDizilen) * 100).toFixed(3) : '0.0';
                                    const fireOraniMarkaDetaylar = [];
                                    if (dmsAylikDizilen > 0) {
                                        const dmsFireOrani = ((dmsAylikFire / dmsAylikDizilen) * 100).toFixed(3);
                                        fireOraniMarkaDetaylar.push(`DMS: ${dmsFireOrani}%`);
                                    }
                                    if (svcAylikDizilen > 0) {
                                        const svcFireOrani = ((svcAylikFire / svcAylikDizilen) * 100).toFixed(3);
                                        fireOraniMarkaDetaylar.push(`SVC: ${svcFireOrani}%`);
                                    }
                                    if (tofasAylikDizilen > 0) {
                                        const tofasFireOrani = ((tofasAylikFire / tofasAylikDizilen) * 100).toFixed(3);
                                        fireOraniMarkaDetaylar.push(`TOFAÅ: ${tofasFireOrani}%`);
                                    }
                                    if (fordAylikDizilen > 0) {
                                        const fordFireOrani = ((fordAylikFire / fordAylikDizilen) * 100).toFixed(3);
                                        fireOraniMarkaDetaylar.push(`FORD: ${fordFireOrani}%`);
                                    }
                                    const fireOraniMarkaDetayText = fireOraniMarkaDetaylar.length > 0 ? 
                                        fireOraniMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikFireOrani}%${fireOraniMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${fireOraniMarkaDetayText}</span>` : ''}</td>`;
                                }
                            } else if (tableBodyId === 'lensAnalyzBody') {
                                // LENS AA Tablosu - ÃœrÃ¼n adÄ± ve proses adÄ±nÄ± birleÅŸtir
                                const fullProductName = product.prosesAdi ? `${product.urunAdi} - ${product.prosesAdi}` : product.urunAdi;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;font-weight:500;">${esc(fullProductName)}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${product.okUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${product.nokUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${product.toplamUrun}</td>`; // Makinaya Giren
                                const uretilmesiGerekenAdet = Math.round((product.toplamSure * 60) / 55);
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#7c3aed;">${uretilmesiGerekenAdet}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.toplamSure} dk</td>`; // Toplam SÃ¼re
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.netSure} dk</td>`; // Net SÃ¼re
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.toplamDurus} dk</td>`; // Toplam DuruÅŸ
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.plansizDurus} dk</td>`; // PlansÄ±z DuruÅŸ
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.planliDurus} dk</td>`; // PlanlÄ± DuruÅŸ
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.personelDurus} dk</td>`; // Personel DuruÅŸu
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.makinaArizasi} dk</td>`; // Makina ArÄ±zasÄ±
                                
                                // AylÄ±k bazda birleÅŸen sÃ¼tunlar - sadece ilk Ã¼rÃ¼n ve ilk haftada gÃ¶ster
                                if (productIndex === 0 && weekIndex === 0) {
                                    const darkerColor = getDarkerColor(ayRengi);
                                    const cellStyle = `
                                        padding:4px;
                                        border:1px solid #e5e7eb;
                                        text-align:center;
                                        font-weight:700;
                                        color:#000000;
                                        font-size:12px;
                                        background:${ayRengi};
                                        vertical-align:middle;
                                        border-left:3px solid ${darkerColor};
                                        box-shadow: inset 2px 0 4px rgba(0,0,0,0.05);
                                        line-height: 1.3;
                                    `;
                                    
                                    // AylÄ±k Toplam Ãœretilmesi Gereken (15. sÃ¼tun)
                                    let aylikToplamUretilmesiGereken = 0;
                                    let dmsAylikUretilmesiGereken = 0;
                                    let svcAylikUretilmesiGereken = 0;
                                    let tofasAylikUretilmesiGereken = 0;
                                    let fordAylikUretilmesiGereken = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // Ãœretilmesi Gereken hesaplama: (Toplam SÃ¼re * 60) / 55
                                                const uretilmesiGereken = Math.round((prod.toplamSure * 60) / 55);
                                                aylikToplamUretilmesiGereken += uretilmesiGereken;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikUretilmesiGereken += uretilmesiGereken;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikUretilmesiGereken += uretilmesiGereken;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikUretilmesiGereken += uretilmesiGereken;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikUretilmesiGereken += uretilmesiGereken;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const uretilmesiGerekenMarkaDetaylar = [];
                                    if (dmsAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`DMS: ${dmsAylikUretilmesiGereken}`);
                                    if (svcAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`SVC: ${svcAylikUretilmesiGereken}`);
                                    if (tofasAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`TOFAÅ: ${tofasAylikUretilmesiGereken}`);
                                    if (fordAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`FORD: ${fordAylikUretilmesiGereken}`);
                                    
                                    const uretilmesiGerekenMarkaDetayText = uretilmesiGerekenMarkaDetaylar.length > 0 ? 
                                        uretilmesiGerekenMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamUretilmesiGereken}${uretilmesiGerekenMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${uretilmesiGerekenMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    // AylÄ±k Toplam DuruÅŸ (16. sÃ¼tun)
                                    let aylikToplamDurus = 0;
                                    let dmsAylikToplamDurus = 0;
                                    let svcAylikToplamDurus = 0;
                                    let tofasAylikToplamDurus = 0;
                                    let fordAylikToplamDurus = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamDurus += prod.toplamDurus;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikToplamDurus += prod.toplamDurus;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikToplamDurus += prod.toplamDurus;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikToplamDurus += prod.toplamDurus;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikToplamDurus += prod.toplamDurus;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const toplamDurusMarkaDetaylar = [];
                                    if (dmsAylikToplamDurus > 0) toplamDurusMarkaDetaylar.push(`DMS: ${dmsAylikToplamDurus}`);
                                    if (svcAylikToplamDurus > 0) toplamDurusMarkaDetaylar.push(`SVC: ${svcAylikToplamDurus}`);
                                    if (tofasAylikToplamDurus > 0) toplamDurusMarkaDetaylar.push(`TOFAÅ: ${tofasAylikToplamDurus}`);
                                    if (fordAylikToplamDurus > 0) toplamDurusMarkaDetaylar.push(`FORD: ${fordAylikToplamDurus}`);
                                    
                                    const toplamDurusMarkaDetayText = toplamDurusMarkaDetaylar.length > 0 ? 
                                        toplamDurusMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamDurus} dk${toplamDurusMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${toplamDurusMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // AylÄ±k Toplam SÃ¼re (17. sÃ¼tun)
                                    let aylikToplamSure = 0;
                                    let dmsAylikToplamSure = 0;
                                    let svcAylikToplamSure = 0;
                                    let tofasAylikToplamSure = 0;
                                    let fordAylikToplamSure = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamSure += prod.toplamSure;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikToplamSure += prod.toplamSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikToplamSure += prod.toplamSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikToplamSure += prod.toplamSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikToplamSure += prod.toplamSure;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const toplamSureMarkaDetaylar = [];
                                    if (dmsAylikToplamSure > 0) toplamSureMarkaDetaylar.push(`DMS: ${dmsAylikToplamSure}`);
                                    if (svcAylikToplamSure > 0) toplamSureMarkaDetaylar.push(`SVC: ${svcAylikToplamSure}`);
                                    if (tofasAylikToplamSure > 0) toplamSureMarkaDetaylar.push(`TOFAÅ: ${tofasAylikToplamSure}`);
                                    if (fordAylikToplamSure > 0) toplamSureMarkaDetaylar.push(`FORD: ${fordAylikToplamSure}`);
                                    
                                    const toplamSureMarkaDetayText = toplamSureMarkaDetaylar.length > 0 ? 
                                        toplamSureMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamSure} dk${toplamSureMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${toplamSureMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // AylÄ±k Net SÃ¼re (18. sÃ¼tun)
                                    let aylikNetSure = 0;
                                    let dmsAylikNetSure = 0;
                                    let svcAylikNetSure = 0;
                                    let tofasAylikNetSure = 0;
                                    let fordAylikNetSure = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikNetSure += prod.netSure;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikNetSure += prod.netSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikNetSure += prod.netSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikNetSure += prod.netSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikNetSure += prod.netSure;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const netSureMarkaDetaylar = [];
                                    if (dmsAylikNetSure > 0) netSureMarkaDetaylar.push(`DMS: ${dmsAylikNetSure}`);
                                    if (svcAylikNetSure > 0) netSureMarkaDetaylar.push(`SVC: ${svcAylikNetSure}`);
                                    if (tofasAylikNetSure > 0) netSureMarkaDetaylar.push(`TOFAÅ: ${tofasAylikNetSure}`);
                                    if (fordAylikNetSure > 0) netSureMarkaDetaylar.push(`FORD: ${fordAylikNetSure}`);
                                    
                                    const netSureMarkaDetayText = netSureMarkaDetaylar.length > 0 ? 
                                        netSureMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikNetSure} dk${netSureMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${netSureMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // Net Ã‡alÄ±ÅŸma OranÄ± (19. sÃ¼tun)
                                    const netCalismaOrani = aylikToplamSure > 0 ? 
                                        ((aylikNetSure / aylikToplamSure) * 100).toFixed(2) : '0.00';
                                    
                                    const netCalismaOraniMarkaDetaylar = [];
                                    if (dmsAylikToplamSure > 0) {
                                        const dmsNetCalismaOrani = ((dmsAylikNetSure / dmsAylikToplamSure) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`DMS: ${dmsNetCalismaOrani}%`);
                                    }
                                    if (svcAylikToplamSure > 0) {
                                        const svcNetCalismaOrani = ((svcAylikNetSure / svcAylikToplamSure) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`SVC: ${svcNetCalismaOrani}%`);
                                    }
                                    if (tofasAylikToplamSure > 0) {
                                        const tofasNetCalismaOrani = ((tofasAylikNetSure / tofasAylikToplamSure) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`TOFAÅ: ${tofasNetCalismaOrani}%`);
                                    }
                                    if (fordAylikToplamSure > 0) {
                                        const fordNetCalismaOrani = ((fordAylikNetSure / fordAylikToplamSure) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`FORD: ${fordNetCalismaOrani}%`);
                                    }
                                    
                                    const netCalismaOraniMarkaDetayText = netCalismaOraniMarkaDetaylar.length > 0 ? 
                                        netCalismaOraniMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${netCalismaOrani}%${netCalismaOraniMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${netCalismaOraniMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    // ArÄ±za KaynaklÄ± DuruÅŸ OranÄ± (20. sÃ¼tun)
                                    let aylikMakinaArizasi = 0;
                                    let dmsAylikMakinaArizasi = 0;
                                    let svcAylikMakinaArizasi = 0;
                                    let tofasAylikMakinaArizasi = 0;
                                    let fordAylikMakinaArizasi = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikMakinaArizasi += prod.makinaArizasi;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikMakinaArizasi += prod.makinaArizasi;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikMakinaArizasi += prod.makinaArizasi;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikMakinaArizasi += prod.makinaArizasi;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikMakinaArizasi += prod.makinaArizasi;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const arizaOraniYuzdesi = aylikToplamSure > 0 ? 
                                        ((aylikMakinaArizasi / aylikToplamSure) * 100).toFixed(3) : '0.000';
                                    
                                    const arizaMarkaDetaylar = [];
                                    if (dmsAylikToplamSure > 0) {
                                        const dmsArizaOrani = ((dmsAylikMakinaArizasi / dmsAylikToplamSure) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`DMS: ${dmsArizaOrani}%`);
                                    }
                                    if (svcAylikToplamSure > 0) {
                                        const svcArizaOrani = ((svcAylikMakinaArizasi / svcAylikToplamSure) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`SVC: ${svcArizaOrani}%`);
                                    }
                                    if (tofasAylikToplamSure > 0) {
                                        const tofasArizaOrani = ((tofasAylikMakinaArizasi / tofasAylikToplamSure) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`TOFAÅ: ${tofasArizaOrani}%`);
                                    }
                                    if (fordAylikToplamSure > 0) {
                                        const fordArizaOrani = ((fordAylikMakinaArizasi / fordAylikToplamSure) * 100).toFixed(3);
                                        arizaMarkaDetaylar.push(`FORD: ${fordArizaOrani}%`);
                                    }
                                    
                                    const arizaMarkaDetayText = arizaMarkaDetaylar.length > 0 ? 
                                        arizaMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${arizaOraniYuzdesi}%${arizaMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${arizaMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    // Ä°stasyon BazlÄ± Kalite OranÄ± (21. sÃ¼tun)
                                    let aylikToplamOK = 0;
                                    let aylikToplamUrun = 0;
                                    let dmsAylikOK = 0;
                                    let svcAylikOK = 0;
                                    let tofasAylikOK = 0;
                                    let fordAylikOK = 0;
                                    let dmsAylikUrun = 0;
                                    let svcAylikUrun = 0;
                                    let tofasAylikUrun = 0;
                                    let fordAylikUrun = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamOK += prod.okUrun;
                                                aylikToplamUrun += prod.toplamUrun;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikOK += prod.okUrun;
                                                    dmsAylikUrun += prod.toplamUrun;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikOK += prod.okUrun;
                                                    svcAylikUrun += prod.toplamUrun;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikOK += prod.okUrun;
                                                    tofasAylikUrun += prod.toplamUrun;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikOK += prod.okUrun;
                                                    fordAylikUrun += prod.toplamUrun;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const istasyonKaliteOrani = aylikToplamUrun > 0 ? 
                                        ((aylikToplamOK / aylikToplamUrun) * 100).toFixed(2) : '0.00';
                                    
                                    const istasyonKaliteMarkaDetaylar = [];
                                    if (dmsAylikUrun > 0) {
                                        const dmsIstasyonKalite = ((dmsAylikOK / dmsAylikUrun) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`DMS: ${dmsIstasyonKalite}%`);
                                    }
                                    if (svcAylikUrun > 0) {
                                        const svcIstasyonKalite = ((svcAylikOK / svcAylikUrun) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`SVC: ${svcIstasyonKalite}%`);
                                    }
                                    if (tofasAylikUrun > 0) {
                                        const tofasIstasyonKalite = ((tofasAylikOK / tofasAylikUrun) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`TOFAÅ: ${tofasIstasyonKalite}%`);
                                    }
                                    if (fordAylikUrun > 0) {
                                        const fordIstasyonKalite = ((fordAylikOK / fordAylikUrun) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`FORD: ${fordIstasyonKalite}%`);
                                    }
                                    
                                    const istasyonKaliteMarkaDetayText = istasyonKaliteMarkaDetaylar.length > 0 ? 
                                        istasyonKaliteMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${istasyonKaliteOrani}%${istasyonKaliteMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${istasyonKaliteMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    // Ã‡alÄ±ÅŸma Performans OranÄ± (22. sÃ¼tun)
                                    const calismaPerformansOrani = aylikToplamUretilmesiGereken > 0 ? 
                                        ((aylikToplamUrun / aylikToplamUretilmesiGereken) * 100).toFixed(2) : '0.00';
                                    
                                    const calismaPerformansMarkaDetaylar = [];
                                    if (dmsAylikUretilmesiGereken > 0) {
                                        const dmsCalismaPerformans = ((dmsAylikUrun / dmsAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`DMS: ${dmsCalismaPerformans}%`);
                                    }
                                    if (svcAylikUretilmesiGereken > 0) {
                                        const svcCalismaPerformans = ((svcAylikUrun / svcAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`SVC: ${svcCalismaPerformans}%`);
                                    }
                                    if (tofasAylikUretilmesiGereken > 0) {
                                        const tofasCalismaPerformans = ((tofasAylikUrun / tofasAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`TOFAÅ: ${tofasCalismaPerformans}%`);
                                    }
                                    if (fordAylikUretilmesiGereken > 0) {
                                        const fordCalismaPerformans = ((fordAylikUrun / fordAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`FORD: ${fordCalismaPerformans}%`);
                                    }
                                    
                                    const calismaPerformansMarkaDetayText = calismaPerformansMarkaDetaylar.length > 0 ? 
                                        calismaPerformansMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${calismaPerformansOrani}%${calismaPerformansMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${calismaPerformansMarkaDetayText}</span>` : ''}</td>`;
                                }
                            } else if (tableBodyId === 'eolAnalyzBody') {
                                const fullProductName = product.prosesAdi ? `${product.urunAdi} - ${product.prosesAdi}` : product.urunAdi;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;font-weight:500;">${esc(fullProductName)}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${product.okUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${product.nokUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${product.toplamUrun}</td>`;
                                const okOrani = product.toplamUrun > 0 ? ((product.okUrun / product.toplamUrun) * 100).toFixed(2) : '0';
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${okOrani}%</td>`; // OK OranÄ±
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${product.toplamSure} dk</td>`; // Ã‡alÄ±ÅŸma SÃ¼resi
                                
                                if (productIndex === 0 && weekIndex === 0) {
                                    const darkerColor = getDarkerColor(ayRengi);
                                    const cellStyle = `
                                        padding:4px;
                                        border:1px solid #e5e7eb;
                                        text-align:center;
                                        font-weight:700;
                                        color:#000000;
                                        font-size:12px;
                                        background:${ayRengi};
                                        vertical-align:middle;
                                        border-left:3px solid ${darkerColor};
                                        box-shadow: inset 2px 0 4px rgba(0,0,0,0.05);
                                        line-height: 1.3;
                                    `;
                                    let aylikToplamCalisma = 0;
                                    let dmsAylikCalisma = 0;
                                    let svcAylikCalisma = 0;
                                    let tofasAylikCalisma = 0;
                                    let fordAylikCalisma = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplamCalisma += prod.toplamSure;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikCalisma += prod.toplamSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikCalisma += prod.toplamSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikCalisma += prod.toplamSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikCalisma += prod.toplamSure;
                                                }
                                            });
                                        }
                                    });
                                    const markaDetaylar = [];
                                    if (dmsAylikCalisma > 0) markaDetaylar.push(`DMS: ${dmsAylikCalisma}`);
                                    if (svcAylikCalisma > 0) markaDetaylar.push(`SVC: ${svcAylikCalisma}`);
                                    if (tofasAylikCalisma > 0) markaDetaylar.push(`TOFAÅ: ${tofasAylikCalisma}`);
                                    if (fordAylikCalisma > 0) markaDetaylar.push(`FORD: ${fordAylikCalisma}`);
                                    
                                    const markaDetayText = markaDetaylar.length > 0 ? markaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamCalisma} dk${markaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${markaDetayText} dk</span>` : ''}</td>`;
                                    
                                    let aylikPlanliDurus = 0;
                                    let dmsAylikPlanliDurus = 0;
                                    let svcAylikPlanliDurus = 0;
                                    let tofasAylikPlanliDurus = 0;
                                    let fordAylikPlanliDurus = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // PlanlÄ± duruÅŸ: planliDurus + setupSuresi
                                                const toplamPlanliDurus = prod.planliDurus + prod.setupSuresi;
                                                aylikPlanliDurus += toplamPlanliDurus;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikPlanliDurus += toplamPlanliDurus;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikPlanliDurus += toplamPlanliDurus;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikPlanliDurus += toplamPlanliDurus;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikPlanliDurus += toplamPlanliDurus;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const planliMarkaDetaylar = [];
                                    if (dmsAylikPlanliDurus > 0) planliMarkaDetaylar.push(`DMS: ${dmsAylikPlanliDurus}`);
                                    if (svcAylikPlanliDurus > 0) planliMarkaDetaylar.push(`SVC: ${svcAylikPlanliDurus}`);
                                    if (tofasAylikPlanliDurus > 0) planliMarkaDetaylar.push(`TOFAÅ: ${tofasAylikPlanliDurus}`);
                                    if (fordAylikPlanliDurus > 0) planliMarkaDetaylar.push(`FORD: ${fordAylikPlanliDurus}`);
                                    
                                    const planliMarkaDetayText = planliMarkaDetaylar.length > 0 ? planliMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikPlanliDurus} dk${planliMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${planliMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // PlansÄ±z DuruÅŸlar (10. sÃ¼tun)
                                    let aylikPlansizDurus = 0;
                                    let dmsAylikPlansizDurus = 0;
                                    let svcAylikPlansizDurus = 0;
                                    let tofasAylikPlansizDurus = 0;
                                    let fordAylikPlansizDurus = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikPlansizDurus += prod.plansizDurus;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikPlansizDurus += prod.plansizDurus;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikPlansizDurus += prod.plansizDurus;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikPlansizDurus += prod.plansizDurus;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikPlansizDurus += prod.plansizDurus;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const plansizMarkaDetaylar = [];
                                    if (dmsAylikPlansizDurus > 0) plansizMarkaDetaylar.push(`DMS: ${dmsAylikPlansizDurus}`);
                                    if (svcAylikPlansizDurus > 0) plansizMarkaDetaylar.push(`SVC: ${svcAylikPlansizDurus}`);
                                    if (tofasAylikPlansizDurus > 0) plansizMarkaDetaylar.push(`TOFAÅ: ${tofasAylikPlansizDurus}`);
                                    if (fordAylikPlansizDurus > 0) plansizMarkaDetaylar.push(`FORD: ${fordAylikPlansizDurus}`);
                                    
                                    const plansizMarkaDetayText = plansizMarkaDetaylar.length > 0 ? plansizMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikPlansizDurus} dk${plansizMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${plansizMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // Personel DuruÅŸu (11. sÃ¼tun)
                                    let aylikPersonelDurus = 0;
                                    let dmsAylikPersonelDurus = 0;
                                    let svcAylikPersonelDurus = 0;
                                    let tofasAylikPersonelDurus = 0;
                                    let fordAylikPersonelDurus = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikPersonelDurus += prod.personelDurus;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikPersonelDurus += prod.personelDurus;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikPersonelDurus += prod.personelDurus;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikPersonelDurus += prod.personelDurus;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikPersonelDurus += prod.personelDurus;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const personelMarkaDetaylar = [];
                                    if (dmsAylikPersonelDurus > 0) personelMarkaDetaylar.push(`DMS: ${dmsAylikPersonelDurus}`);
                                    if (svcAylikPersonelDurus > 0) personelMarkaDetaylar.push(`SVC: ${svcAylikPersonelDurus}`);
                                    if (tofasAylikPersonelDurus > 0) personelMarkaDetaylar.push(`TOFAÅ: ${tofasAylikPersonelDurus}`);
                                    if (fordAylikPersonelDurus > 0) personelMarkaDetaylar.push(`FORD: ${fordAylikPersonelDurus}`);
                                    
                                    const personelMarkaDetayText = personelMarkaDetaylar.length > 0 ? personelMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikPersonelDurus} dk${personelMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${personelMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // Makina ArÄ±zasÄ± (12. sÃ¼tun)
                                    let aylikMakinaArizasi = 0;
                                    let dmsAylikMakinaArizasi = 0;
                                    let svcAylikMakinaArizasi = 0;
                                    let tofasAylikMakinaArizasi = 0;
                                    let fordAylikMakinaArizasi = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikMakinaArizasi += prod.makinaArizasi;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikMakinaArizasi += prod.makinaArizasi;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikMakinaArizasi += prod.makinaArizasi;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikMakinaArizasi += prod.makinaArizasi;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikMakinaArizasi += prod.makinaArizasi;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const makinaMarkaDetaylar = [];
                                    if (dmsAylikMakinaArizasi > 0) makinaMarkaDetaylar.push(`DMS: ${dmsAylikMakinaArizasi}`);
                                    if (svcAylikMakinaArizasi > 0) makinaMarkaDetaylar.push(`SVC: ${svcAylikMakinaArizasi}`);
                                    if (tofasAylikMakinaArizasi > 0) makinaMarkaDetaylar.push(`TOFAÅ: ${tofasAylikMakinaArizasi}`);
                                    if (fordAylikMakinaArizasi > 0) makinaMarkaDetaylar.push(`FORD: ${fordAylikMakinaArizasi}`);
                                    
                                    const makinaMarkaDetayText = makinaMarkaDetaylar.length > 0 ? makinaMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikMakinaArizasi} dk${makinaMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${makinaMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    // Setup SÃ¼resi (13. sÃ¼tun)
                                    let aylikSetupSuresi = 0;
                                    let dmsAylikSetupSuresi = 0;
                                    let svcAylikSetupSuresi = 0;
                                    let tofasAylikSetupSuresi = 0;
                                    let fordAylikSetupSuresi = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikSetupSuresi += prod.setupSuresi;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikSetupSuresi += prod.setupSuresi;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikSetupSuresi += prod.setupSuresi;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikSetupSuresi += prod.setupSuresi;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikSetupSuresi += prod.setupSuresi;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const setupMarkaDetaylar = [];
                                    if (dmsAylikSetupSuresi > 0) setupMarkaDetaylar.push(`DMS: ${dmsAylikSetupSuresi}`);
                                    if (svcAylikSetupSuresi > 0) setupMarkaDetaylar.push(`SVC: ${svcAylikSetupSuresi}`);
                                    if (tofasAylikSetupSuresi > 0) setupMarkaDetaylar.push(`TOFAÅ: ${tofasAylikSetupSuresi}`);
                                    if (fordAylikSetupSuresi > 0) setupMarkaDetaylar.push(`FORD: ${fordAylikSetupSuresi}`);
                                    
                                    const setupMarkaDetayText = setupMarkaDetaylar.length > 0 ? setupMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikSetupSuresi} dk${setupMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${setupMarkaDetayText} dk</span>` : ''}</td>`;
                                    let aylikNetSure = 0;
                                    let dmsAylikNetSure = 0;
                                    let svcAylikNetSure = 0;
                                    let tofasAylikNetSure = 0;
                                    let fordAylikNetSure = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // Net SÃ¼re hesaplama: Toplam Ã‡alÄ±ÅŸma - (TÃ¼m DuruÅŸlar)
                                                const toplamDuruslar = (prod.planliDurus + prod.setupSuresi) + prod.plansizDurus + prod.personelDurus + prod.makinaArizasi;
                                                const netSure = prod.toplamSure - toplamDuruslar;
                                                
                                                aylikNetSure += netSure;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikNetSure += netSure;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikNetSure += netSure;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikNetSure += netSure;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikNetSure += netSure;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const netSureMarkaDetaylar = [];
                                    if (dmsAylikNetSure > 0) netSureMarkaDetaylar.push(`DMS: ${dmsAylikNetSure}`);
                                    if (svcAylikNetSure > 0) netSureMarkaDetaylar.push(`SVC: ${svcAylikNetSure}`);
                                    if (tofasAylikNetSure > 0) netSureMarkaDetaylar.push(`TOFAÅ: ${tofasAylikNetSure}`);
                                    if (fordAylikNetSure > 0) netSureMarkaDetaylar.push(`FORD: ${fordAylikNetSure}`);
                                    
                                    const netSureMarkaDetayText = netSureMarkaDetaylar.length > 0 ? netSureMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikNetSure} dk${netSureMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${netSureMarkaDetayText} dk</span>` : ''}</td>`;
                                    
                                    const netCalismaOrani = aylikToplamCalisma > 0 ? 
                                        ((aylikNetSure / aylikToplamCalisma) * 100).toFixed(2) : '0.00';
                                    
                                    const netCalismaOraniMarkaDetaylar = [];
                                    if (dmsAylikCalisma > 0) {
                                        const dmsNetCalismaOrani = ((dmsAylikNetSure / dmsAylikCalisma) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`DMS: ${dmsNetCalismaOrani}%`);
                                    }
                                    if (svcAylikCalisma > 0) {
                                        const svcNetCalismaOrani = ((svcAylikNetSure / svcAylikCalisma) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`SVC: ${svcNetCalismaOrani}%`);
                                    }
                                    if (tofasAylikCalisma > 0) {
                                        const tofasNetCalismaOrani = ((tofasAylikNetSure / tofasAylikCalisma) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`TOFAÅ: ${tofasNetCalismaOrani}%`);
                                    }
                                    if (fordAylikCalisma > 0) {
                                        const fordNetCalismaOrani = ((fordAylikNetSure / fordAylikCalisma) * 100).toFixed(2);
                                        netCalismaOraniMarkaDetaylar.push(`FORD: ${fordNetCalismaOrani}%`);
                                    }
                                    const netCalismaOraniMarkaDetayText = netCalismaOraniMarkaDetaylar.length > 0 ? 
                                        netCalismaOraniMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${netCalismaOrani}%${netCalismaOraniMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${netCalismaOraniMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    let aylikToplamUretilmesiGereken = 0;
                                    let dmsAylikUretilmesiGereken = 0;
                                    let svcAylikUretilmesiGereken = 0;
                                    let tofasAylikUretilmesiGereken = 0;
                                    let fordAylikUretilmesiGereken = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                ///30
                                                const uretilmesiGereken = Math.round((prod.toplamSure * 60) / 30);
                                                aylikToplamUretilmesiGereken += uretilmesiGereken;
                                                
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikUretilmesiGereken += uretilmesiGereken;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikUretilmesiGereken += uretilmesiGereken;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikUretilmesiGereken += uretilmesiGereken;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikUretilmesiGereken += uretilmesiGereken;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const uretilmesiGerekenMarkaDetaylar = [];
                                    if (dmsAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`DMS: ${dmsAylikUretilmesiGereken}`);
                                    if (svcAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`SVC: ${svcAylikUretilmesiGereken}`);
                                    if (tofasAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`TOFAÅ: ${tofasAylikUretilmesiGereken}`);
                                    if (fordAylikUretilmesiGereken > 0) uretilmesiGerekenMarkaDetaylar.push(`FORD: ${fordAylikUretilmesiGereken}`);
                                    
                                    const uretilmesiGerekenMarkaDetayText = uretilmesiGerekenMarkaDetaylar.length > 0 ? 
                                        uretilmesiGerekenMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamUretilmesiGereken}${uretilmesiGerekenMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${uretilmesiGerekenMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    let aylikToplamUretilenUrun = 0;
                                    let dmsAylikUretilenUrun = 0;
                                    let svcAylikUretilenUrun = 0;
                                    let tofasAylikUretilenUrun = 0;
                                    let fordAylikUretilenUrun = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // Ãœretilen ÃœrÃ¼n = OK + NOK (Toplam Ãœretim)
                                                const uretilenUrun = prod.okUrun + prod.nokUrun;
                                                aylikToplamUretilenUrun += uretilenUrun;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikUretilenUrun += uretilenUrun;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikUretilenUrun += uretilenUrun;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikUretilenUrun += uretilenUrun;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikUretilenUrun += uretilenUrun;
                                                }
                                            });
                                        }
                                    });
                                    
                                    const uretilenUrunMarkaDetaylar = [];
                                    if (dmsAylikUretilenUrun > 0) uretilenUrunMarkaDetaylar.push(`DMS: ${dmsAylikUretilenUrun}`);
                                    if (svcAylikUretilenUrun > 0) uretilenUrunMarkaDetaylar.push(`SVC: ${svcAylikUretilenUrun}`);
                                    if (tofasAylikUretilenUrun > 0) uretilenUrunMarkaDetaylar.push(`TOFAÅ: ${tofasAylikUretilenUrun}`);
                                    if (fordAylikUretilenUrun > 0) uretilenUrunMarkaDetaylar.push(`FORD: ${fordAylikUretilenUrun}`);
                                    
                                    const uretilenUrunMarkaDetayText = uretilenUrunMarkaDetaylar.length > 0 ? 
                                        uretilenUrunMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplamUretilenUrun}${uretilenUrunMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${uretilenUrunMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    const setupKaynakliKayipOrani = aylikToplamCalisma > 0 ? 
                                        ((aylikSetupSuresi / aylikToplamCalisma) * 100).toFixed(2) : '0.00';
                                    
                                    // Marka bazÄ±nda setup kaynaklÄ± kayÄ±p oranlarÄ± - alt alta gÃ¶sterim
                                    const setupKaynakliKayipMarkaDetaylar = [];
                                    if (dmsAylikCalisma > 0) {
                                        const dmsSetupKayip = ((dmsAylikSetupSuresi / dmsAylikCalisma) * 100).toFixed(2);
                                        setupKaynakliKayipMarkaDetaylar.push(`DMS: ${dmsSetupKayip}%`);
                                    }
                                    if (svcAylikCalisma > 0) {
                                        const svcSetupKayip = ((svcAylikSetupSuresi / svcAylikCalisma) * 100).toFixed(2);
                                        setupKaynakliKayipMarkaDetaylar.push(`SVC: ${svcSetupKayip}%`);
                                    }
                                    if (tofasAylikCalisma > 0) {
                                        const tofasSetupKayip = ((tofasAylikSetupSuresi / tofasAylikCalisma) * 100).toFixed(2);
                                        setupKaynakliKayipMarkaDetaylar.push(`TOFAÅ: ${tofasSetupKayip}%`);
                                    }
                                    if (fordAylikCalisma > 0) {
                                        const fordSetupKayip = ((fordAylikSetupSuresi / fordAylikCalisma) * 100).toFixed(2);
                                        setupKaynakliKayipMarkaDetaylar.push(`FORD: ${fordSetupKayip}%`);
                                    }
                                    const setupKaynakliKayipMarkaDetayText = setupKaynakliKayipMarkaDetaylar.length > 0 ? 
                                        setupKaynakliKayipMarkaDetaylar.join('<br>') : '';
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${setupKaynakliKayipOrani}%${setupKaynakliKayipMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${setupKaynakliKayipMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    const calismaPerformansOrani = aylikToplamUretilmesiGereken > 0 ? 
                                        ((aylikToplamUretilenUrun / aylikToplamUretilmesiGereken) * 100).toFixed(2) : '0.00';
                                    const calismaPerformansMarkaDetaylar = [];
                                    if (dmsAylikUretilmesiGereken > 0) {
                                        const dmsCalismaPerformans = ((dmsAylikUretilenUrun / dmsAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`DMS: ${dmsCalismaPerformans}%`);
                                    }
                                    if (svcAylikUretilmesiGereken > 0) {
                                        const svcCalismaPerformans = ((svcAylikUretilenUrun / svcAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`SVC: ${svcCalismaPerformans}%`);
                                    }
                                    if (tofasAylikUretilmesiGereken > 0) {
                                        const tofasCalismaPerformans = ((tofasAylikUretilenUrun / tofasAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`TOFAÅ: ${tofasCalismaPerformans}%`);
                                    }
                                    if (fordAylikUretilmesiGereken > 0) {
                                        const fordCalismaPerformans = ((fordAylikUretilenUrun / fordAylikUretilmesiGereken) * 100).toFixed(2);
                                        calismaPerformansMarkaDetaylar.push(`FORD: ${fordCalismaPerformans}%`);
                                    }
                                    const calismaPerformansMarkaDetayText = calismaPerformansMarkaDetaylar.length > 0 ? 
                                        calismaPerformansMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${calismaPerformansOrani}%${calismaPerformansMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${calismaPerformansMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    const arizaKaynakliOrani = aylikToplamCalisma > 0 ? 
                                        ((aylikMakinaArizasi / aylikToplamCalisma) * 100).toFixed(2) : '0.00';
                                    
                                    const arizaKaynakliMarkaDetaylar = [];
                                    if (dmsAylikCalisma > 0) {
                                        const dmsArizaKaynakli = ((dmsAylikMakinaArizasi / dmsAylikCalisma) * 100).toFixed(2);
                                        arizaKaynakliMarkaDetaylar.push(`DMS: ${dmsArizaKaynakli}%`);
                                    }
                                    if (svcAylikCalisma > 0) {
                                        const svcArizaKaynakli = ((svcAylikMakinaArizasi / svcAylikCalisma) * 100).toFixed(2);
                                        arizaKaynakliMarkaDetaylar.push(`SVC: ${svcArizaKaynakli}%`);
                                    }
                                    if (tofasAylikCalisma > 0) {
                                        const tofasArizaKaynakli = ((tofasAylikMakinaArizasi / tofasAylikCalisma) * 100).toFixed(2);
                                        arizaKaynakliMarkaDetaylar.push(`TOFAÅ: ${tofasArizaKaynakli}%`);
                                    }
                                    if (fordAylikCalisma > 0) {
                                        const fordArizaKaynakli = ((fordAylikMakinaArizasi / fordAylikCalisma) * 100).toFixed(2);
                                        arizaKaynakliMarkaDetaylar.push(`FORD: ${fordArizaKaynakli}%`);
                                    }
                                    const arizaKaynakliMarkaDetayText = arizaKaynakliMarkaDetaylar.length > 0 ? 
                                        arizaKaynakliMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${arizaKaynakliOrani}%${arizaKaynakliMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${arizaKaynakliMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    let aylikToplamOK = 0;
                                    let aylikToplamToplam = 0;
                                    let dmsAylikOK = 0;
                                    let svcAylikOK = 0;
                                    let tofasAylikOK = 0;
                                    let fordAylikOK = 0;
                                    let dmsAylikToplam = 0;
                                    let svcAylikToplam = 0;
                                    let tofasAylikToplam = 0;
                                    let fordAylikToplam = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                // OK ve Toplam Ã¼rÃ¼n sayÄ±larÄ±nÄ± topla
                                                aylikToplamOK += prod.okUrun;
                                                aylikToplamToplam += prod.toplamUrun;
                                                
                                                // Marka ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikOK += prod.okUrun;
                                                    dmsAylikToplam += prod.toplamUrun;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikOK += prod.okUrun;
                                                    svcAylikToplam += prod.toplamUrun;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikOK += prod.okUrun;
                                                    tofasAylikToplam += prod.toplamUrun;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikOK += prod.okUrun;
                                                    fordAylikToplam += prod.toplamUrun;
                                                }
                                            });
                                        }
                                    });
                                    const istasyonKaliteOrani = aylikToplamToplam > 0 ? 
                                        ((aylikToplamOK / aylikToplamToplam) * 100).toFixed(2) : '0.00';
                                    
                                    const istasyonKaliteMarkaDetaylar = [];
                                    if (dmsAylikToplam > 0) {
                                        const dmsIstasyonKalite = ((dmsAylikOK / dmsAylikToplam) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`DMS: ${dmsIstasyonKalite}%`);
                                    }
                                    if (svcAylikToplam > 0) {
                                        const svcIstasyonKalite = ((svcAylikOK / svcAylikToplam) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`SVC: ${svcIstasyonKalite}%`);
                                    }
                                    if (tofasAylikToplam > 0) {
                                        const tofasIstasyonKalite = ((tofasAylikOK / tofasAylikToplam) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`TOFAÅ: ${tofasIstasyonKalite}%`);
                                    }
                                    if (fordAylikToplam > 0) {
                                        const fordIstasyonKalite = ((fordAylikOK / fordAylikToplam) * 100).toFixed(2);
                                        istasyonKaliteMarkaDetaylar.push(`FORD: ${fordIstasyonKalite}%`);
                                    }
                                    const istasyonKaliteMarkaDetayText = istasyonKaliteMarkaDetaylar.length > 0 ? 
                                        istasyonKaliteMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${istasyonKaliteOrani}%${istasyonKaliteMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${istasyonKaliteMarkaDetayText}</span>` : ''}</td>`;
                                }
                            } else if (tableBodyId === 'sizdirmazlikAnalyzBody') {
                                const fullProductName = product.prosesAdi ? `${product.urunAdi} - ${product.prosesAdi}` : product.urunAdi;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;font-weight:500;">${esc(fullProductName)}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${product.okUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${product.nokUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${product.toplamUrun}</td>`; // TOPLAM
                                const okOrani = product.toplamUrun > 0 ? ((product.okUrun / product.toplamUrun) * 100).toFixed(1) : '0';
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${okOrani}%</td>`; // OK OranÄ±

                                if (productIndex === 0 && weekIndex === 0) {
                                    // AylÄ±k toplam kalite oranÄ± ve marka bazÄ±nda oranlar
                                    let aylikToplamOK = 0, aylikToplamUrun = 0;
                                    let dmsOK = 0, dmsToplam = 0, svcOK = 0, svcToplam = 0, tofasOK = 0, tofasToplam = 0, fordOK = 0, fordToplam = 0;

                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const upper = productName.toUpperCase();
                                                aylikToplamOK += prod.okUrun;
                                                aylikToplamUrun += prod.toplamUrun;
                                                if (upper.includes('DMS')) {
                                                    dmsOK += prod.okUrun;
                                                    dmsToplam += prod.toplamUrun;
                                                } else if (upper.includes('SVC')) {
                                                    svcOK += prod.okUrun;
                                                    svcToplam += prod.toplamUrun;
                                                } else if (upper.includes('TOFAÅ') || upper.includes('TOFAS')) {
                                                    tofasOK += prod.okUrun;
                                                    tofasToplam += prod.toplamUrun;
                                                } else if (upper.includes('FORD')) {
                                                    fordOK += prod.okUrun;
                                                    fordToplam += prod.toplamUrun;
                                                }
                                            });
                                        }
                                    });
                                    const aylikKaliteOrani = aylikToplamUrun > 0 ? ((aylikToplamOK / aylikToplamUrun) * 100).toFixed(1) : '0';

                                    // Marka bazÄ±nda kalite oranlarÄ±
                                    const markaDetaylar = [];
                                    if (dmsToplam > 0) markaDetaylar.push(`DMS: ${(dmsOK / dmsToplam * 100).toFixed(1)}%`);
                                    if (svcToplam > 0) markaDetaylar.push(`SVC: ${(svcOK / svcToplam * 100).toFixed(1)}%`);
                                    if (tofasToplam > 0) markaDetaylar.push(`TOFAÅ: ${(tofasOK / tofasToplam * 100).toFixed(1)}%`);
                                    if (fordToplam > 0) markaDetaylar.push(`FORD: ${(fordOK / fordToplam * 100).toFixed(1)}%`);
                                    const markaDetayText = markaDetaylar.length > 0 ? markaDetaylar.join('<br>') : '';

                                    const darkerColor = getDarkerColor(ayRengi);
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="
                                        padding:4px;
                                        border:1px solid #e5e7eb;
                                        text-align:center;
                                        font-weight:700;
                                        color:#000000 ;
                                        font-size:13px;
                                        background:${ayRengi};
                                        vertical-align:middle;
                                        border-left:3px solid ${darkerColor};
                                        box-shadow: inset 2px 0 4px rgba(0,0,0,0.05);
                                    ">${aylikKaliteOrani}%${markaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${markaDetayText}</span>` : ''}</td>`;
                                }
                            } else if (tableBodyId === 'lazerAnalyzBody') {
    const fullProductName = product.prosesAdi ? `${product.urunAdi} - ${product.prosesAdi}` : product.urunAdi;
    tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;font-weight:500;">${esc(fullProductName)}</td>`;
    tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${product.okUrun}</td>`;
    tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${product.nokUrun}</td>`;
    tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${product.toplamUrun}</td>`; // Toplam
    
    if (productIndex === 0 && weekIndex === 0) {
        let aylikToplam = 0;
        let dmsAylikToplam = 0;
        let svcAylikToplam = 0;
        
        ayWeeksData.forEach(weekInfo => {
            if (weekInfo.weekData && weekInfo.weekData.products) {
                weekInfo.weekData.products.forEach(prod => {
                    const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                    const productUpper = productName.toUpperCase();
                    
                    aylikToplam += prod.toplamUrun;
                    if (productUpper.includes('DMS')) {
                        dmsAylikToplam += prod.toplamUrun;
                    } else if (productUpper.includes('SVC')) {
                        svcAylikToplam += prod.toplamUrun;
                    }
                });
            }
        });
        
        // AyÄ±n rengine uygun stil
        const darkerColor = getDarkerColor(ayRengi);
        const cellStyle = `
            padding:4px;
            border:1px solid #e5e7eb;
            text-align:center;
            font-weight:700;
            color:#000000;
            font-size:12px;
            background:${ayRengi};
            vertical-align:middle;
            border-left:3px solid ${darkerColor};
            box-shadow: inset 2px 0 4px rgba(0,0,0,0.05);
            line-height: 1.3;
        `;
        
        // Marka detaylarÄ±nÄ± alt alta dÃ¼zenleme
        const markaDetaylar = [];
        if (dmsAylikToplam > 0) markaDetaylar.push(`DMS: ${dmsAylikToplam}`);
        if (svcAylikToplam > 0) markaDetaylar.push(`SVC: ${svcAylikToplam}`);
        
        const markaDetayText = markaDetaylar.length > 0 ? 
            markaDetaylar.join('<br>') : '';
        
        tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">
            ${aylikToplam}${markaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${markaDetayText}</span>` : ''}
        </td>`;
    }
                            } else if (tableBodyId === 'sonKontrolAnalyzBody') {
                                const fullProductName = product.prosesAdi ? `${product.urunAdi} - ${product.prosesAdi}` : product.urunAdi;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-size:11px;font-weight:500;">${esc(fullProductName)}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#059669;">${product.okUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#dc2626;">${product.nokUrun}</td>`;
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;color:#2563eb;">${product.toplamUrun}</td>`; // Toplam
                                
                                if (productIndex === 0 && weekIndex === 0) {
                                    let aylikToplam = 0;
                                    let dmsAylikToplam = 0;
                                    let svcAylikToplam = 0;
                                    let tofasAylikToplam = 0;
                                    let fordAylikToplam = 0;
                                    let aylikToplamOK = 0;
                                    let aylikToplamNOK = 0;
                                    let dmsAylikOK = 0;
                                    let svcAylikOK = 0;
                                    let tofasAylikOK = 0;
                                    let fordAylikOK = 0;
                                    let dmsAylikNOK = 0;
                                    let svcAylikNOK = 0;
                                    let tofasAylikNOK = 0;
                                    let fordAylikNOK = 0;
                                    
                                    ayWeeksData.forEach(weekInfo => {
                                        if (weekInfo.weekData && weekInfo.weekData.products) {
                                            weekInfo.weekData.products.forEach(prod => {
                                                const productName = prod.prosesAdi ? `${prod.urunAdi} - ${prod.prosesAdi}` : prod.urunAdi;
                                                const productUpper = productName.toUpperCase();
                                                
                                                aylikToplam += prod.toplamUrun;
                                                aylikToplamOK += prod.okUrun;
                                                aylikToplamNOK += prod.nokUrun;
                                                
                                                // DMS/SVC/TOFAÅ/FORD ayrÄ±mÄ±
                                                if (productUpper.includes('DMS')) {
                                                    dmsAylikToplam += prod.toplamUrun;
                                                    dmsAylikOK += prod.okUrun;
                                                    dmsAylikNOK += prod.nokUrun;
                                                } else if (productUpper.includes('SVC')) {
                                                    svcAylikToplam += prod.toplamUrun;
                                                    svcAylikOK += prod.okUrun;
                                                    svcAylikNOK += prod.nokUrun;
                                                } else if (productUpper.includes('TOFAÅ') || productUpper.includes('TOFAS')) {
                                                    tofasAylikToplam += prod.toplamUrun;
                                                    tofasAylikOK += prod.okUrun;
                                                    tofasAylikNOK += prod.nokUrun;
                                                } else if (productUpper.includes('FORD')) {
                                                    fordAylikToplam += prod.toplamUrun;
                                                    fordAylikOK += prod.okUrun;
                                                    fordAylikNOK += prod.nokUrun;
                                                }
                                            });
                                        }
                                    });
                                    
                                    // AyÄ±n rengine uygun stil
                                    const darkerColor = getDarkerColor(ayRengi);
                                    const cellStyle = `
                                        padding:4px;
                                        border:1px solid #e5e7eb;
                                        text-align:center;
                                        font-weight:700;
                                        color:#000000;
                                        font-size:12px;
                                        background:${ayRengi};
                                        vertical-align:middle;
                                        border-left:3px solid ${darkerColor};
                                        box-shadow: inset 2px 0 4px rgba(0,0,0,0.05);
                                        line-height: 1.3;
                                    `;
                                    
                                    // 7. SÃ¼tun: AylÄ±k Toplam (MEVCUT HALÄ° KORUNUYOR)
                                    const markaDetaylar = [];
                                    if (dmsAylikToplam > 0) markaDetaylar.push(`DMS: ${dmsAylikToplam}`);
                                    if (svcAylikToplam > 0) markaDetaylar.push(`SVC: ${svcAylikToplam}`);
                                    if (tofasAylikToplam > 0) markaDetaylar.push(`TOFAÅ: ${tofasAylikToplam}`);
                                    if (fordAylikToplam > 0) markaDetaylar.push(`FORD: ${fordAylikToplam}`);
                                    
                                    const markaDetayText = markaDetaylar.length > 0 ? 
                                        markaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikToplam}${markaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${markaDetayText}</span>` : ''}</td>`;
                                    
                                    // 9. SÃ¼tun: AylÄ±k Hata OranÄ± - Tek birleÅŸik hÃ¼cre (NOK/Toplam)
                                    const aylikHataOrani = aylikToplam > 0 ? ((aylikToplamNOK / aylikToplam) * 100).toFixed(1) : '0.0';
                                    
                                    const hataOraniMarkaDetaylar = [];
                                    if (dmsAylikToplam > 0) {
                                        const dmsHataOrani = ((dmsAylikNOK / dmsAylikToplam) * 100).toFixed(1);
                                        hataOraniMarkaDetaylar.push(`DMS: ${dmsHataOrani}%`);
                                    }
                                    if (svcAylikToplam > 0) {
                                        const svcHataOrani = ((svcAylikNOK / svcAylikToplam) * 100).toFixed(1);
                                        hataOraniMarkaDetaylar.push(`SVC: ${svcHataOrani}%`);
                                    }
                                    if (tofasAylikToplam > 0) {
                                        const tofasHataOrani = ((tofasAylikNOK / tofasAylikToplam) * 100).toFixed(1);
                                        hataOraniMarkaDetaylar.push(`TOFAÅ: ${tofasHataOrani}%`);
                                    }
                                    if (fordAylikToplam > 0) {
                                        const fordHataOrani = ((fordAylikNOK / fordAylikToplam) * 100).toFixed(1);
                                        hataOraniMarkaDetaylar.push(`FORD: ${fordHataOrani}%`);
                                    }
                                    
                                    const hataOraniMarkaDetayText = hataOraniMarkaDetaylar.length > 0 ? 
                                        hataOraniMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikHataOrani}%${hataOraniMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${hataOraniMarkaDetayText}</span>` : ''}</td>`;
                                    
                                    // 10. SÃ¼tun: AylÄ±k Kalite OranÄ± - Tek birleÅŸik hÃ¼cre (OK/Toplam)
                                    const aylikKaliteOrani = aylikToplam > 0 ? ((aylikToplamOK / aylikToplam) * 100).toFixed(1) : '0.0';
                                    
                                    const kaliteOraniMarkaDetaylar = [];
                                    if (dmsAylikToplam > 0) {
                                        const dmsKaliteOrani = ((dmsAylikOK / dmsAylikToplam) * 100).toFixed(1);
                                        kaliteOraniMarkaDetaylar.push(`DMS: ${dmsKaliteOrani}%`);
                                    }
                                    if (svcAylikToplam > 0) {
                                        const svcKaliteOrani = ((svcAylikOK / svcAylikToplam) * 100).toFixed(1);
                                        kaliteOraniMarkaDetaylar.push(`SVC: ${svcKaliteOrani}%`);
                                    }
                                    if (tofasAylikToplam > 0) {
                                        const tofasKaliteOrani = ((tofasAylikOK / tofasAylikToplam) * 100).toFixed(1);
                                        kaliteOraniMarkaDetaylar.push(`TOFAÅ: ${tofasKaliteOrani}%`);
                                    }
                                    if (fordAylikToplam > 0) {
                                        const fordKaliteOrani = ((fordAylikOK / fordAylikToplam) * 100).toFixed(1);
                                        kaliteOraniMarkaDetaylar.push(`FORD: ${fordKaliteOrani}%`);
                                    }
                                    
                                    const kaliteOraniMarkaDetayText = kaliteOraniMarkaDetaylar.length > 0 ? 
                                        kaliteOraniMarkaDetaylar.join('<br>') : '';
                                    
                                    tbody += `<td rowspan="${ayRowspanTotal}" style="${cellStyle}">${aylikKaliteOrani}%${kaliteOraniMarkaDetayText ? `<br><span style="font-size:10px;font-weight:500;color:#555;">${kaliteOraniMarkaDetayText}</span>` : ''}</td>`;
                                }
                                
                                // 8. SÃ¼tun: OK OranÄ± - HaftalÄ±k (MEVCUT HALÄ° KORUNUYOR)
                                const okOrani = product.toplamUrun > 0 ? ((product.okUrun / product.toplamUrun) * 100).toFixed(1) : '0';
                                tbody += `<td style="padding:4px;border:1px solid #e5e7eb;text-align:center;font-weight:600;">${okOrani}%</td>`;
                            }
                            tbody += '</tr>';
                        });
                    }
                });
            }
            
            if (tbody === '') {
                tbody = `<tr><td colspan="${columnCount}" style="text-align:center;padding:20px;color:#666;">SeÃ§ilen yÄ±l iÃ§in veri bulunamadÄ±</td></tr>`;
            }
            
            document.getElementById(tableBodyId).innerHTML = tbody;
        }
        function createSmdAnalysisTable() {
            createProsesAnalysisTable('smdAnalyzBody', smdYilFiltresi, 25, ['smd bot', 'smd top']);
        }
        function createLensAnalysisTable() {
            createProsesAnalysisTable('lensAnalyzBody', lensYilFiltresi, 22, ['lens aa 2']);
        }
        function createEolAnalysisTable() {
            createProsesAnalysisTable('eolAnalyzBody', eolYilFiltresi, 22, ['eol robot']); // EOL 21 sÃ¼tun
        }
        function createSizdirmazlikAnalysisTable() {
            createProsesAnalysisTable('sizdirmazlikAnalyzBody', sizdirmazlikYilFiltresi, 8, ['sÄ±zdÄ±rmazlÄ±k']); // SIZDIRMAZLIK 7 sÃ¼tun
        }
        function createLazerAnalysisTable() {
            createProsesAnalysisTable('lazerAnalyzBody', lazerYilFiltresi, 7, ['Lazer Markalama']); // LAZER 6 sÃ¼tun
        }
        function createSonKontrolAnalysisTable() {
            createProsesAnalysisTable('sonKontrolAnalyzBody', sonKontrolYilFiltresi, 10, ['Son Kontrol']); // SON KONTROL 9 sÃ¼tun
        }
        window.showReferansTabloPopup = showReferansTabloPopup;
        window.closeReferansPopup = closeReferansPopup;
        window.resetReferansToDefaults = resetReferansToDefaults;
        window.saveReferansValues = saveReferansValues;

        ///////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////Ana tablo burada oluÅŸuyor gÃ¼n1///////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////

        let currentMainPage = 1;
        const mainRowsPerPage = 400;

        function aoaToTable(aoa, defaultCh = 18,) {
            if (!aoa || aoa.length === 0) return '<div style="padding:12px;color:#666">BoÅŸ sayfa</div>';

            const header = aoa[0] || [];
            const Hn = header.map(norm);
            const dataRows = aoa.slice(1);
            const totalPages = Math.ceil(dataRows.length / mainRowsPerPage);
            
            const startIndex = (currentMainPage - 1) * mainRowsPerPage;
            const endIndex = startIndex + mainRowsPerPage;
            const pageRows = dataRows.slice(startIndex, endIndex);
            const dateCols     = new Set();
            const timeCols     = new Set();
            const datetimeCols = new Set();

            Hn.forEach((h, i) => {
                if (h.includes('tarih') || h.includes('date')) {
                    dateCols.add(i);
                }
                if ((h.includes('baslama') && h.includes('saat')) ||
                    (h.includes('bitis')   && h.includes('saat'))) {
                    timeCols.add(i);
                }
                if ((h.includes('start')      && h.includes('time')) ||
                    (h.includes('completion') && h.includes('time'))) {
                    datetimeCols.add(i);
                }
            });
            const pagination = `
            <div style="position:sticky;top:0;z-index:10;padding:8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb;background:#f8fafc;margin-bottom:8px;border-radius:8px;box-shadow:0 -1px 6px rgba(0,0,0,0.1);">
                <div class="filter-section">
                    <span style="font-weight:500;font-size:12px;color:#374151;">Filtreler:</span>
                    <select id="dropdownName" class="filter-dropdown">
                        <option value="">TÃ¼m Ä°simler</option>
                        ${uniqueValues.name.map(val => `<option value="${esc(val)}" ${currentFilters.name === val ? 'selected' : ''}>${esc(val)}</option>`).join('')}
                    </select>
                    <select id="dropdownProduct" class="filter-dropdown">
                        <option value="">TÃ¼m ÃœrÃ¼nler</option>
                        ${uniqueValues.product.map(val => `<option value="${esc(val)}" ${currentFilters.product === val ? 'selected' : ''}>${esc(val)}</option>`).join('')}
                    </select>
                    <select id="dropdownProcess" class="filter-dropdown">
                        <option value="">TÃ¼m Prosesler</option>
                        ${uniqueValues.process.map(val => `<option value="${esc(val)}" ${currentFilters.process === val ? 'selected' : ''}>${esc(val)}</option>`).join('')}
                    </select>
                    <button class="clear-filters-btn" onclick="clearAllFilters()">Temizle</button>
                </div>
                <div style="display:flex;align-items:center;">
                    <button onclick="goToMainPage(${currentMainPage - 1})" ${currentMainPage === 1 ? 'disabled' : ''} 
                            style="padding:6px 12px;margin:0 4px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;color:#374151;transition:all 0.2s;${currentMainPage === 1 ? 'opacity:0.5;cursor:not-allowed;' : ''}">
                        â—€
                    </button>
                    <span style="margin:0 12px;font-weight:500;font-size:13px;color:#374151;">
                        Sayfa ${currentMainPage} / ${totalPages} (${dataRows.length} kayÄ±t)
                    </span>
                    <button onclick="goToMainPage(${currentMainPage + 1})" ${currentMainPage === totalPages ? 'disabled' : ''} 
                            style="padding:6px 12px;margin:0 4px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;color:#374151;transition:all 0.2s;${currentMainPage === totalPages ? 'opacity:0.5;cursor:not-allowed;' : ''}">
                        â–¶
                    </button>
                </div>
            </div>`;
            const ths = header.map(h => `<th style="white-space:normal;word-wrap:break-word;width:8ch;min-width:8ch;max-width:8ch;">${esc(h)}</th>`).join('');
            const columnWidths = [
                '3ch',   // ID
                '17ch',  // Tarih     
                '17ch',  // Tarih
                '28ch',  // mail
                '20ch',  // name
                '11ch', '15ch', '12ch', '15ch', '10ch', '10ch', '10ch', '25ch', '15ch', '25ch', '15ch', '10ch'
            ];
            const colgroup = '<colgroup>' + header.map((h, i) => `<col style="width:${columnWidths[i] || defaultCh + 'ch'}">`).join('') + '</colgroup>';
            let body = '';
            for (let r = 0; r < pageRows.length; r++) {
                const row = pageRows[r] || [];
                let tds = '';
                for (let c = 0; c < header.length; c++) {
                    let v = row[c];
                    if (timeCols.has(c)) {
                        // BaÅŸlama saati, bitiÅŸ saati -> HH:MM formatÄ±
                        v = normalizeTimeCell(v);
                    } else if (datetimeCols.has(c)) {
                        // Start time, Completion time -> M.D.YY HH:MM:SS formatÄ±
                        v = normalizeDateTimeCell(v);
                    } else if (dateCols.has(c)) {
                        // Tarih sÃ¼tunu
                        if (v instanceof Date && !isNaN(v)) {
                            v = v.toLocaleDateString('tr-TR');
                        } else if (typeof v === 'number' && isFinite(v)) {
                            v = excelDateToJSDate(v).toLocaleDateString('tr-TR');
                        }
                    }
                    tds += `<td>${esc(v ?? '')}</td>`;
                }
                body += `<tr>${tds}</tr>`;
            }
            const mainPagination = document.getElementById('mainPagination');
            mainPagination.innerHTML = pagination;
            setTimeout(() => {
                setupFilterListeners();
            }, 10);
            return `<table>${colgroup}<thead><tr>${ths}</tr></thead><tbody>${body}</tbody></table>`;
        }
        function goToMainPage(page) {
            const totalPages = Math.ceil(allSuccessRows.length / mainRowsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentMainPage = page;
                const aoaSuccess = [currentHeader, ...allSuccessRows];
                tableWrap.innerHTML = aoaToTable(aoaSuccess);
            }
        }
        function applyColumnFilters() {
            if (!allSuccessRows.length) return;
            
            const nameIdx = findColIndex(currentHeader, ['name']);
            const productIdx = findColIndex(currentHeader, ['urun', 'adi']);
            const processIdx = findColIndex(currentHeader, ['proses', 'adi']);
            
            let filteredRows = allSuccessRows.filter(row => {
                let matches = true;
                
                if (currentFilters.name && nameIdx >= 0) {
                    const nameVal = String(row[nameIdx] || '').toLowerCase();
                    matches = matches && nameVal.includes(currentFilters.name.toLowerCase());
                }
                
                if (currentFilters.product && productIdx >= 0) {
                    const productVal = String(row[productIdx] || '').toLowerCase();
                    matches = matches && productVal.includes(currentFilters.product.toLowerCase());
                }
                
                if (currentFilters.process && processIdx >= 0) {
                    const processVal = String(row[processIdx] || '').toLowerCase();
                    matches = matches && processVal.includes(currentFilters.process.toLowerCase());
                }
                return matches;
            });
            const fromDate = dateFrom.value;
            const toDate = dateTo.value;
            
            if (fromDate || toDate) {
                const dateColIndex = currentHeader.findIndex(h => 
                    norm(h).includes('tarih') || norm(h).includes('date')
                );
                
                if (dateColIndex >= 0) {
                    filteredRows = filteredRows.filter(row => {
                        const cellDate = String(row[dateColIndex] || '').trim();
                        const dateParts = cellDate.split('.');
                        if (dateParts.length !== 3) return false;
                        
                        const cellDateFormatted = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                        
                        let matchesFrom = true;
                        let matchesTo = true;
                        
                        if (fromDate) matchesFrom = cellDateFormatted >= fromDate;
                        if (toDate) matchesTo = cellDateFormatted <= toDate;
                        
                        return matchesFrom && matchesTo;
                    });
                }
            }
            
            currentMainPage = 1; // Filtreleme sonrasÄ± ilk sayfaya dÃ¶n
            const aoaFiltered = [currentHeader, ...filteredRows];
            tableWrap.innerHTML = aoaToTable(aoaFiltered);
            
            chipRows.textContent = `ğŸ“‹ GÃ¶sterilen: ${filteredRows.length} / Toplam: ${allSuccessRows.length}`;
            setupFilterListeners();
        }
        function extractUniqueValues() {
            if (!allSuccessRows.length) return;
            
            const nameIdx = findColIndex(currentHeader, ['name']);
            const productIdx = findColIndex(currentHeader, ['urun', 'adi']);
            const processIdx = findColIndex(currentHeader, ['proses', 'adi']);
            
            const nameSet = new Set();
            const productSet = new Set();
            const processSet = new Set();
            
            allSuccessRows.forEach(row => {
                if (nameIdx >= 0 && row[nameIdx]) nameSet.add(String(row[nameIdx]).trim());
                if (productIdx >= 0 && row[productIdx]) productSet.add(String(row[productIdx]).trim());
                if (processIdx >= 0 && row[processIdx]) processSet.add(String(row[processIdx]).trim());
            });
            
            uniqueValues.name = Array.from(nameSet).sort();
            uniqueValues.product = Array.from(productSet).sort();
            uniqueValues.process = Array.from(processSet).sort();
        }
        function clearAllFilters() {
            currentFilters = { name: '', product: '', process: '',};
            dateFrom.value = '';
            dateTo.value = '';
            currentMainPage = 1;
            
            if (allSuccessRows.length) {
                const aoaAll = [currentHeader, ...allSuccessRows];
                tableWrap.innerHTML = aoaToTable(aoaAll);
                chipRows.textContent = `ğŸ“‹ BaÅŸarÄ±lÄ±: ${allSuccessRows.length} / HatalÄ±: ${allErrorRows.length}`;
                setupFilterListeners();
            }
        }
        function setupFilterListeners() {
            const dropdownName = document.getElementById('dropdownName');
            const dropdownProduct = document.getElementById('dropdownProduct');
            const dropdownProcess = document.getElementById('dropdownProcess');
            
            if (dropdownName) {
                dropdownName.addEventListener('change', (e) => {
                    currentFilters.name = e.target.value;
                    applyColumnFilters();
                });
            }
            if (dropdownProduct) {
                dropdownProduct.addEventListener('change', (e) => {
                    currentFilters.product = e.target.value;
                    applyColumnFilters();
                });
            }
            if (dropdownProcess) {
                dropdownProcess.addEventListener('change', (e) => {
                    currentFilters.process = e.target.value;
                    applyColumnFilters();
                });
            }
        }
        // handleFile fonksiyonundan Ã¶nce bu fonksiyonu ekleyin:
        function collectDetailedErrors(srcRow, rowIndex, header) {
            const errors = [];
            const row = [...srcRow];
            
            const idxDate = (findColIndex(header, ['tarih']) >= 0) ? findColIndex(header, ['tarih']) : findColIndex(header, ['date']);
            const idxStart = (() => {
                const c3 = findColIndex(header, ['start','time']); if (c3>=0) return c3;
                const c1 = findColIndex(header, ['baslama']); if (c1>=0) return c1;
                const c4 = findColIndex(header, ['start']); if (c4>=0) return c4;
                return -1;
            })();
            const idxEnd = (() => {
                const c3 = findColIndex(header, ['completion','time']); if (c3>=0) return c3;
                const c4 = findColIndex(header, ['finish','time']); if (c4>=0) return c4;
                const c5 = findColIndex(header, ['end','time']); if (c5>=0) return c5;
                const c1 = findColIndex(header, ['bitis']); if (c1>=0) return c1;
                const c6 = findColIndex(header, ['end']); if (c6>=0) return c6;
                return -1;
            })();
            const idxBaslamaSaat = findColIndex(header, ['baslama', 'saat']);
            const idxBitisSaat = findColIndex(header, ['bitis', 'saat']);
            const idxHata = (() => {
                const a = findColIndex(header, ['hata','kod']); if (a >= 0) return a;
                const b = findColIndex(header, ['hata','adet']); if (b >= 0) return b;
                return -1;
            })();
            const idxDurus = (findColIndex(header, ['durus','kod']) >= 0) ? findColIndex(header, ['durus','kod']) : findColIndex(header, ['durus','sure']);
            const idxID = (findColIndex(header, ['id']) >= 0) ? findColIndex(header, ['id']) : findColIndex(header, ['no']);
            const idxName = findColIndex(header, ['name']);
            
            const id = row[idxID] || '';
            const name = row[idxName] || '';
            
            let tarih = row[idxDate] || '';
            
            if (idxDate >= 0) {
                const dv = row[idxDate];
                if (dv instanceof Date && !isNaN(dv)) {
                    tarih = dv.toLocaleDateString('tr-TR');
                } else if (typeof dv === 'number' && isFinite(dv) && dv > 1) {
                    // Excel serial date (45369 gibi)
                    const jsDate = excelDateToJSDate(dv);
                    const day = String(jsDate.getDate()).padStart(2, '0');
                    const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                    const year = jsDate.getFullYear();
                    tarih = `${day}.${month}.${year}`;
                } else if (typeof dv === 'string' && dv.trim()) {
                    // String tarih formatÄ±nÄ± kontrol et ve dÃ¼zelt
                    const cleanDate = dv.trim();
                    if (/^\d+$/.test(cleanDate)) {
                        // Sadece sayÄ± ise Excel serial date olarak iÅŸle
                        const jsDate = excelDateToJSDate(parseInt(cleanDate));
                        const day = String(jsDate.getDate()).padStart(2, '0');
                        const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                        const year = jsDate.getFullYear();
                        tarih = `${day}.${month}.${year}`;
                    } else {
                        tarih = cleanDate;
                    }
                } else {
                    tarih = String(dv || '');
                }
            }
            [idxStart, idxEnd].forEach(i => {
                if (i < 0) return;
                const normalizedDateTime = normalizeDateTimeCell(row[i]);
                if (!normalizedDateTime || !isValidMDYDateTime(normalizedDateTime)) {
                    errors.push({
                        rowNumber: rowIndex + 2,
                        id: id,
                        name: name,
                        tarih: tarih,
                        column: header[i] || 'Zaman',
                        cellValue: String(row[i] || ''),
                        errorType: 'GeÃ§ersiz Zaman FormatÄ±',
                        errorDetail: 'Zaman formatÄ± M.D.YY HH:MM:SS olmalÄ±dÄ±r'
                    });
                }
            });
            [idxBaslamaSaat, idxBitisSaat].forEach(i => {
                if (i < 0) return;
                const normalizedTime = normalizeTimeCell(row[i]);
                if (!normalizedTime || !isTimeStringValid(normalizedTime)) {
                    errors.push({
                        rowNumber: rowIndex + 2,
                        id: id,
                        name: name,
                        tarih: tarih,
                        column: header[i] || 'Saat',
                        cellValue: String(row[i] || ''),
                        errorType: 'GeÃ§ersiz Saat FormatÄ±',
                        errorDetail: 'Saat formatÄ± HH:MM olmalÄ±dÄ±r'
                    });
                }
            });
            if (idxHata >= 0) {         // Hata kodlarÄ± kontrolÃ¼
                const hataText = String(row[idxHata] || '');
                if (!isPatternValid(hataText, Hatalar_list)) {
                    const invalidCodes = extractTextValues(hataText).filter(code => !Hatalar_list.includes(code));
                    errors.push({
                        rowNumber: rowIndex + 2,
                        id: id,
                        name: name,
                        tarih: tarih,
                        column: header[idxHata] || 'Hata KodlarÄ±',
                        cellValue: hataText,
                        errorType: 'GeÃ§ersiz Hata Kodu',
                        errorDetail: invalidCodes.length > 0 
                            ? `GeÃ§ersiz kodlar: ${invalidCodes.join(', ')}. GeÃ§erli aralÄ±k: H0-H92`
                            : 'Hata kod formatÄ±: sayÄ±*Hkod ÅŸeklinde olmalÄ±dÄ±r (Ã¶rn: 5*H15+2*H3)'
                    });
                }
            }
            if (idxDurus >= 0) {        // DuruÅŸ kodlarÄ± kontrolÃ¼
                const durusText = String(row[idxDurus] || '');
                if (!isPatternValid(durusText, Duruslar_list)) {
                    const invalidCodes = extractTextValues(durusText).filter(code => !Duruslar_list.includes(code));
                    errors.push({
                        rowNumber: rowIndex + 2,
                        id: id,
                        name: name,
                        tarih: tarih,
                        column: header[idxDurus] || 'DuruÅŸ KodlarÄ±',
                        cellValue: durusText,
                        errorType: 'GeÃ§ersiz DuruÅŸ Kodu',
                        errorDetail: invalidCodes.length > 0 
                            ? `GeÃ§ersiz kodlar: ${invalidCodes.join(', ')}. GeÃ§erli aralÄ±k: D0-D24`
                            : 'DuruÅŸ kod formatÄ±: sayÄ±*Dkod ÅŸeklinde olmalÄ±dÄ±r (Ã¶rn: 30*D4+15*D17)'
                    });
                }
            }
            return errors;
        }
        
        function handleFile(file) {
            showLoading('Dosya yÃ¼kleniyor...');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array', cellDates: false });
                    workbookRef = wb;

                    const first = wb.SheetNames[0];
                    if (!first) throw new Error('Excel iÃ§inde sayfa bulunamadÄ±.');
                    const sheet = wb.Sheets[first];

                    const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: '', blankrows: false });
                    if (aoa.length === 0) throw new Error('BoÅŸ sayfa.');

                    const header = aoa[0] || [];
                    const rows   = aoa.slice(1);
                    
                    currentHeader = header;

                    const idxDate  = (findColIndex(header, ['tarih']) >= 0) ? findColIndex(header, ['tarih']) : findColIndex(header, ['date']);
                    
                    const idxStart = (() => {
                        const c3 = findColIndex(header, ['start','time']);         if (c3>=0) return c3;
                        const c1 = findColIndex(header, ['baslama']);              if (c1>=0) return c1;
                        const c4 = findColIndex(header, ['start']);                if (c4>=0) return c4;
                        return -1;
                    })();
                    const idxEnd = (() => {
                        const c3 = findColIndex(header, ['completion','time']);    if (c3>=0) return c3;
                        const c4 = findColIndex(header, ['finish','time']);        if (c4>=0) return c4;
                        const c5 = findColIndex(header, ['end','time']);           if (c5>=0) return c5;
                        const c1 = findColIndex(header, ['bitis']);                if (c1>=0) return c1;
                        const c6 = findColIndex(header, ['end']);                  if (c6>=0) return c6;
                        return -1;
                    })();
                    
                    const idxBaslamaSaat = findColIndex(header, ['baslama', 'saat']);
                    const idxBitisSaat = findColIndex(header, ['bitis', 'saat']);
                    
                    const idxHata  = (()=>{ const a=findColIndex(header,['hata','kod']); if(a>=0)return a; const b=findColIndex(header,['hata','adet']); if(b>=0)return b; return -1; })();
                    const idxDurus = (findColIndex(header, ['durus','kod']) >= 0) ? findColIndex(header, ['durus','kod']) : findColIndex(header, ['durus','sure']);
                    const idxEmail = (()=>{ const e1=findColIndex(header,['email']); const e2=findColIndex(header,['e-posta']); const e3=findColIndex(header,['posta']); return Math.max(e1,e2,e3); })();
                    const idxID    = (findColIndex(header, ['id']) >= 0) ? findColIndex(header, ['id']) : findColIndex(header, ['no']);

                    const successRows = [];
                    const errorRows = [];
                    detailedErrorRows = []; // Reset detailed errors

                    for (let i = 0; i < rows.length; i++) {
                        const srcRow = rows[i];
                        if (idxEmail >= 0) {
                            const mail = String(srcRow[idxEmail] ?? '').trim().toLowerCase();
                            if (mail === 'alihanaykanat@buyutech.com.tr') continue;
                        }
                        if (idxID >= 0) {
                            const idVal = Number(srcRow[idxID]);
                            if (Number.isFinite(idVal) && idVal < 189) continue;
                        }

                        const rowErrors = collectDetailedErrors(srcRow, i, header);
                        if (rowErrors.length > 0) {
                            detailedErrorRows.push(...rowErrors);
                            errorRows.push([...srcRow]);
                        } else {
                            // Veriyi normalize et ve baÅŸarÄ±lÄ± satÄ±rlara ekle
                            const row = [...srcRow];
                            
                            if (idxDate >= 0) {
                                const dv = row[idxDate];
                                if (dv instanceof Date && !isNaN(dv)) {
                                    row[idxDate] = dv.toLocaleDateString('tr-TR');
                                } else if (typeof dv === 'number' && isFinite(dv)) {
                                    row[idxDate] = excelDateToJSDate(dv).toLocaleDateString('tr-TR');
                                }
                            }
                            [idxStart, idxEnd].forEach(j => {
                                if (j < 0) return;
                                row[j] = normalizeDateTimeCell(row[j]);
                            });
                            [idxBaslamaSaat, idxBitisSaat].forEach(j => {
                                if (j < 0) return;
                                row[j] = normalizeTimeCell(row[j]);
                            });
                            
                            successRows.push(row);
                        }
                    }

                    allSuccessRows = successRows;
                    extractUniqueValues();    
                    extractDurusUniqueValues();
                    window.filteredDurusRows = allSuccessRows;
                    allErrorRows = errorRows;
                    
                    const aoaSuccess = [header, ...successRows];
                    tableWrap.innerHTML = aoaToTable(aoaSuccess);
                    const rowsCount  = successRows.length;
                    const errorCount = errorRows.length;
                    const colsCount  = header.length;
                    const sizeString = file.size >= 1048576
                    ? `${(file.size/1048576).toFixed(1)} MB`
                    : `${(file.size/1024).toFixed(1)} KB`;

                    chipName.textContent  = `ğŸ“„ ${file.name}`;
                    chipSize.textContent  = `ğŸ“¦ ${sizeString}`;
                    chipSheet.textContent = `ğŸ“‘ ${first}`;
                    chipRows.textContent  = `ğŸ“‹ BaÅŸarÄ±lÄ±: ${rowsCount} / HatalÄ±: ${errorCount}`;
                    chipCols.textContent  = `ğŸ“ ${colsCount} sÃ¼tun`;
                    fileInfoBar.classList.remove('hidden');

                    msg.textContent = `YÃ¼klendi: ${file.name}`;
                    createMainPageErrorTable(); 
                    hideLoading();
                    showTopbarAndPanel('panel-main', 'tab-main');
                } catch (err) {
                    console.error(err);
                    msg.textContent = 'Hata: ' + (err.message || err);
                    hideLoading();
                }
            };
            reader.onerror = () => { 
                msg.textContent = 'Dosya okuma hatasÄ±.'; 
                hideLoading();
            };
            reader.readAsArrayBuffer(file);
        }
        // DeÄŸiÅŸkenlere ekleyin
        let detailedErrorRows = [];
        let errorTableVisible = true;

        function createMainPageErrorTable() {
            const errorSection = document.getElementById('errorSection');
            const errorTableWrap = document.getElementById('errorTableWrap');
            const errorCount = document.getElementById('errorCount');
            
            if (!detailedErrorRows.length) {
                errorSection.classList.add('hidden');
                return;
            }
            errorSection.classList.remove('hidden');
            errorCount.textContent = `${detailedErrorRows.length} hata`;
            if (!errorTableVisible) {
                document.getElementById('errorTableContainer').style.display = 'none';
                return;
            }
            const displayErrors = detailedErrorRows;

            const headers = ['SatÄ±r', 'ID', 'Ä°sim', 'Tarih', 'HatanÄ±n bulunduÄŸu SÃ¼tun AdÄ±', 'HatalÄ± DeÄŸer', 'Hata TÃ¼rÃ¼', 'AÃ§Ä±klama'];
            const columnWidths = ['5ch', '8ch', '20ch', '12ch', '15ch', '20ch', '15ch', '30ch'];
            const colgroup = '<colgroup>' + columnWidths.map(width => `<col style="width:${width}">`).join('') + '</colgroup>';
            const ths = headers.map(h => `<th style="padding:8px;background:#fef2f2;border:1px solid #fecaca;font-weight:600;text-align:left;font-size:12px;">${h}</th>`).join('');
            
            let tbody = '';
            displayErrors.forEach((error, index) => {
                const rowClass = index % 2 === 0 ? 'background:#fefefe;' : 'background:#fff8f8;';
                const errorTypeColor = {
                    'GeÃ§ersiz Tarih FormatÄ±': '#dc2626',
                    'GeÃ§ersiz Zaman FormatÄ±': '#ea580c', 
                    'GeÃ§ersiz Saat FormatÄ±': '#ca8a04',
                    'GeÃ§ersiz Hata Kodu': '#7c2d12',
                    'GeÃ§ersiz DuruÅŸ Kodu': '#86198f'
                }[error.errorType] || '#dc2626';
                
                tbody += `
                <tr style="${rowClass}">
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-weight:600;font-size:11px;">${error.rowNumber}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-size:11px;">${esc(error.id)}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-size:11px;">${esc(error.name)}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-size:11px;">${esc(error.tarih)}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-weight:500;font-size:11px;">${esc(error.column)}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-family:monospace;background:#fef1f1;font-size:10px;word-break:break-all;max-width:150px;overflow:hidden;text-overflow:ellipsis;">${esc(String(error.cellValue).substring(0, 50))}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;color:${errorTypeColor};font-weight:600;font-size:11px;">${esc(error.errorType)}</td>
                    <td style="padding:6px 8px;border:1px solid #fecaca;font-size:10px;">${esc(error.errorDetail)}</td>
                </tr>`;
            });
            
            errorTableWrap.innerHTML = `
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
                ${colgroup}
                <thead><tr>${ths}</tr></thead>
                <tbody>${tbody}</tbody>
            </table>`;
        }
        function toggleErrorTable() {
            errorTableVisible = !errorTableVisible;
            const container = document.getElementById('errorTableContainer');
            const button = document.getElementById('toggleErrorTable');
            
            if (errorTableVisible) {
                container.style.display = 'block';
                button.textContent = 'Gizle';
                createMainPageErrorTable();
            } else {
                container.style.display = 'none';
                button.textContent = 'GÃ¶ster';
            }
        }
        function showTopbarAndPanel(panelId, tabId){    //ana tabloya geÃ§iÅŸ, paneller arasÄ± geÃ§iÅŸ
            if (panelId === 'panel-main' && allSuccessRows.length > 0) {
                showLoading('Tablo yÃ¼kleniyor...');   //ana tablo bekletme popup
                setTimeout(() => {
                    topbar.classList.remove('hidden');
                    document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    
                    hideLoading();
                }, 50);
            } else if (panelId === 'panel-2') {
                showLoading('DuruÅŸ SÃ¼releri HazÄ±rlanÄ±yor...');
                setTimeout(() => {
                    createDurusAnalysisTable();
                    topbar.classList.remove('hidden');
                    document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    hideLoading();
                }, 100);
            } else if (panelId === 'panel-3') {
                showLoading('OEE Analizi HazÄ±rlanÄ±yor...');
                setTimeout(() => {
                    calculateGrafikStats();
                    populateYilFiltresi();
                    populateEkAnalizYilFiltresi();
                    createAylikAnaliz();
                    topbar.classList.remove('hidden');
                    document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    hideLoading();
                }, 100);
            } else if (panelId === 'panel-4') {
                showLoading('Proses Analizi HazÄ±rlanÄ±yor...');
                setTimeout(() => {
                    populateYilFiltresiForProses(smdYilFiltresi);
                    createSmdAnalysisTable();
                    topbar.classList.remove('hidden');
                    document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    hideLoading();
                }, 100);
                } else if (panelId === 'panel-5') {
                showLoading('KPI Tablosu HazÄ±rlanÄ±yor...');
                setTimeout(() => {
                    createKpiTable(); // â† BU SATIRI EKLEYÄ°N
                    topbar.classList.remove('hidden');
                    document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    hideLoading();
                }, 100);
            } else {    // DiÄŸer paneller iÃ§in normal geÃ§iÅŸ
                topbar.classList.remove('hidden');
                document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(panelId).classList.remove('hidden');
                document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            }
        }
        topbar.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-tab');
          if (!btn) return;
          const target = btn.getAttribute('data-target');
          if (!target) return;
          showTopbarAndPanel(target, btn.id);
        });
        clearFilter.addEventListener('click', clearDateFilter);
        dateFrom.addEventListener('change', () => {
            dateTo.min = dateFrom.value; // BitiÅŸ tarihi minimum baÅŸlangÄ±Ã§ tarihi olur
            filterTableByDate();
        });
        dateTo.addEventListener('change', filterTableByDate);
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').max = today;
            document.getElementById('dateTo').max = today;
        });
        durusClearFilter.addEventListener('click', clearDurusDateFilter);
        durusDateFrom.addEventListener('change', () => {
            durusDateTo.min = durusDateFrom.value;
            filterDurusTableByDate();
        });
        durusDateTo.addEventListener('change', filterDurusTableByDate);

        // DOMContentLoaded event'ine duruÅŸ tarih input'larÄ±nÄ± ekle:
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').max = today;
            document.getElementById('dateTo').max = today;
            document.getElementById('durusDateFrom').max = today;
            document.getElementById('durusDateTo').max = today;
        });
        // Grafik analizi tarih filtreleri
        grafikClearFilter.addEventListener('click', clearGrafikDateFilter);
        grafikDateFrom.addEventListener('change', () => {
            grafikDateTo.min = grafikDateFrom.value;
            calculateGrafikStats();
        });
        grafikDateTo.addEventListener('change', calculateGrafikStats);
        
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').max = today;
            document.getElementById('dateTo').max = today;
            document.getElementById('durusDateFrom').max = today;
            document.getElementById('durusDateTo').max = today;
            document.getElementById('grafikDateFrom').max = today;
            document.getElementById('grafikDateTo').max = today;
        });
        // YÄ±l filtresi event listener
        yilFiltresi.addEventListener('change', createAylikAnaliz);

        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'toggleErrorTable') {
                toggleErrorTable();
            }
        });
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('proses-btn')) {
                document.querySelectorAll('.proses-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                document.querySelectorAll('.proses-section').forEach(section => section.classList.add('hidden'));
                const targetId = e.target.getAttribute('data-target');
                document.getElementById(targetId).classList.remove('hidden');
                
                // Her proses iÃ§in gerekli fonksiyonlarÄ± Ã§aÄŸÄ±r
                if (targetId === 'smd-section') {
                    populateYilFiltresiForProses(smdYilFiltresi);
                    createSmdAnalysisTable();
                } else if (targetId === 'lens-section') {
                    populateYilFiltresiForProses(lensYilFiltresi);
                    createLensAnalysisTable();
                } else if (targetId === 'eol-section') {
                    populateYilFiltresiForProses(eolYilFiltresi);
                    createEolAnalysisTable();
                } else if (targetId === 'sizdirmazlik-section') {
                    populateYilFiltresiForProses(sizdirmazlikYilFiltresi);
                    createSizdirmazlikAnalysisTable();
                } else if (targetId === 'lazer-section') {
                    populateYilFiltresiForProses(lazerYilFiltresi);
                    createLazerAnalysisTable();
                } else if (targetId === 'son-kontrol-section') {
                    populateYilFiltresiForProses(sonKontrolYilFiltresi);
                    createSonKontrolAnalysisTable();
                }
            }
        });
        smdYilFiltresi.addEventListener('change', createSmdAnalysisTable);
        lensYilFiltresi.addEventListener('change', createLensAnalysisTable);
        eolYilFiltresi.addEventListener('change', createEolAnalysisTable);
        sizdirmazlikYilFiltresi.addEventListener('change', createSizdirmazlikAnalysisTable);
        lazerYilFiltresi.addEventListener('change', createLazerAnalysisTable);
        sonKontrolYilFiltresi.addEventListener('change', createSonKontrolAnalysisTable);

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const ekAnalizYilFiltresi = document.getElementById('ekAnalizYilFiltresi');
                if (ekAnalizYilFiltresi) {
                    ekAnalizYilFiltresi.addEventListener('change', () => {
                        showLoading('Ek Analiz GÃ¼ncelleniyor...');
                        setTimeout(() => {
                            createEkAnalizTablosu();
                            hideLoading();
                        }, 50);
                    });
                }
            }, 1000);
        });
        document.getElementById('aylikAnalizBody').innerHTML = tbody;

                // Bu satÄ±rlarÄ± script'in sonuna ekleyin:
        window.calculateSmdNetKapasite = calculateSmdNetKapasite;
        window.getSmdCalismaPerformansFromTable = getSmdCalismaPerformansFromTable;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Excel Veri Kontrolü</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    :root {
      --bg: #f9f9fb;
      --box: #ffffff;
      --border: #ddd;
      --primary: #4CAF50;
      --danger: #ffdddd;
      --text: #333;
      --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      --progress-bg: #e0e0e0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    #drop-zone {
      border: 2px dashed var(--primary);
      background: #eaf7ed;
      padding: 40px;
      text-align: center;
      color: var(--primary);
      border-radius: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    #drop-zone:hover {
      background: #d8f5e0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #drop-zone.drag-over {
      background: #c8f2d0;
      border-color: #2e7d32;
      transform: scale(1.02);
    }

    .drop-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .drop-icon {
      font-size: 48px;
      opacity: 0.7;
    }

    .drop-text {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }

    .drop-subtext {
      font-size: 14px;
      opacity: 0.8;
      margin: 0;
    }

    #file-input {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .progress-container {
      margin: 20px 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: var(--progress-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #66bb6a);
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        45deg,
        transparent 35%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 65%
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      font-weight: 500;
      color: #666;
    }

    .button-container  {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      min-width: 120px;
    }
    .main-table-btn {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        min-width: 120px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);  /* Normal durumdaki gölge */
    }
    .main-table-btn:hover {
        background-color: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);  /* Hover durumunda daha belirgin gölge */
    }
    .main-table-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 8px rgba(0,0,0,0.0.05);  /* Tıklama durumunda orta seviye gölge */
    }
    .button-container button.active {
    background-color: #367c39;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }

    .main-table-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }

    .table-section {
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background:#242424;
      color: white;
      border-radius: 10px 10px 0 0;
      box-shadow: var(--shadow);
      position: relative;
    }

    .table-header.error-header {
      background: #222222;
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .analysis-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-top: 20px;
    }   

    .reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
    }

    .report-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .report-card:hover {
        transform: translateY(-5px);
    }

    .report-card h4 {
        margin: 0 0 10px 0;
        color: var(--text);
        font-size: 18px;
    }

    .report-card p {
        color: #666;
        margin: 0 0 15px 0;
        font-size: 14px;
    }

    .report-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }

    .report-btn:hover {
        background: #45a049;
    }

    .date-filter-container {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
    }

    .date-input-container {
    display: flex;
    flex-direction: column;
    gap: 5px;
    }

    .date-input-container label {
    font-weight: 500;
    color: #333;
    font-size: 14px;
    }

    .date-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 14px;
    min-width: 150px;
    cursor: pointer;
    background: white;
    }

    .flatpickr-calendar {
    background: white;
    box-shadow: 0 3px 15px rgba(0,0,0,0.2);
    border-radius: 8px;
    }

    .flatpickr-day.selected {
        background: var(--primary);
        border-color: var(--primary);
    }

    .flatpickr-day.inRange {
        background: #e8f5e9;
        border-color: #c8e6c9;
    }

    .flatpickr-day.today {
        border-color: var(--primary);
    }

    .analysis-results {
        margin-top: 20px;
    }

    .table-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .export-button, .toggle-button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .export-button:hover, .toggle-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .export-button {
      background: rgba(76, 175, 80, 0.8);
    }

    .export-button:hover {
      background: rgba(76, 175, 80, 1);
    }

    .toggle-icon {
      font-size: 14px;
      transition: transform 0.3s ease;
    }

    .toggle-button.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .table-wrapper {
      max-width: 100%;
      max-height: 550px;
      overflow-x: auto;
      overflow-y: auto;
      border-radius: 0 0 8px 8px;
      box-shadow: var(--shadow);
      background: var(--box);
      padding: 0px;
      border-top: none;
      transition: all 0.3s ease;
    }

    .table-wrapper.collapsed {
      display: none;
    }

    .table-wrapper table {
      width: 100%;
      border-collapse: collapse;
    }

    .table-wrapper th,
    .table-wrapper td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .table-wrapper th {
      background: #f5f5f5;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    th:first-child, td:first-child {
      width: 32px;
      text-align: center;
      background-color: #f1f1f1;
    }
    .scrap-input {
        width: 60px;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    .scrap-input:focus {
        outline: none;
        border-color: #4CAF50;
    }

    thead {
      background-color: #f3f3f3;
    }

    thead th {
      position: sticky;
      top: 0;
      background-color: #f3f3f3;
      z-index: 1;
    }

    .error {
      background-color: var(--danger);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }

      #drop-zone {
        padding: 30px 20px;
      }

      .drop-icon {
        font-size: 36px;
      }

      .drop-text {
        font-size: 16px;
      }

      .table-header {
        padding: 12px 15px;
      }

      .table-title {
        font-size: 16px;
      }

      .table-controls {
        flex-direction: column;
        gap: 5px;
      }

      .export-button, .toggle-button {
        font-size: 14px;
        padding: 6px 10px;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Excel Dosyası Veri Kontrolü</h2>
    
    <div id="drop-zone">
      <input type="file" id="file-input" accept=".xlsx, .xls" />
      <div class="drop-content">
        <div class="drop-icon">📄</div>
        <p class="drop-text">Dosyayı buraya sürükleyin veya tıklayın</p>
        <p class="drop-subtext">Excel dosyaları (.xlsx, .xls) desteklenir</p>
      </div>
    </div>

    <div class="button-container" id="buttonContainer" style="display: none;">
        <button id="mainTableBtn" class="main-table-btn">Ana Tablo</button>
        <button id="analysisBtn" class="main-table-btn">Analiz</button>
        <button id="reportsBtn" class="main-table-btn">Raporlar</button>
    </div>
    
    <div class="progress-container" id="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">İşleniyor...</div>
    </div>
    
    <div id="tables"></div>
  </div>

  <script>
    const excludedIndexes = [1, 2, 5, 16];
    const Hatalar_list = Array.from({ length: 93 }, (_, i) => "H" + i);
    const Duruslar_list = Array.from({ length: 25 }, (_, i) => "D" + i);

    function parseErrorCodes(errorString) {
        if (!errorString || errorString === "0") return "";
        
        const errorTotals = {};
        const allMatches = errorString.match(/(\d+)\*(\w+)/g) || [];
        
        allMatches.forEach(match => {
            const [count, code] = match.split('*');
            const normalizedCode = code.toUpperCase();
            errorTotals[normalizedCode] = (errorTotals[code] || 0) + parseInt(count);
        });
        
        // Toplam sayılarına göre sırala ve formatla
        return Object.entries(errorTotals)
            .sort((a, b) => b[1] - a[1]) // Sayıya göre büyükten küçüğe sırala
            .map(([code, total]) => `${code}: ${total}`)
            .join('<br>');
    }

    function excelDateToJSDate(serial) {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      return new Date(excelEpoch.getTime() + serial * 24 * 60 * 60 * 1000);
    }

    function isValidDateFormat(str) {
      return /^\d{2}\.\d{2}\.\d{4}$/.test(str);
    }

    function isTimeStringValid(timeString) {
      if (typeof timeString === "number") return timeString >= 0 && timeString <= 1;
      if (typeof timeString === "string") {
        const timeRegex = /^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/;
        return timeRegex.test(timeString);
      }
      return false;
    }

    function isPatternMatch(input) {
      if (typeof input !== "string") return false;
      const cleaned = input.replace(/\s/g, '');
      return /^(\d+\*\w+(\+\d+\*\w+)*)$/.test(cleaned);
    }

    function extractTextValues(input) {
      if (!input || typeof input !== "string") return [];
      const pattern = /\b\d+\s*\*\s*(\w+)\s*\b/g;
      const matches = [];
      let match;
      while ((match = pattern.exec(input)) !== null) {
        if (match[1]) matches.push(match[1].toUpperCase());
      }
      return matches;
    }

    function checkListContains(list1, list2) {
      return list1.every(item => list2.includes(item));
    }

    function isPatternValid(text, validList) {
      if (!text || text === "0") return true;
      if (!isPatternMatch(text)) return false;
      const codes = extractTextValues(text);
      return checkListContains(codes, validList);
    }

    // Tarihe göre hafta numarası hesaplama fonksiyonu (ISO 8601 formatında)
    function getWeekFromDate(dateString) {
      if (!dateString || typeof dateString !== 'string') return '';
      
      try {
        // dd.mm.yyyy formatını parse et
        const [day, month, year] = dateString.split('.').map(num => parseInt(num));
        
        if (isNaN(day) || isNaN(month) || isNaN(year)) return '';
        
        // Tarihi Date objesine çevir
        const date = new Date(year, month - 1, day);
        
        // ISO hafta hesaplama
        const target = new Date(date.valueOf());
        const dayNumber = (date.getDay() + 6) % 7; // Pazartesi = 0
        
        target.setDate(target.getDate() - dayNumber + 3);
        const firstThursday = target.valueOf();
        target.setMonth(0, 1);
        
        if (target.getDay() !== 4) {
            target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
        }
        
        const weekNumber = 1 + Math.ceil((firstThursday - target) / 604800000);
        
        // YYYY-Wxx formatında döndür
        return `${year}-W${String(weekNumber).padStart(2, '0')}`;
        
    } catch (error) {
        console.error('Hafta hesaplama hatası:', error);
        return '';
    }
}
    
    // Yılın son hafta numarasını hesapla
    function getLastWeekOfYear(year) {
      const dec31 = new Date(year, 11, 31);
      const jan4NextYear = new Date(year + 1, 0, 4);
      const jan4NextYearDay = jan4NextYear.getDay();
      
      // Eğer 31 Aralık, bir sonraki yılın ilk haftasındaysa
      if (jan4NextYearDay <= 4) { // Perşembe veya öncesi
        const firstMondayNextYear = new Date(jan4NextYear);
        firstMondayNextYear.setDate(jan4NextYear.getDate() - (jan4NextYearDay === 0 ? 6 : jan4NextYearDay - 1));
        
        if (dec31 >= firstMondayNextYear) {
          return 1; // Aslında bir sonraki yılın ilk haftası
        }
      }
      
      // Normal hesaplama
      const jan4 = new Date(year, 0, 4);
      const jan4Day = jan4.getDay();
      const firstMonday = new Date(jan4);
      firstMonday.setDate(jan4.getDate() - (jan4Day === 0 ? 6 : jan4Day - 1));
      
      const diffTime = dec31.getTime() - firstMonday.getTime();
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 1000));
      return Math.floor(diffDays / 7) + 1;
    }

    function updateProgress(current, total) {
      const percentage = Math.round((current / total) * 100);
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      
      progressFill.style.width = percentage + '%';
      progressText.textContent = `${current}/${total} satır işlendi... (${percentage}%)`;
    }

    function showProgress() {
      document.getElementById('progress-container').style.display = 'block';
    }

    function hideProgress() {
      document.getElementById('progress-container').style.display = 'none';
    }

    function exportToExcel(headers, rows, fileName) {
      // İstenen sütun başlıkları ve sıralaması
      const desiredHeaders = [
        "ID",
        "Email", 
        "Tarih",
        "Hafta",
        "Proses Adı",        // "Process adı" yerine
        "OK Ürün",           // "ok ürün adeti" yerine
        "Fireler",           // "hata adet ve kodlar" yerine
        "Fire Açıklaması"
      ];
      const headerKeyMap = {
        "proses adı": "process adı",
        "ok ürün": "ok ürün adeti",
        "fireler": "hata adet ve kodlar",
        "fire açıklaması": "h0 için açıklama"
      };

      // Orijinal başlıkların indekslerini bul - daha esnek eşleştirme
      const actualIndices = {};
      headers.forEach((header, index) => {
        if (header && typeof header === 'string') {
          const cleanHeader = header.trim().toLowerCase();
          actualIndices[cleanHeader] = index;
          
          // Process adı için alternatif eşleştirmeler
          if (cleanHeader.includes('process') || cleanHeader.includes('proses')) {
            actualIndices['process adı'] = index;
          }
          if (cleanHeader.includes('ürün') && cleanHeader.includes('adet')) {
            actualIndices['ok ürün adeti'] = index;
          }
          if (cleanHeader.includes('hata') && (cleanHeader.includes('adet') || cleanHeader.includes('kod'))) {
            actualIndices['hata adet ve kodlar'] = index;
          }
          if (cleanHeader.includes('h0') || (cleanHeader.includes('açıklama') && cleanHeader.includes('h0'))) {
            actualIndices['h0 için açıklama'] = index;
          }
        }
      });

      console.log('Başlık eşleştirmeleri:', actualIndices); // Debug için

      // Her istenen başlık için orijinal indeksi bul
      const headerMap = desiredHeaders.map(desiredHeader => {
        if (desiredHeader === "Hafta") {
          return "HAFTA"; // Özel işaretçi
        }
        
        const matchKey = headerKeyMap[desiredHeader.toLowerCase()] || desiredHeader.toLowerCase();
        const foundIndex = actualIndices[matchKey];
  
        if (foundIndex !== undefined) {
            return foundIndex;
        }

        for (const [key, value] of Object.entries(actualIndices)) {
            if (key.includes(matchKey.split(' ')[0]) || matchKey.includes(key.split(' ')[0])) {
                return value;
            }
        }

        return -1;
      });

      // Filtrelenmiş satırları oluştur
      const filteredRows = rows.map(row => {
        return headerMap.map((idx, headerIndex) => {
          if (idx === "HAFTA") {
            // Tarih sütunundan hafta bilgisini hesapla
            const dateIndex = actualIndices["tarih"];
            const dateValue = dateIndex !== undefined ? row[dateIndex] : "";
            return getWeekFromDate(dateValue);
          }
          
          if (idx === -1) return "(eksik)"; // Başlık bulunamadı
          return row[idx] ?? "";
        });
      });

      // Excel workbook oluştur
      const wb = XLSX.utils.book_new();
      const wsData = [desiredHeaders, ...filteredRows];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Kolon genişliklerini ayarla
      ws['!cols'] = desiredHeaders.map(() => ({ wch: 20 }));
      
      // Worksheet'i workbook'a ekle
      XLSX.utils.book_append_sheet(wb, ws, 'Veriler');
      
      // Dosyayı indir
      XLSX.writeFile(wb, fileName);
    }

    function displayAnalysisResults(errorCodes, container) {
        const existingResults = container.querySelector('.analysis-results');
        if (existingResults) {
            existingResults.remove();
        }
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'analysis-results';    

        // Grafik container
        const chartContainer = document.createElement('div');
        chartContainer.style.marginBottom = '30px';
        chartContainer.style.height = '400px';

        // Tablo container oluştur
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-section';

        // Tablo header
        const tableHeader = document.createElement('div');
        tableHeader.className = 'table-header';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'table-title';
        titleDiv.innerHTML = '📊 Hata Kodları ve Adetleri';
        
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'table-controls';
        
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-button';
        toggleBtn.innerHTML = '<span class="toggle-icon">▼</span> Göster/Gizle';
        
        controlsDiv.appendChild(toggleBtn);
        tableHeader.appendChild(titleDiv);
        tableHeader.appendChild(controlsDiv);

        // Tablo wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        wrapper.style.maxHeight = '500px'; // Tablo yüksekliğini sınırla

        const canvas = document.createElement('canvas');
        canvas.id = 'paretoChart';
        chartContainer.appendChild(canvas);
        resultsDiv.appendChild(chartContainer);

        const errorCount = {};
        errorCodes.forEach(codeString => {
            if (!codeString || codeString === "0") return;

            const matches = codeString.match(/(\d+)\*(\w+)/g);
            if (matches) {
                matches.forEach(match => {
                const [count, code] = match.split('*');
                const normalizedCode = code.toUpperCase();
                errorCount[normalizedCode] = (errorCount[normalizedCode] || 0) + parseInt(count);
                });
        }
    });
    const sortedErrors = Object.entries(errorCount)
        .sort(([, a], [, b]) => b - a);

    const codes = sortedErrors.map(item => item[0]);
    const counts = sortedErrors.map(item => item[1]);

    const total = counts.reduce((a, b) => a + b, 0);
    let cumulative = 0;
    const cumulativePercent = counts.map(val => {
        cumulative += val;
        return ((cumulative / total) * 100).toFixed(2);
    });

    // Eski grafik varsa temizle
    if (window.paretoChart) {
        window.paretoChart.destroy();
    }

    // Yeni grafik oluştur
    const ctx = canvas.getContext('2d');
    window.paretoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: codes,
            datasets: [
                {
                    label: 'Hata Adedi',
                    data: counts,
                    backgroundColor: '#4CAF50',
                    yAxisID: 'y1'
                },
                {
                    label: 'Kümülatif %',
                    data: cumulativePercent,
                    type: 'line',
                    borderColor: '#ff9800',
                    borderWidth: 2,
                    yAxisID: 'y2',
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y1: {
                    beginAtZero: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Hata Adedi'
                    }
                },
                y2: {
                    beginAtZero: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Kümülatif %'
                    },
                    ticks: {
                        callback: value => value + '%'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });

    // Tablo oluşturma
    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Hata Kodu</th>
                <th>Toplam Sayı</th>
            </tr>
        </thead>
        <tbody>
            ${Object.entries(errorCount)
                .sort(([, a], [, b]) => b - a)
                .map(([code, count]) => `
                    <tr>
                        <td>${code}</td>
                        <td>${count}</td>
                    </tr>
                `).join('')}
        </tbody>
    `;

    // Toggle fonksiyonu
    toggleBtn.onclick = () => {
        const isCollapsed = wrapper.classList.contains('collapsed');
        if (isCollapsed) {
            wrapper.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
        } else {
            wrapper.classList.add('collapsed');
            toggleBtn.classList.add('collapsed');
        }
    };

    wrapper.appendChild(table);
    tableContainer.appendChild(tableHeader);
    tableContainer.appendChild(wrapper);
    resultsDiv.appendChild(tableContainer);
    container.appendChild(resultsDiv);    
    }    

    function createTable(headers, rows, tableId, isErrorTable = false) {
      const section = document.createElement('div');
      section.className = 'table-section';

      // Header kısmı
      const tableHeader = document.createElement('div');
      tableHeader.className = `table-header ${isErrorTable ? 'error-header' : ''}`;
      
      const titleDiv = document.createElement('div');
      titleDiv.className = 'table-title';
      
      const icon = isErrorTable ? '❌' : '✅';
      const title = isErrorTable ? 'Hatalı Kayıtlar' : 'Başarılı Kayıtlar';
      
      titleDiv.innerHTML = `
        ${icon} ${title}
        <span class="table-count">${rows.length} kayıt</span>
      `;
      
      // Kontrol butonları container
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'table-controls';
      
      // Export butonu
      const exportBtn = document.createElement('button');
      exportBtn.className = 'export-button';
      exportBtn.innerHTML = '📊 Excel\'e Aktar';
      exportBtn.onclick = () => {
        const fileName = isErrorTable ? 'Hatali_Kayitlar.xlsx' : 'Basarili_Kayitlar.xlsx';
        exportToExcel(headers, rows, fileName);
      };
      
      // Toggle butonu
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'toggle-button';
      toggleBtn.innerHTML = '<span class="toggle-icon">▼</span> Göster/Gizle';
      
      controlsDiv.appendChild(exportBtn);
      controlsDiv.appendChild(toggleBtn);
      
      tableHeader.appendChild(titleDiv);
      tableHeader.appendChild(controlsDiv);

      // Tablo wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      
      // Tablo oluştur
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      tbody.id = tableId + "-body";

      const headerRow = document.createElement('tr');
      headers.forEach((h, idx) => {
        if (!excludedIndexes.includes(idx)) {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        }
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      rows.forEach(row => {
        const tr = document.createElement('tr');
        if (isErrorTable) tr.classList.add("error");
        row.forEach((cell, idx) => {
          if (!excludedIndexes.includes(idx)) {
            const td = document.createElement('td');
            td.textContent = cell !== undefined ? cell : '';
            tr.appendChild(td);
          }
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);

      // Toggle fonksiyonu
      toggleBtn.onclick = () => {
        const isCollapsed = wrapper.classList.contains('collapsed');
        if (isCollapsed) {
          wrapper.classList.remove('collapsed');
          toggleBtn.classList.remove('collapsed');
        } else {
          wrapper.classList.add('collapsed');
          toggleBtn.classList.add('collapsed');
        }
      };

      section.appendChild(tableHeader);
      section.appendChild(wrapper);
      return section;
    }

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const tablesContainer = document.getElementById('tables');

    document.getElementById('mainTableBtn').addEventListener('click', function() {

        tablesContainer.innerHTML = '';

        if (window.processedSuccessRows && window.processedSuccessRows.length > 0) {
        const mainTable = createTable(
            window.processedHeaders, 
            window.processedSuccessRows, 
            "main-table"
        );
        tablesContainer.appendChild(mainTable);
    }
        
        if (window.processedErrorRows && window.processedErrorRows.length > 0) {
        const errTable = createTable(
            window.processedHeaders, 
            window.processedErrorRows, 
            "error-table", 
            true
        );
        tablesContainer.appendChild(errTable);
    }
});

    document.getElementById('analysisBtn').addEventListener('click', function() {
        tablesContainer.innerHTML = '';
    
            // Analiz container oluştur
        const analysisContainer = document.createElement('div');
        analysisContainer.className = 'analysis-container';
        
        // Başlık ekle
        const title = document.createElement('h3');
        title.textContent = 'Hata Kodları Analizi';
        title.style.marginBottom = '20px';
        
        // Filtre container
        const filterContainer = document.createElement('div');
        filterContainer.className = 'date-filter-container';
  
         // Label ve input container'ları
        const startDateContainer = document.createElement('div');
        startDateContainer.className = 'date-input-container';
        const endDateContainer = document.createElement('div');
        endDateContainer.className = 'date-input-container';

        // Başlangıç tarihi label ve input
        const startLabel = document.createElement('label');
        startLabel.textContent = 'Başlangıç Tarihi:';
        const startDateInput = document.createElement('input');
        startDateInput.type = 'text';
        startDateInput.className = 'date-select';
        startDateInput.placeholder = 'Başlangıç Tarihi Seçin';

        // Bitiş tarihi label ve input
        const endLabel = document.createElement('label');
        endLabel.textContent = 'Bitiş Tarihi:';
        const endDateInput = document.createElement('input');
        endDateInput.type = 'text';
        endDateInput.className = 'date-select';
        endDateInput.placeholder = 'Bitiş Tarihi Seçin';

        // En erken ve en geç tarihleri bul
        const dates = window.processedSuccessRows.map(row => {
            const dateParts = row[6].split('.');
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
        });

        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));

        // Flatpickr ayarları
        const flatpickrConfig = {
            dateFormat: "d.m.Y",
            locale: "tr",
            minDate: minDate,
            maxDate: maxDate
        };

        // Başlangıç tarihi için Flatpickr
        const startFp = flatpickr(startDateInput, {
            ...flatpickrConfig,
            defaultDate: minDate,
            onChange: function(selectedDates, dateStr) {
            // Bitiş tarihinin minimum değerini başlangıç tarihine ayarla
            endFp.set('minDate', selectedDates[0]);
              
            // Eğer bitiş tarihi, yeni başlangıç tarihinden önceyse
            if (endFp.selectedDates[0] && selectedDates[0] > endFp.selectedDates[0]) {
                // Bitiş tarihini başlangıç tarihine eşitle
                endFp.setDate(selectedDates[0]);
            }
              
            updateResults();
          }
        });

        // Bitiş tarihi için Flatpickr
        const endFp = flatpickr(endDateInput, {
            ...flatpickrConfig,
            defaultDate: maxDate,
            minDate: minDate,
            onChange: updateResults
        });

        function updateResults() {
            const startDate = startFp.selectedDates[0];
            const endDate = endFp.selectedDates[0];

            if (startDate && endDate) {
                // Seçilen tarih aralığındaki verileri filtrele
                const filteredData = window.processedSuccessRows.filter(row => {
                    const dateParts = row[6].split('.');
                    const rowDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    return rowDate >= startDate && rowDate <= endDate;
                });

                const errorCodes = filteredData.map(row => row[12]);
                
                // Sonuçları göster
                displayAnalysisResults(errorCodes, analysisContainer);
            }
        }

        // Input'ları container'lara ekle
        startDateContainer.appendChild(startLabel);
        startDateContainer.appendChild(startDateInput);
        endDateContainer.appendChild(endLabel);
        endDateContainer.appendChild(endDateInput);

        // Container'ları ana filter container'a ekle
        filterContainer.appendChild(startDateContainer);
        filterContainer.appendChild(endDateContainer);

        // Her şeyi ana container'a ekle
        analysisContainer.appendChild(title);
        analysisContainer.appendChild(filterContainer);
        
        tablesContainer.appendChild(analysisContainer);

        // İlk sonuçları göster
        updateResults();
    });

    document.getElementById('reportsBtn').addEventListener('click', function() {
      tablesContainer.innerHTML = '';

      const reportsContainer = document.createElement('div');
      reportsContainer.className = 'analysis-container';
      
      const title = document.createElement('h3');
      title.textContent = 'Raporlar';
      title.style.marginBottom = '20px';

      const reportsGrid = document.createElement('div');
      reportsGrid.className = 'reports-grid';

      const reportCards = [
        { title: 'Haftalık', description: 'Haftalara göre detaylı rapor analizi', type:'weekly' },
        { title: 'Aylık', description: 'Aylara göre detaylı rapor analizi', type:'monthly' }
      ];

      reportCards.forEach(report => {
        const card = document.createElement('div');
        card.className = 'report-card';
        card.innerHTML = `
            <h4>${report.title}</h4>
            <p>${report.description}</p>
            <button class="report-btn" data-type="${report.type}">Raporu Görüntüle</button>
        `;
        const reportBtn = card.querySelector('.report-btn');
        // reportBtn event listener'ını güncelleyelim
        reportBtn.addEventListener('click', function() {
            if (this.dataset.type === 'weekly') {
                if (!window.processedSuccessRows || window.processedSuccessRows.length === 0) {
                    reportsContainer.innerHTML = '';
                    const messageTitle = document.createElement('h3');
                    messageTitle.style.textAlign = 'center';
                    messageTitle.style.marginTop = '50px';
                    messageTitle.textContent = 'Lütfen önce bir Excel dosyası yükleyin.';
                    reportsContainer.appendChild(messageTitle);
                    return;
                }
                
                reportsContainer.innerHTML = '';

                const title = document.createElement('h3');
                title.textContent = 'Haftalık Rapor';
                title.style.marginBottom = '20px';
                reportsContainer.appendChild(title);

                const weekSelect = document.createElement('select');
                weekSelect.className = 'date-select';

                // 3. Haftaları al ve seçici içeriğini oluştur
                const weeks = [...new Set(window.processedSuccessRows.map(row => 
                    getWeekFromDate(row[6])
                ))].sort();

                weekSelect.innerHTML = `
                    <option value="">Tüm Haftalar</option>
                    ${weeks.map(week => `<option value="${week}">${week}</option>`).join('')}
                `;
                const weekSelectContainer = document.createElement('div');
                weekSelectContainer.className = 'date-filter-container';
                weekSelectContainer.appendChild(weekSelect);

                const tableTypeSelect = document.createElement('select');
                tableTypeSelect.className = 'date-select';
                tableTypeSelect.style.marginLeft = '20px';  // Hafta seçiciden sonra boşluk bırakmak için
                tableTypeSelect.innerHTML = `
                    <option value="BOTH">SVC-DMS</option>
                    <option value="SVC">SVC</option>
                    <option value="DMS">DMS</option>
                `;

                weekSelectContainer.appendChild(tableTypeSelect);

                // Tablo tipi değiştiğinde mevcut tabloları güncelle
                tableTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    const tables = document.querySelectorAll('.weekly-report-table');
                    const titles = document.querySelectorAll('h4');
                    
                    tables.forEach((table, index) => {
                        const title = titles[index];
                        const tableType = title.textContent;
                        
                        if (selectedType === 'BOTH' || 
                            (selectedType === 'SVC' && tableType === 'SVC') || 
                            (selectedType === 'DMS' && tableType === 'DMS')) {
                            table.style.display = '';
                            title.style.display = '';
                        } else {
                            table.style.display = 'none';
                            title.style.display = 'none';
                        }
                    });
                });
                reportsContainer.appendChild(weekSelectContainer);
                
                // Benzersiz proses adlarını al (6. sütun)
                const processes = [
                    'SMD BOT',
                    'SMD TOP',
                    'TH Lehimleme',
                    'Panel Test',
                    'Depaneling',
                    'Vidalama',
                    'Lens AA',
                    'Sızdırmazlık',
                    'EOL Flaş',
                    'EOL',
                    'Lazer Markalama'
                ];
                weekSelect.addEventListener('change', function() {
                    const selectedWeek = this.value;
                    const selectedType = tableTypeSelect.value; // Default olarak "SVC" gelecek

                    
                    const existingTables = reportsContainer.querySelectorAll('.weekly-report-table');
                    const existingTitles = reportsContainer.querySelectorAll('h4');
                    existingTables.forEach(table => table.remove());
                    existingTitles.forEach(title => title.remove());

                    const tablesToShow = selectedType === 'BOTH' ? ['SVC', 'DMS'] : [selectedType];

                // Tablo oluştur
                ['SVC', 'DMS'].forEach(tableType => {
                    const tableTitle = document.createElement('h4');
                    tableTitle.textContent = `${tableType}`;
                    tableTitle.style.marginTop = '30px';
                    tableTitle.style.marginBottom = '15px';

                    let filteredData = window.processedSuccessRows.filter(row => 
                        row[7] && row[7].toUpperCase() === tableType
                    );
                    if (selectedWeek) {
                        filteredData = filteredData.filter(row => 
                            getWeekFromDate(row[6]) === selectedWeek
                        );
                    }
                
                const table = document.createElement('table');
                table.className = 'weekly-report-table';
                
                // Tablo başlıkları
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Prosesler</th>
                            <th>OK Adet</th>
                            <th>Scrap Adet</th>
                            <th>Total NOK Adet</th>
                            <th>Yüzde NOK</th>
                            <th>Açıklama</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processes.map(process => {
                          // Her proses için verileri filtrele
                          const processData = filteredData.filter(row => 
                              row[8] && row[8].toUpperCase() === process.toUpperCase()
                          );

                          // 11. sütundaki OK Adet değerlerini topla
                          const okTotal = processData.reduce((total, row) => {
                              const okCount = parseInt(row[11]) || 0;
                              return total + okCount;
                          }, 0);

                          const nokTotal = processData.reduce((total, row) => {
                              if (!row[12] || row[12] === "0") return total;
                              const matches = row[12].match(/(\d+)\*\w+/g) || [];
                              const nokCount = matches.reduce((sum, match) => {
                                  const count = parseInt(match.split('*')[0]);
                                  return sum + (count || 0);
                              }, 0);
                              
                              return total + nokCount;
                          }, 0);
                          
                          const nokPercentage = okTotal > 0 ? ((nokTotal / okTotal) * 100).toFixed(2) : '0.00';

                          return `
                            <tr>
                                <td>${process}</td>
                                <td>${okTotal || '0'}</td>
                                <td><input type="number" min="0" 
                                    class="scrap-input" 
                                    value="0" 
                                    style="width: 60px; padding: 8px;"
                                    onblur="this.value = this.value || '0'"
                                    onchange="updateNokPercentage(this)"
                                    data-ok="${okTotal}"
                                    data-nok="${nokTotal}"></td>
                                <td>${nokTotal || '0'}</td>
                                <td>${nokPercentage}%</td>
                                <td style="white-space: pre-line;">${parseErrorCodes(processData.map(row => row[12]).join('+'))}</td>
                            </tr>
                          `;  
                      }).join('')}
                    </tbody>
                `;
                reportsContainer.appendChild(tableTitle);
                reportsContainer.appendChild(table);
              });
            }); 

                // CSS stil ekle
                const style = document.createElement('style');
                style.textContent = `
                    .weekly-report-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                        background: white;
                        margin-bottom: 40px;
                    }
                    .weekly-report-table th,
                    .weekly-report-table td {
                        padding: 12px;
                        border: 1px solid var(--border);
                        text-align: left;
                    }
                    .weekly-report-table th:first-child,
                    .weekly-report-table td:first-child {
                        width: 120px;  /* Başlık 1 sütunu için genişlik */
                        min-width: 120px; 
                        max-width: 120px; 
                    }
                    .weekly-report-table th:nth-child(2),
                    .weekly-report-table td:nth-child(2),
                    .weekly-report-table th:nth-child(3),
                    .weekly-report-table td:nth-child(3),
                    .weekly-report-table th:nth-child(4),
                    .weekly-report-table td:nth-child(4),
                    .weekly-report-table th:nth-child(5),
                    .weekly-report-table td:nth-child(5) {
                        width: 80px;
                        min-width: 80px;
                        max-width: 80px; 
                    }              
                    .weekly-report-table th {
                        background: #f5f5f5;
                        font-weight: 600;
                    }
                    .weekly-report-table tr:hover {
                        background: #f9f9f9;
                    }
                `;
                document.head.appendChild(style);

                weekSelect.dispatchEvent(new Event('change'));
            } else {
                reportsContainer.innerHTML = '';
                const messageTitle = document.createElement('h3');
                messageTitle.style.textAlign = 'center';
                messageTitle.style.marginTop = '50px';
                messageTitle.textContent = 'Aylık Raporlar Yakında Eklenecek';
                reportsContainer.appendChild(messageTitle);
            }
        });
        
        reportsGrid.appendChild(card);
      });
      reportsContainer.appendChild(title);
      reportsContainer.appendChild(reportsGrid);
      tablesContainer.appendChild(reportsContainer);
    });
    // Drag and drop olayları
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFile(e.dataTransfer.files[0]);
    });

    // File input değişiklik olayı
    fileInput.addEventListener('change', e => {
      if (e.target.files[0]) {
        handleFile(e.target.files[0]);
      }
    });

    // Drop zone tıklama olayı - dosya input'unu temizle
    dropZone.addEventListener('click', (e) => {
      // Eğer tıklama file input'un kendisinden geliyorsa, hiçbir şey yapma
      if (e.target === fileInput) return;
      
      // File input'u temizle ve tıkla
      fileInput.value = '';
      fileInput.click();
    });
    function updateNokPercentage(input) {
        const row = input.closest('tr');
        const scrapValue = parseInt(input.value) || 0;
        const nokCell = row.cells[3];
        const nokValue = parseInt(nokCell.textContent) || 0;
        const percentageCell = row.cells[4];
        const okTotal = parseInt(input.dataset.ok) || 0;
        const totalNOK = nokValue + scrapValue;
        const newPercentage = okTotal > 0 ? ((totalNOK / okTotal) * 100).toFixed(2) : '0.00';
        percentageCell.textContent = `${newPercentage}%`;
    }

    function handleFile(file) {
      if (!file) return;

      document.getElementById('buttonContainer').style.display = 'none';

      showProgress();
      tablesContainer.innerHTML = '';

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headers = json[0];
        const successRows = [];
        const errorRows = [];
        let successCount = 0;
        let errorCount = 0;
        const totalRows = json.length - 1;

        // İlerleme göstergesi için batch işleme
        function processRows(startIndex) {
          const batchSize = 50;
          const endIndex = Math.min(startIndex + batchSize, json.length);

          for (let i = startIndex; i < endIndex; i++) {
            const row = json[i];
            if (i === 0) { // Header satırı için kontrol etme
                    continue;
                }
                
                // Email kontrolü (4. sütun) ve ID kontrolü (1. sütun)
            if (row[3] === "alihanaykanat@buyutech.com.tr" || 
                (typeof row[0] === 'number' && row[0] < 189)) {
                continue; // Bu satırı atla
                }
            const newRow = [...row];
            let isError = false;

            try {
              if (typeof row[6] === 'number') {
                const dateObj = excelDateToJSDate(row[6]);
                const formatted = dateObj.toLocaleDateString('tr-TR');
                newRow[6] = formatted;
                if (!isValidDateFormat(formatted)) isError = true;
              }

              [9, 10].forEach(idx => {
                if (typeof row[idx] === 'number') {
                  const hourDecimal = row[idx] * 24;
                  const hh = String(Math.floor(hourDecimal)).padStart(2, '0');
                  const mm = String(Math.round((hourDecimal % 1) * 60)).padStart(2, '0');
                  newRow[idx] = `${hh}:${mm}`;
                } else if (typeof row[idx] === 'string') {
                  newRow[idx] = row[idx];
                }
                if (!isTimeStringValid(newRow[idx])) isError = true;
              });

              if (!isPatternValid(newRow[12], Hatalar_list)) isError = true;
              if (!isPatternValid(newRow[14], Duruslar_list)) isError = true;

            } catch (err) {
              console.error(`Satır ${i + 1} hatalı:`, err);
              isError = true;
            }

            if (isError) {
              errorRows.push(newRow);
              errorCount++;
            } else {
              successRows.push(newRow);
              successCount++;
            }
          }

          updateProgress(endIndex - 1, totalRows);

          if (endIndex < json.length) {
            // Sonraki batch'i işlemek için kısa bir bekleme
            setTimeout(() => processRows(endIndex), 10);
          } else {
            // İşlem tamamlandı
            finishProcessing();
          }
        }

        function finishProcessing() {
          hideProgress();

          document.getElementById('buttonContainer').style.display = 'flex';

          window.processedHeaders = headers;
          window.processedSuccessRows = successRows;
          window.processedErrorRows = errorRows;

          // Dosya işlemi tamamlandıktan sonra input'u temizle
          fileInput.value = '';
        }

        // İşleme başla
        if (totalRows > 0) {
          processRows(1);
        } else {
          hideProgress();
          fileInput.value = '';
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
document.getElementById('analysisBtn').addEventListener('click', function() {
        tablesContainer.innerHTML = '';
    
        const analysisContainer = document.createElement('div');
        analysisContainer.className = 'analysis-container';
        
        const title = document.createElement('h3');
        title.textContent = 'Hata Kodları Analizi';
        title.style.marginBottom = '20px';
        
        const filterContainer = document.createElement('div');
        filterContainer.className = 'date-filter-container';
  
        const startDateContainer = document.createElement('div');
        startDateContainer.className = 'date-input-container';
        const endDateContainer = document.createElement('div');
        endDateContainer.className = 'date-input-container';

        const startLabel = document.createElement('label');
        startLabel.textContent = 'Başlangıç Tarihi:';
        const startDateInput = document.createElement('input');
        startDateInput.type = 'text';
        startDateInput.className = 'date-select';
        startDateInput.placeholder = 'Başlangıç Tarihi Seçin';

        const endLabel = document.createElement('label');
        endLabel.textContent = 'Bitiş Tarihi:';
        const endDateInput = document.createElement('input');
        endDateInput.type = 'text';
        endDateInput.className = 'date-select';
        endDateInput.placeholder = 'Bitiş Tarihi Seçin';

        const dates = window.processedSuccessRows.map(row => {
            const dateParts = row[6].split('.');
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
        });

        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const flatpickrConfig = {
            dateFormat: "d.m.Y",
            locale: "tr",
            minDate: minDate,
            maxDate: maxDate
        };

        const startFp = flatpickr(startDateInput, {
            ...flatpickrConfig,
            defaultDate: minDate,
            onChange: function(selectedDates, dateStr) {
            endFp.set('minDate', selectedDates[0]);
              
            if (endFp.selectedDates[0] && selectedDates[0] > endFp.selectedDates[0]) {
                endFp.setDate(selectedDates[0]);
            }
              
            updateResults();
          }
        });

        const endFp = flatpickr(endDateInput, {
            ...flatpickrConfig,
            defaultDate: maxDate,
            minDate: minDate,
            onChange: updateResults
        });

        function updateResults() {
            const startDate = startFp.selectedDates[0];
            const endDate = endFp.selectedDates[0];

            if (startDate && endDate) {
                const filteredData = window.processedSuccessRows.filter(row => {
                    const dateParts = row[6].split('.');
                    const rowDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    return rowDate >= startDate && rowDate <= endDate;
                });
                const errorCodes = filteredData.map(row => row[12]);
                displayAnalysisResults(errorCodes, analysisContainer);
            }
        }
        startDateContainer.appendChild(startLabel);
        startDateContainer.appendChild(startDateInput);
        endDateContainer.appendChild(endLabel);
        endDateContainer.appendChild(endDateInput);
        filterContainer.appendChild(startDateContainer);
        filterContainer.appendChild(endDateContainer);
        analysisContainer.appendChild(title);
        analysisContainer.appendChild(filterContainer);
        
        tablesContainer.appendChild(analysisContainer);

        updateResults();
    });

    document.getElementById('reportsBtn').addEventListener('click', function() {
      tablesContainer.innerHTML = '';

      const reportsContainer = document.createElement('div');
      reportsContainer.className = 'analysis-container';
      
      const title = document.createElement('h3');
      title.textContent = 'Raporlar';
      title.style.marginBottom = '20px';

      const reportsGrid = document.createElement('div');
      reportsGrid.className = 'reports-grid';

      const reportCards = [
        { title: 'Haftalık', description: 'Haftalara göre detaylı rapor analizi', type:'weekly' },
        { title: 'Aylık', description: 'Aylara göre detaylı rapor analizi', type:'monthly' }
      ];
      reportCards.forEach(report => {
        const card = document.createElement('div');
        card.className = 'report-card';
        card.innerHTML = `
            <h4>${report.title}</h4>
            <p>${report.description}</p>
            <button class="report-btn" data-type="${report.type}">Raporu Görüntüle</button>
        `;
        const reportBtn = card.querySelector('.report-btn');
        reportBtn.addEventListener('click', function() {
            if (this.dataset.type === 'weekly') {
                if (!window.processedSuccessRows || window.processedSuccessRows.length === 0) {
                    reportsContainer.innerHTML = '';
                    const messageTitle = document.createElement('h3');
                    messageTitle.style.textAlign = 'center';
                    messageTitle.style.marginTop = '50px';
                    messageTitle.textContent = 'Lütfen önce bir Excel dosyası yükleyin.';
                    reportsContainer.appendChild(messageTitle);
                    return;
                }
                reportsContainer.innerHTML = '';
                const title = document.createElement('h3');
                title.textContent = 'Haftalık Rapor';
                title.style.marginBottom = '20px';
                reportsContainer.appendChild(title);

                const weekSelect = document.createElement('select');
                weekSelect.className = 'date-select';

                const weeks = [...new Set(window.processedSuccessRows.map(row =>
                    getWeekFromDate(row[6])
                ))].sort((a, b) => {
                    const [yearA, weekA] = a.split('-W').map(Number);
                    const [yearB, weekB] = b.split('-W').map(Number);

                    if (yearA === yearB) {
                        return weekA - weekB;
                    } else {
                        return yearA - yearB;
                    }
                });

                weekSelect.innerHTML = `
                    <option value="">Tüm Haftalar</option>
                    ${weeks.map(week => `<option value="${week}">${week}</option>`).join('')}
                `;
                const weekSelectContainer = document.createElement('div');
                weekSelectContainer.className = 'date-filter-container';
                weekSelectContainer.appendChild(weekSelect);

                // Dinamik marka listesini oluştur
                const allBrands = [...new Set(window.processedSuccessRows.map(row => 
                    row[7]?.toUpperCase()
                ))].filter(Boolean).sort();

                const tableTypeSelect = document.createElement('select');
                tableTypeSelect.className = 'date-select';
                tableTypeSelect.style.marginLeft = '20px';
                
                // Dinamik options oluştur
                let selectOptions = '<option value="ALL">Tüm Markalar</option>';
                allBrands.forEach(brand => {
                    selectOptions += `<option value="${brand}">${brand}</option>`;
                });
                tableTypeSelect.innerHTML = selectOptions;

                weekSelectContainer.appendChild(tableTypeSelect);

                const exportControls = document.createElement('div');
                exportControls.className = 'export-controls';
                exportControls.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-left: auto;
                    gap: 15px;
                `;

                const checkboxContainer = document.createElement('div');
                checkboxContainer.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;
                const excelLabel = document.createElement('label');
                excelLabel.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                `;
                const excelCheckbox = document.createElement('input');
                excelCheckbox.type = 'radio';
                excelCheckbox.name = 'exportType';
                excelCheckbox.value = 'excel';
                excelCheckbox.style.cursor = 'pointer';
                excelLabel.appendChild(excelCheckbox);
                excelLabel.appendChild(document.createTextNode('Excel'));

                const pdfLabel = document.createElement('label');
                pdfLabel.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                `;
                const pdfCheckbox = document.createElement('input');
                pdfCheckbox.type = 'radio';
                pdfCheckbox.name = 'exportType';
                pdfCheckbox.value = 'pdf';
                pdfCheckbox.style.cursor = 'pointer';
                pdfLabel.appendChild(pdfCheckbox);
                pdfLabel.appendChild(document.createTextNode('PDF'));

                const exportButton = document.createElement('button');
                exportButton.textContent = 'Dışa Aktar';
                exportButton.className = 'export-button';
                exportButton.style.cssText = `
                    padding: 8px 16px; 
                    background-color: #4CAF50; 
                    color: white; border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 14px;`;
                exportButton.addEventListener('click', function() {
                    const selectedFormat = document.querySelector('input[name="exportType"]:checked')?.value;
                    const selectedWeek = weekSelect.value;
                    const selectedType = tableTypeSelect.value;
                    const tables = document.querySelectorAll('.weekly-report-table');
                    const today = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');

                    if (selectedFormat === 'excel') {
                        const wb = XLSX.utils.book_new();
                        
                        tables.forEach((table, index) => {
                            if (table.style.display !== 'none') {
                                // Tablo başlığını al
                                const tableTitle = table.previousElementSibling;
                                const tableName = tableTitle ? tableTitle.textContent : `Tablo_${index + 1}`;
                                
                                const ws_data = [];
                                
                                // Başlık bilgisini ekle
                                ws_data.push([`${tableName} - Haftalık Rapor: ${selectedWeek || 'Tüm Haftalar'}`]);
                                ws_data.push([]); // Boş satır
                                
                                // Tablo başlıkları
                                const headers = [];
                                table.querySelectorAll('thead th').forEach(th => {
                                    headers.push(th.textContent);
                                });
                                ws_data.push(headers);
                                
                                // Tablo verileri
                                table.querySelectorAll('tbody tr').forEach(tr => {
                                    const row = [];
                                    tr.querySelectorAll('td').forEach((td, i) => {
                                        if (i === 2) { 
                                            const inputValue = td.querySelector('input')?.value || '0';
                                            row.push(inputValue);
                                        } else {
                                            row.push(td.textContent || '');
                                        }
                                    });
                                    ws_data.push(row);
                                });
                                
                                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                                XLSX.utils.book_append_sheet(wb, ws, tableName);
                            }
                        });
                        XLSX.writeFile(wb, `Haftalik_Rapor_${selectedWeek || 'Tum'}_${today}.xlsx`);
                        
                    } else if (selectedFormat === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'landscape' });
                        let currentY = 20;
                        let pageCount = 0;

                        tables.forEach((table, index) => {
                            if (table.style.display !== 'none') {
                                if (pageCount > 0) {
                                    doc.addPage();
                                    currentY = 20;
                                }
                                
                                // Tablo başlığını al
                                const tableTitle = table.previousElementSibling;
                                const tableName = tableTitle ? tableTitle.textContent : `Tablo ${index + 1}`;
                                
                                doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
                                doc.setFont("Roboto");
                                
                                doc.text(`${tableName} - Haftalık Rapor: ${selectedWeek || 'Tüm Haftalar'}`, 14, currentY);

                                doc.autoTable({
                                    html: table,
                                    startY: currentY + 5,
                                    theme: 'striped',
                                    styles: {
                                        font: 'Roboto',   
                                        fontStyle: 'normal',
                                        fontSize: 10,
                                        cellPadding: 2
                                    },
                                    headStyles: {
                                        font: 'Roboto',
                                        fontStyle: 'bold',
                                        fontSize: 11,
                                        fillColor: [76, 175, 80] 
                                    },
                                    margin: { left: 14, right: 14 },
                                    didDrawPage: function (data) {
                                        currentY = data.cursor.y + 15;
                                    }
                                });
                                pageCount++;
                            }
                        });

                        doc.save(`Haftalik_Rapor_${selectedWeek || 'Tum'}_${today}.pdf`);
                    }
                });

                checkboxContainer.appendChild(excelLabel);
                checkboxContainer.appendChild(pdfLabel);
                exportControls.appendChild(checkboxContainer);
                exportControls.appendChild(exportButton);
                weekSelectContainer.appendChild(exportControls);

                reportsContainer.appendChild(weekSelectContainer);
                
                const processes = [
                    'SMD BOT',
                    'SMD TOP',
                    'TH Lehimleme',
                    'Panel Test',
                    'Depaneling',
                    'Vidalama',
                    'Lens AA',
                    'Sızdırmazlık',
                    'EOL Flaş',
                    'EOL',
                    'Lazer Markalama',
                    'Son Kontrol',
                ];

                // Change event listener'ını güncelle
                const changeHandler = function() {
                    const selectedWeek = weekSelect.value;
                    const selectedType = tableTypeSelect.value;
                    const existingTables = reportsContainer.querySelectorAll('.weekly-report-table');
                    const existingTitles = reportsContainer.querySelectorAll('h4');
                    existingTables.forEach(table => table.remove());
                    existingTitles.forEach(title => title.remove());

                    // Gösterilecek markaları belirle
                    const tablesToShow = selectedType === 'ALL' 
                        ? allBrands 
                        : allBrands.filter(brand => brand === selectedType);

                    tablesToShow.forEach(tableType => {
                        const tableTitle = document.createElement('h4');
                        tableTitle.textContent = `${tableType}`;
                        tableTitle.style.marginTop = '30px';
                        tableTitle.style.marginBottom = '15px';

                        let filteredData = window.processedSuccessRows.filter(row =>
                            row[7] && row[7].toUpperCase() === tableType
                        );
                        
                        if (selectedWeek) {
                            filteredData = filteredData.filter(row =>
                                getWeekFromDate(row[6]) === selectedWeek
                            );
                        }
                    
                        const table = document.createElement('table');
                        table.className = 'weekly-report-table';
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Prosesler</th>
                                    <th>OK Adet</th>
                                    <th>Scrap Adet</th>
                                    <th>Total NOK Adet</th>
                                    <th>Yüzde NOK</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${processes.map(process => {
                                    const processData = filteredData.filter(row => 
                                        row[8] && row[8].toUpperCase() === process.toUpperCase()
                                    );
                                    const okTotal = processData.reduce((total, row) => {
                                        const okCount = parseInt(row[11]) || 0;
                                        return total + okCount;
                                    }, 0);
                                    const nokTotal = processData.reduce((total, row) => {
                                        if (!row[12] || row[12] === "0") return total;
                                        const matches = row[12].match(/(\d+)\*\w+/g) || [];
                                        const nokCount = matches.reduce((sum, match) => {
                                            const count = parseInt(match.split('*')[0]);
                                            return sum + (count || 0);
                                        }, 0);
                                        return total + nokCount;
                                    }, 0);
                                    const nokPercentage = (okTotal + nokTotal) > 0 ? ((nokTotal / (okTotal + nokTotal)) * 100).toFixed(2) : '0.00';
                                    return `
                                        <tr>
                                            <td>${process}</td>
                                            <td>${okTotal || '0'}</td>
                                            <td><input type="number" min="0" 
                                                class="scrap-input" 
                                                value="0" 
                                                style="width: 60px; padding: 8px;"
                                                onblur="this.value = this.value || '0'"></td>
                                            <td>${nokTotal || '0'}</td>
                                            <td>${nokPercentage}%</td>
                                            <td style="white-space: pre-line;">${parseErrorCodes(processData.map(row => row[12]).join('+'))}</td>
                                        </tr>
                                    `;  
                                }).join('')}
                            </tbody>
                        `;
                        reportsContainer.appendChild(tableTitle);
                        reportsContainer.appendChild(table);
                    });
                }; 
                
                weekSelect.addEventListener('change', changeHandler);
                tableTypeSelect.addEventListener('change', changeHandler);
                weekSelect.dispatchEvent(new Event('change'));

            } else if (this.dataset.type === 'monthly') {
                if (!window.processedSuccessRows || window.processedSuccessRows.length === 0) {
                    reportsContainer.innerHTML = '';
                    const messageTitle = document.createElement('h3');
                    messageTitle.style.textAlign = 'center';
                    messageTitle.style.marginTop = '50px';
                    messageTitle.textContent = 'Lütfen önce bir Excel dosyası yükleyin.';
                    reportsContainer.appendChild(messageTitle);
                    return;
                }
                reportsContainer.innerHTML = '';
                const title = document.createElement('h3');
                title.textContent = 'Aylık Rapor';
                title.style.marginBottom = '20px';
                reportsContainer.appendChild(title);
                
                const monthSelect = document.createElement('select');
                monthSelect.className = 'date-select';
                const monthYears = [...new Set(window.processedSuccessRows.map(row => 
                    getMonthYear(row[6])
                ))].sort((a, b) => {
                    const [monthA, yearA] = a.split(' ');
                    const [monthB, yearB] = b.split(' ');
                    const yearDiff = parseInt(yearA) - parseInt(yearB);
                    if (yearDiff !== 0) return yearDiff;
                    const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                                  'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                    return months.indexOf(monthA) - months.indexOf(monthB);
                });

                monthSelect.innerHTML = `
                    <option value="">Tüm Aylar</option>
                    ${monthYears.map(month => `<option value="${month}">${month}</option>`).join('')}
                `;
                const monthSelectContainer = document.createElement('div');
                monthSelectContainer.className = 'date-filter-container';
                monthSelectContainer.appendChild(monthSelect);
                
                // Dinamik marka listesini oluştur (aylık için de)
                const allBrands = [...new Set(window.processedSuccessRows.map(row => 
                    row[7]?.toUpperCase()
                ))].filter(Boolean).sort();

                const tableTypeSelect = document.createElement('select');
                tableTypeSelect.className = 'date-select';
                tableTypeSelect.style.marginLeft = '20px';
                
                // Dinamik options oluştur
                let selectOptions = '<option value="ALL">Tüm Markalar</option>';
                allBrands.forEach(brand => {
                    selectOptions += `<option value="${brand}">${brand}</option>`;
                });
                tableTypeSelect.innerHTML = selectOptions;
                
                monthSelectContainer.appendChild(tableTypeSelect);
                
                const exportControls = document.createElement('div');
                exportControls.className = 'export-controls';
                exportControls.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-left: auto;
                    gap: 15px;
                `;
                const checkboxContainer = document.createElement('div');
                checkboxContainer.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;
                const excelLabel = document.createElement('label');
                excelLabel.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                `;
                const excelRadio = document.createElement('input');
                excelRadio.type = 'radio';
                excelRadio.name = 'monthlyExportType';
                excelRadio.value = 'excel';
                excelRadio.style.cursor = 'pointer';
                excelLabel.appendChild(excelRadio);
                excelLabel.appendChild(document.createTextNode('Excel'));
                
                const pdfLabel = document.createElement('label');
                pdfLabel.style.cssText = `
                    display: flex; align-items: center; gap: 5px; cursor: pointer;`;
                const pdfRadio = document.createElement('input');
                pdfRadio.type = 'radio';
                pdfRadio.name = 'monthlyExportType';
                pdfRadio.value = 'pdf';
                pdfRadio.style.cursor = 'pointer';
                pdfLabel.appendChild(pdfRadio);
                pdfLabel.appendChild(document.createTextNode('PDF'));

                checkboxContainer.appendChild(excelLabel);
                checkboxContainer.appendChild(pdfLabel);
                
                const exportButton = document.createElement('button');
                exportButton.textContent = 'Dışa Aktar';
                exportButton.className = 'export-button';
                exportButton.style.cssText = `
                    padding: 8px 16px;
                    background-color: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                exportButton.addEventListener('click', function () {
                    const selectedFormat = document.querySelector('input[name="monthlyExportType"]:checked')?.value;
                    const selectedMonth = monthSelect.value;
                    const selectedType = tableTypeSelect.value;
                    const tables = document.querySelectorAll('.weekly-report-table');
                    const today = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');

                    if (selectedFormat === 'excel') {
                        const wb = XLSX.utils.book_new();

                        tables.forEach((table, index) => {
                            if (table.style.display !== 'none') {
                                // Tablo başlığını al
                                const tableTitle = table.previousElementSibling;
                                const tableName = tableTitle ? tableTitle.textContent : `Tablo_${index + 1}`;
                                
                                const ws_data = [];
                                
                                // Başlık bilgisini ekle
                                ws_data.push([`${tableName} - Aylık Rapor: ${selectedMonth || 'Tüm Aylar'}`]);
                                ws_data.push([]); // Boş satır
                                
                                // Tablo başlıkları
                                const headers = [];
                                table.querySelectorAll('thead th').forEach(th => {
                                    headers.push(th.textContent);
                                });
                                ws_data.push(headers);

                                // Tablo verileri
                                table.querySelectorAll('tbody tr').forEach(tr => {
                                    const row = [];
                                    tr.querySelectorAll('td').forEach((td, i) => {
                                        if (i === 2) {
                                            const inputValue = td.querySelector('input')?.value || '0';
                                            row.push(inputValue);
                                        } else {
                                            row.push(td.textContent || '');
                                        }
                                    });
                                    ws_data.push(row);
                                });

                                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                                XLSX.utils.book_append_sheet(wb, ws, tableName);
                            }
                        });

                        XLSX.writeFile(wb, `Aylik_Rapor_${selectedMonth || 'Tum'}_${today}.xlsx`);
                        
                    } else if (selectedFormat === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'landscape' });
                        let currentY = 20;
                        let pageCount = 0;
                        
                        tables.forEach((table, index) => {
                            if (table.style.display !== 'none') {
                                if (pageCount > 0) {
                                    doc.addPage();
                                    currentY = 20;
                                }
                                
                                // Tablo başlığını al
                                const tableTitle = table.previousElementSibling;
                                const tableName = tableTitle ? tableTitle.textContent : `Tablo ${index + 1}`;
                                
                                doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
                                doc.setFont("Roboto");
                                doc.text(`${tableName} - Aylık Rapor: ${selectedMonth || 'Tüm Aylar'}`, 14, currentY);

                                doc.autoTable({
                                    html: table,
                                    startY: currentY + 5,
                                    theme: 'striped',
                                    styles: { 
                                        font: 'Roboto',   
                                        fontStyle: 'normal',
                                        fontSize: 10,
                                        cellPadding: 2
                                    },
                                    headStyles: { 
                                        font: 'Roboto',
                                        fontStyle: 'bold',
                                        fontSize: 11,
                                        fillColor: [76, 175, 80] 
                                    },
                                    margin: { left: 14, right: 14 },
                                    didDrawPage: function (data) {
                                        currentY = data.cursor.y + 15;
                                    } 
                                });
                                pageCount++;
                            }
                        });

                        doc.save(`Aylik_Rapor_${selectedMonth || 'Tum'}_${today}.pdf`);
                    }                  
                });

                exportControls.appendChild(checkboxContainer);
                exportControls.appendChild(exportButton);
                monthSelectContainer.appendChild(exportControls);
                reportsContainer.appendChild(monthSelectContainer);

                const processes = [
                    'SMD BOT',
                    'SMD TOP',
                    'TH Lehimleme',
                    'Panel Test',
                    'Depaneling',
                    'Vidalama',
                    'Lens AA',
                    'Sızdırmazlık',
                    'EOL Flaş',
                    'EOL',
                    'Lazer Markalama',
                    'Son Kontrol',
                ];

                // Change event listener'ını güncelle (aylık için)
                const monthlyChangeHandler = function() {
                    const selectedMonth = monthSelect.value;
                    const selectedType = tableTypeSelect.value;
                    const existingTables = reportsContainer.querySelectorAll('.weekly-report-table');
                    const existingTitles = reportsContainer.querySelectorAll('h4');
                    existingTables.forEach(table => table.remove());
                    existingTitles.forEach(title => title.remove());

                    // Gösterilecek markaları belirle
                    const tablesToShow = selectedType === 'ALL' 
                        ? allBrands 
                        : allBrands.filter(brand => brand === selectedType);

                    tablesToShow.forEach(tableType => {
                        const tableTitle = document.createElement('h4');
                        tableTitle.textContent = `${tableType}`;
                        tableTitle.style.marginTop = '30px';
                        tableTitle.style.marginBottom = '15px';

                        let filteredData = window.processedSuccessRows.filter(row => 
                            row[7] && row[7].toUpperCase() === tableType
                        );

                        if (selectedMonth) {
                            filteredData = filteredData.filter(row => 
                                getMonthYear(row[6]) === selectedMonth
                            );
                        }
                        
                        const table = document.createElement('table');
                        table.className = 'weekly-report-table';
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Prosesler</th>
                                    <th>OK Adet</th>
                                    <th>Scrap Adet</th>
                                    <th>Total NOK Adet</th>
                                    <th>Yüzde NOK</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${processes.map(process => {
                                    const processData = filteredData.filter(row => 
                                        row[8] && row[8].toUpperCase() === process.toUpperCase()
                                    );
                                    const okTotal = processData.reduce((total, row) => {
                                        const okCount = parseInt(row[11]) || 0;
                                        return total + okCount;
                                    }, 0);
                                    const nokTotal = processData.reduce((total, row) => {
                                        if (!row[12] || row[12] === "0") return total;
                                        const matches = row[12].match(/(\d+)\*\w+/g) || [];
                                        return total + matches.reduce((sum, match) => 
                                            sum + (parseInt(match.split('*')[0]) || 0), 0);
                                    }, 0);
                                    const nokPercentage = (okTotal + nokTotal) > 0 ? ((nokTotal / (okTotal + nokTotal)) * 100).toFixed(2) : '0.00';
                                    return `
                                        <tr>
                                            <td>${process}</td>
                                            <td>${okTotal || '0'}</td>
                                            <td><input type="number" min="0" 
                                                class="scrap-input" 
                                                value="0" 
                                                style="width: 60px; padding: 8px;"
                                                onblur="this.value = this.value || '0'"></td>
                                            <td>${nokTotal || '0'}</td>
                                            <td>${nokPercentage}%</td>
                                            <td style="white-space: pre-line;">${parseErrorCodes(processData.map(row => row[12]).join('+'))}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        `;
                        reportsContainer.appendChild(tableTitle);
                        reportsContainer.appendChild(table);
                    });
                };
                
                monthSelect.addEventListener('change', monthlyChangeHandler);
                tableTypeSelect.addEventListener('change', monthlyChangeHandler);
                monthSelect.dispatchEvent(new Event('change'));
            }
        });
        reportsGrid.appendChild(card);
      });
      reportsContainer.appendChild(title);
      reportsContainer.appendChild(reportsGrid);
      tablesContainer.appendChild(reportsContainer);
    });
    function handleFile(file) {
      if (!file) return;
      document.getElementById('buttonContainer').style.display = 'none';
      showProgress();
      tablesContainer.innerHTML = '';
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headers = json[0];
        const successRows = [];
        const errorRows = [];
        let successCount = 0;
        let errorCount = 0;
        const totalRows = json.length - 1;
        function processRows(startIndex) {
          const batchSize = 50;
          const endIndex = Math.min(startIndex + batchSize, json.length);

          for (let i = startIndex; i < endIndex; i++) {
            const row = json[i];
            if (i === 0) { // Header satırı için kontrol etme
                    continue;
                }
            if (row[3] === "alihanaykanat@buyutech.com.tr" || 
                (typeof row[0] === 'number' && row[0] < 189)) {
                continue; 
                }
            const newRow = [...row];
            let isError = false;
            try {
              if (typeof row[6] === 'number') {
                const dateObj = excelDateToJSDate(row[6]);
                const formatted = dateObj.toLocaleDateString('tr-TR');
                newRow[6] = formatted;
                if (!isValidDateFormat(formatted)) isError = true;
              }

              [9, 10].forEach(idx => {
                if (typeof row[idx] === 'number') {
                  const hourDecimal = row[idx] * 24;
                  const hh = String(Math.floor(hourDecimal)).padStart(2, '0');
                  const mm = String(Math.round((hourDecimal % 1) * 60)).padStart(2, '0');
                  newRow[idx] = `${hh}:${mm}`;
                } else if (typeof row[idx] === 'string') {
                  newRow[idx] = row[idx];
                }
                if (!isTimeStringValid(newRow[idx])) isError = true;
              });

              if (!isPatternValid(newRow[12], Hatalar_list)) isError = true;
              if (!isPatternValid(newRow[14], Duruslar_list)) isError = true;

            } catch (err) {
              console.error(`Satır ${i + 1} hatalı:`, err);
              isError = true;
            }

            if (isError) {
              errorRows.push(newRow);
              errorCount++;
            } else {
              successRows.push(newRow);
              successCount++;
            }
          }
          updateProgress(endIndex - 1, totalRows);
          if (endIndex < json.length) {
            setTimeout(() => processRows(endIndex), 10);
          } else {
            // İşlem tamamlandı
            finishProcessing();
        }
    }
    function finishProcessing() {
          hideProgress();
          document.getElementById('buttonContainer').style.display = 'flex';

          window.processedHeaders = headers;
          window.processedSuccessRows = successRows;
          window.processedErrorRows = errorRows;
          fileInput.value = '';
        }
        if (totalRows > 0) {
          processRows(1);
        } else {
          hideProgress();
          fileInput.value = '';
        }
      };
    
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => {
      if (e.target.files[0]) {
        handleFile(e.target.files[0]);
      }
    });
    dropZone.addEventListener('click', (e) => {
      if (e.target === fileInput) return;
      fileInput.value = '';
      fileInput.click();
    });
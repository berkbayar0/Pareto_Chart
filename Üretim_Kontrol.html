<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Excel Veri Kontrolü</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #f9f9fb;
      --box: #ffffff;
      --border: #ddd;
      --primary: #4CAF50;
      --danger: #ffdddd;
      --text: #333;
      --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      --progress-bg: #e0e0e0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    #drop-zone {
      border: 2px dashed var(--primary);
      background: #eaf7ed;
      padding: 40px;
      text-align: center;
      color: var(--primary);
      border-radius: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    #drop-zone:hover {
      background: #d8f5e0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #drop-zone.drag-over {
      background: #c8f2d0;
      border-color: #2e7d32;
      transform: scale(1.02);
    }

    .drop-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .drop-icon {
      font-size: 48px;
      opacity: 0.7;
    }

    .drop-text {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }

    .drop-subtext {
      font-size: 14px;
      opacity: 0.8;
      margin: 0;
    }

    #file-input {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .progress-container {
      margin: 20px 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: var(--progress-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #66bb6a);
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        45deg,
        transparent 35%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 65%
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      font-weight: 500;
      color: #666;
    }

    .button-container  {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      min-width: 120px;
    }
    .main-table-btn {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        min-width: 120px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);  /* Normal durumdaki gölge */
    }
    .main-table-btn:hover {
        background-color: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);  /* Hover durumunda daha belirgin gölge */
    }
    .main-table-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 8px rgba(0,0,0,0.0.05);  /* Tıklama durumunda orta seviye gölge */
    }
    .button-container button.active {
    background-color: #367c39;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }

    .main-table-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }

    .table-section {
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background:#242424;
      color: white;
      border-radius: 10px 10px 0 0;
      box-shadow: var(--shadow);
      position: relative;
    }

    .table-header.error-header {
      background: #222222;
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .analysis-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-top: 20px;
    }   

    .reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
    }

    .report-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .report-card:hover {
        transform: translateY(-5px);
    }

    .report-card h4 {
        margin: 0 0 10px 0;
        color: var(--text);
        font-size: 18px;
    }

    .report-card p {
        color: #666;
        margin: 0 0 15px 0;
        font-size: 14px;
    }

    .report-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }

    .report-btn:hover {
        background: #45a049;
    }

    .date-filter-container {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
    }

    .date-input-container {
    display: flex;
    flex-direction: column;
    gap: 5px;
    }

    .date-input-container label {
    font-weight: 500;
    color: #333;
    font-size: 14px;
    }

    .date-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 14px;
    min-width: 150px;
    cursor: pointer;
    background: white;
    }

    .flatpickr-calendar {
    background: white;
    box-shadow: 0 3px 15px rgba(0,0,0,0.2);
    border-radius: 8px;
    }

    .flatpickr-day.selected {
        background: var(--primary);
        border-color: var(--primary);
    }

    .flatpickr-day.inRange {
        background: #e8f5e9;
        border-color: #c8e6c9;
    }

    .flatpickr-day.today {
        border-color: var(--primary);
    }

    .analysis-results {
        margin-top: 20px;
    }

    .table-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .export-button, .toggle-button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .export-button:hover, .toggle-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .export-button {
      background: rgba(76, 175, 80, 0.8);
    }

    .export-button:hover {
      background: rgba(76, 175, 80, 1);
    }

    .toggle-icon {
      font-size: 14px;
      transition: transform 0.3s ease;
    }

    .toggle-button.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .table-wrapper {
      max-width: 100%;
      max-height: 550px;
      overflow-x: auto;
      overflow-y: auto;
      border-radius: 0 0 8px 8px;
      box-shadow: var(--shadow);
      background: var(--box);
      padding: 0px;
      border-top: none;
      transition: all 0.3s ease;
    }

    .table-wrapper.collapsed {
      display: none;
    }

    .table-wrapper table {
      width: 100%;
      border-collapse: collapse;
    }

    .table-wrapper th,
    .table-wrapper td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .table-wrapper th {
      background: #f5f5f5;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    th:first-child, td:first-child {
      width: 32px;
      text-align: center;
      background-color: #f1f1f1;
    }
    .scrap-input {
        width: 60px;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    .scrap-input:focus {
        outline: none;
        border-color: #4CAF50;
    }

    thead {
      background-color: #f3f3f3;
    }

    thead th {
      position: sticky;
      top: 0;
      background-color: #f3f3f3;
      z-index: 1;
    }

    .error {
      background-color: var(--danger);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }

      #drop-zone {
        padding: 30px 20px;
      }

      .drop-icon {
        font-size: 36px;
      }

      .drop-text {
        font-size: 16px;
      }

      .table-header {
        padding: 12px 15px;
      }

      .table-title {
        font-size: 16px;
      }

      .table-controls {
        flex-direction: column;
        gap: 5px;
      }

      .export-button, .toggle-button {
        font-size: 14px;
        padding: 6px 10px;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 8px;
      }
    }

    .export-dropdown {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 14px;
        background: white;
        margin-left: 20px;
        cursor: pointer;
    }

    .export-dropdown:hover {
        border-color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Excel Dosyası Veri Kontrolü</h2>
    
    <div id="drop-zone">
      <input type="file" id="file-input" accept=".xlsx, .xls" />
      <div class="drop-content">
        <div class="drop-icon">📄</div>
        <p class="drop-text">Dosyayı buraya sürükleyin veya tıklayın</p>
        <p class="drop-subtext">Excel dosyaları (.xlsx, .xls) desteklenir</p>
      </div>
    </div>

    <div class="button-container" id="buttonContainer" style="display: none;">
        <button id="mainTableBtn" class="main-table-btn">Ana Tablo</button>
        <button id="analysisBtn" class="main-table-btn">Analiz</button>
        <button id="reportsBtn" class="main-table-btn">Raporlar</button>
    </div>
    
    <div class="progress-container" id="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">İşleniyor...</div>
    </div>
    
    <div id="tables"></div>
  </div>

  <script>
    const excludedIndexes = [1, 2, 5, 16];
    const Hatalar_list = Array.from({ length: 93 }, (_, i) => "H" + i);
    const Duruslar_list = Array.from({ length: 25 }, (_, i) => "D" + i);

    function parseErrorCodes(errorString) {
        if (!errorString || errorString === "0") return "";
        
        // Hata kodları referans listesi - key-value şeklinde tutuyoruz
        const errorReferences = {
        'H0': 'Diğer (Lütfen açıklama giriniz)',
        'H1': 'Oksitli Malzeme',
        'H2': 'Tam Oturmamış Malzeme',
        'H3': 'Soğuk Lehim',
        'H4': 'Ters Malzeme',
        'H5': 'Kayık Malzeme',
        'H6': 'Eksik Malzeme',
        'H7': 'Lehimsiz',
        'H8': 'Dik Malzeme',
        'H9': 'Hasarlı Malzeme',
        'H10': 'Kısa Devre',
        'H11': 'Bozuk Malzeme',
        'H12': 'Kırık/Çatlak Malzeme',
        'H13': 'Yanlış Malzeme',
        'H14': 'Çıkık Malzeme',
        'H15': 'Fazla Lehim',
        'H16': 'Fazla Malzeme',
        'H17': 'Top Lehim',
        'H18': 'Soket Pinleri Eğik',
        'H19': 'Yetersiz Lehim',
        'H20': 'Hatalı Bacak Kesımı',
        'H21': 'Yapıştırıcı Uygun Değil (Az)',
        'H22': 'Yapıştırıcı Uygun Değil (Fazla)',
        'H23': 'Odak Uygun Değil',
        'H24': 'Eksik Enjeksiyon',
        'H25': 'Alüminyum Soğutucu Bacak Eksik',
        'H26': 'Yanlış Montaj',
        'H27': 'Led Aydınlatma Yetersiz',
        'H28': 'Yüksek Akım',
        'H29': 'EOL NOK',
        'H30': 'Görüntü Gelmiyor',
        'H31': 'Lehim Doluluk Uygun Değil',
        'H32': 'Sızdırmazlık Uygun Değil',
        'H33': 'UV Kürleme Hatası',
        'H34': 'PCB de Çapak',
        'H35': 'Depanalling Kesim Hatası',
        'H36': 'Yanlış Vida',
        'H37': 'Vida Takılmamış',
        'H38': 'Montaj Sıralaması uygun değil',
        'H39': 'Conta Yok',
        'H40': 'Rubber Yok',
        'H41': 'Led Çalışmıyor',
        'H42': 'Led Lens Eksik',
        'H43': 'Alüminyum Soğutucu Vida Delikleri Kayık',
        'H44': 'Lens Montaj Programlama Yapılmamış',
        'H45': 'EOL Programı Yapılmamış (White Box)',
        'H46': 'Lazer Markalama Bilgileri Eksik',
        'H47': 'Lazer Markalama Okunmuyor',
        'H48': 'Lazer Markalama Hatalı',
        'H49': 'Program Atılamama (White Box/EOL)',
        'H50': 'Bozuk Kart (Bad\'li Kart)',
        'H51': 'Tork Değeri Uygun Değil',
        'H52': 'Vida Sıkılmamış',
        'H67': 'Panel Test Hatası',
        'H68': 'Proses Hatası',
        'H69': 'Mtf Nok',
        'H70': 'Fov Nok',
        'H71': 'Snr Nok',
        'H72': 'Homegenity Nok',
        'H73': 'ID Hatası',
        'H74': 'Lens Çevresi Boşluk (50° üzeri)',
        'H75': 'Konnektör Merkezi Yamuk',
        'H76': 'Shift Hatası',
        'H77': '406/Dispense İstasyonu Prob Up hatası',
        'H78': '105/Align İstasyonu Görüntü Gelmeme Hatası',
        'H79': '107/Align İstasyonu Merkez Kaçıklık Hatası',
        'H80': '108/Align İstasyonu Maksimum Tarama Hatası',
        'H81': '155/Align İstasyonu Kürleme Sonrası MTF Düşme Hatası',
        'H82': '222/Dispense İstasyonu Görüntü Eşleşmeme Hatası',
        'H83': '231/Dispense İstasyonu Connection Hatası',
        'H84': '233/Dispense İstasyonu Kötü Yapıştırıcı Hatası',
        'H85': '242/Dispense İstaysonu Tozlu Ürün Hatası',
        'H86': '131/Align İstasyonu Köşelerde Odaklama Hatası',
        'H87': 'Robot Aşırı Yük Hatası',
        'H88': 'Fazla Magazin Hatası',
        'H89': 'Bağlantı Hatası (Üst üste min.2 kere bağlantı hatası)',
        'H90': 'TCP Nok / Mıu Board',
        'H91': 'Work ID Ön Bellek Depolama Hatası',
        'H92': 'Zaman Aşımı Hatası(Allign İstaysonu Görüntü Açılmadığı için)'
    };
        
        const errorTotals = {};
        const allMatches = errorString.match(/(\d+)\*(\w+)/g) || [];
        
        allMatches.forEach(match => {
            const [count, code] = match.split('*');
            const normalizedCode = code.toUpperCase();
            errorTotals[normalizedCode] = (errorTotals[normalizedCode] || 0) + parseInt(count);
        });
        
        return Object.entries(errorTotals)
            .sort((a, b) => b[1] - a[1]) // Sayıya göre büyükten küçüğe sırala
            .map(([code, total]) => {
                // Referans listesinde varsa açıklamasını, yoksa kodu kullan
                const description = errorReferences[code] || code;
                return `${description}: ${total}`;
            })
            .join('<br>');
    }

    function excelDateToJSDate(serial) {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      return new Date(excelEpoch.getTime() + serial * 24 * 60 * 60 * 1000);
    }

    function isValidDateFormat(str) {
      return /^\d{2}\.\d{2}\.\d{4}$/.test(str);
    }

    function isTimeStringValid(timeString) {
      if (typeof timeString === "number") return timeString >= 0 && timeString <= 1;
      if (typeof timeString === "string") {
        const timeRegex = /^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/;
        return timeRegex.test(timeString);
      }
      return false;
    }

    function isPatternMatch(input) {
      if (typeof input !== "string") return false;
      const cleaned = input.replace(/\s/g, '');
      return /^(\d+\*\w+(\+\d+\*\w+)*)$/.test(cleaned);
    }

    function extractTextValues(input) {
      if (!input || typeof input !== "string") return [];
      const pattern = /\b\d+\s*\*\s*(\w+)\s*\b/g;
      const matches = [];
      let match;
      while ((match = pattern.exec(input)) !== null) {
        if (match[1]) matches.push(match[1].toUpperCase());
      }
      return matches;
    }

    function checkListContains(list1, list2) {
      return list1.every(item => list2.includes(item));
    }

    function isPatternValid(text, validList) {
      if (!text || text === "0") return true;
      if (!isPatternMatch(text)) return false;
      const codes = extractTextValues(text);
      return checkListContains(codes, validList);
    }

    // Tarihe göre hafta numarası hesaplama fonksiyonu (ISO 8601 formatında)
    function getWeekFromDate(dateString) {
      if (!dateString || typeof dateString !== 'string') return '';
      
      try {
        // dd.mm.yyyy formatını parse et
        const [day, month, year] = dateString.split('.').map(num => parseInt(num));
        
        if (isNaN(day) || isNaN(month) || isNaN(year)) return '';
        
        // Tarihi Date objesine çevir
        const date = new Date(year, month - 1, day);
        
        // ISO hafta hesaplama
        const target = new Date(date.valueOf());
        const dayNumber = (date.getDay() + 6) % 7; // Pazartesi = 0
        
        target.setDate(target.getDate() - dayNumber + 3);
        const firstThursday = target.valueOf();
        target.setMonth(0, 1);
        
        if (target.getDay() !== 4) {
            target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
        }
        
        const weekNumber = 1 + Math.ceil((firstThursday - target) / 604800000);
        
        // YYYY-Wxx formatında döndür
        return `${year}-W${String(weekNumber).padStart(2, '0')}`;
        
      } catch (error) {
          console.error('Hafta hesaplama hatası:', error);
          return '';
      }
    }
    
    function getLastWeekOfYear(year) {
      const dec31 = new Date(year, 11, 31);
      const jan4NextYear = new Date(year + 1, 0, 4);
      const jan4NextYearDay = jan4NextYear.getDay();
      
      // Eğer 31 Aralık, bir sonraki yılın ilk haftasındaysa
      if (jan4NextYearDay <= 4) { // Perşembe veya öncesi
        const firstMondayNextYear = new Date(jan4NextYear);
        firstMondayNextYear.setDate(jan4NextYear.getDate() - (jan4NextYearDay === 0 ? 6 : jan4NextYearDay - 1));
        
        if (dec31 >= firstMondayNextYear) {
          return 1; // Aslında bir sonraki yılın ilk haftası
        }
      }
      
      // Normal hesaplama
      const jan4 = new Date(year, 0, 4);
      const jan4Day = jan4.getDay();
      const firstMonday = new Date(jan4);
      firstMonday.setDate(jan4.getDate() - (jan4Day === 0 ? 6 : jan4Day - 1));
      
      const diffTime = dec31.getTime() - firstMonday.getTime();
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 1000));
      return Math.floor(diffDays / 7) + 1;
    }
    function getMonthYear(dateString) {
        if (!dateString || typeof dateString !== 'string') return '';
        
        try {
            const [day, month, year] = dateString.split('.').map(num => parseInt(num));
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                          'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            return `${months[month-1]}-${year}`;
        } catch (error) {
            return '';
        }
    }
    
    function updateProgress(current, total) {
      const percentage = Math.round((current / total) * 100);
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      
      progressFill.style.width = percentage + '%';
      progressText.textContent = `${current}/${total} satır işlendi... (${percentage}%)`;
    }

    function showProgress() {
      document.getElementById('progress-container').style.display = 'block';
    }

    function hideProgress() {
      document.getElementById('progress-container').style.display = 'none';
    }

    function exportToExcel(headers, rows, fileName) {
      // İstenen sütun başlıkları ve sıralaması
      const desiredHeaders = [
        "ID",
        "Email", 
        "Tarih",
        "Hafta",
        "Proses Adı",        // "Process adı" yerine
        "OK Ürün",           // "ok ürün adeti" yerine
        "Fireler",           // "hata adet ve kodlar" yerine
        "Fire Açıklaması"
      ];
      const headerKeyMap = {
        "proses adı": "process adı",
        "ok ürün": "ok ürün adeti",
        "fireler": "hata adet ve kodlar",
        "fire açıklaması": "h0 için açıklama"
      };

      // Orijinal başlıkların indekslerini bul - daha esnek eşleştirme
      const actualIndices = {};
      headers.forEach((header, index) => {
        if (header && typeof header === 'string') {
          const cleanHeader = header.trim().toLowerCase();
          actualIndices[cleanHeader] = index;
          
          // Process adı için alternatif eşleştirmeler
          if (cleanHeader.includes('process') || cleanHeader.includes('proses')) {
            actualIndices['process adı'] = index;
          }
          if (cleanHeader.includes('ürün') && cleanHeader.includes('adet')) {
            actualIndices['ok ürün adeti'] = index;
          }
          if (cleanHeader.includes('hata') && (cleanHeader.includes('adet') || cleanHeader.includes('kod'))) {
            actualIndices['hata adet ve kodlar'] = index;
          }
          if (cleanHeader.includes('h0') || (cleanHeader.includes('açıklama') && cleanHeader.includes('h0'))) {
            actualIndices['h0 için açıklama'] = index;
          }
        }
      });

      console.log('Başlık eşleştirmeleri:', actualIndices); // Debug için

      // Her istenen başlık için orijinal indeksi bul
      const headerMap = desiredHeaders.map(desiredHeader => {
        if (desiredHeader === "Hafta") {
          return "HAFTA"; // Özel işaretçi
        }
        
        const matchKey = headerKeyMap[desiredHeader.toLowerCase()] || desiredHeader.toLowerCase();
        const foundIndex = actualIndices[matchKey];
  
        if (foundIndex !== undefined) {
            return foundIndex;
        }

        for (const [key, value] of Object.entries(actualIndices)) {
            if (key.includes(matchKey.split(' ')[0]) || matchKey.includes(key.split(' ')[0])) {
                return value;
            }
        }

        return -1;
      });

      // Filtrelenmiş satırları oluştur
      const filteredRows = rows.map(row => {
        return headerMap.map((idx, headerIndex) => {
          if (idx === "HAFTA") {
            // Tarih sütunundan hafta bilgisini hesapla
            const dateIndex = actualIndices["tarih"];
            const dateValue = dateIndex !== undefined ? row[dateIndex] : "";
            return getWeekFromDate(dateValue);
          }
          
          if (idx === -1) return "(eksik)"; // Başlık bulunamadı
          return row[idx] ?? "";
        });
      });

      // Excel workbook oluştur
      const wb = XLSX.utils.book_new();
      const wsData = [desiredHeaders, ...filteredRows];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Kolon genişliklerini ayarla
      ws['!cols'] = desiredHeaders.map(() => ({ wch: 20 }));
      
      // Worksheet'i workbook'a ekle
      XLSX.utils.book_append_sheet(wb, ws, 'Veriler');
      
      // Dosyayı indir
      XLSX.writeFile(wb, fileName);
    }

    function displayAnalysisResults(errorCodes, container) {
        const existingResults = container.querySelector('.analysis-results');
        if (existingResults) {
            existingResults.remove();
        }
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'analysis-results';    

        // Grafik container
        const chartContainer = document.createElement('div');
        chartContainer.style.marginBottom = '30px';
        chartContainer.style.height = '400px';

        // Tablo container oluştur
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-section';

        // Tablo header
        const tableHeader = document.createElement('div');
        tableHeader.className = 'table-header';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'table-title';
        titleDiv.innerHTML = '📊 Hata Kodları ve Adetleri';
        
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'table-controls';
        
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-button';
        toggleBtn.innerHTML = '<span class="toggle-icon">▼</span> Göster/Gizle';
        
        controlsDiv.appendChild(toggleBtn);
        tableHeader.appendChild(titleDiv);
        tableHeader.appendChild(controlsDiv);

        // Tablo wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        wrapper.style.maxHeight = '500px'; // Tablo yüksekliğini sınırla

        const canvas = document.createElement('canvas');
        canvas.id = 'paretoChart';
        chartContainer.appendChild(canvas);
        resultsDiv.appendChild(chartContainer);

        // Hata sayılarını hesapla ve Pareto grafiği için kullan
        const errorCount = {};
        errorCodes.forEach(codeString => {
            if (!codeString || codeString === "0") return;

            const matches = codeString.match(/(\d+)\*(\w+)/g) || [];
            matches.forEach(match => {
                const [count, code] = match.split('*');
                const normalizedCode = code.toUpperCase();
                errorCount[normalizedCode] = (errorCount[normalizedCode] || 0) + parseInt(count);
            });
        });

        // Pareto grafiği için verileri hazırla
        const sortedErrors = Object.entries(errorCount)
            .sort(([, a], [, b]) => b - a);

        const codes = sortedErrors.map(item => item[0]);
        const counts = sortedErrors.map(item => item[1]);

        const total = counts.reduce((a, b) => a + b, 0);
        let cumulative = 0;
        const cumulativePercent = counts.map(val => {
            cumulative += val;
            return ((cumulative / total) * 100).toFixed(2);
        });

        // Eski grafik varsa temizle
        if (window.paretoChart) {
            window.paretoChart.destroy();
        }

        // Yeni grafik oluştur
        const ctx = canvas.getContext('2d');
        window.paretoChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: codes,
                datasets: [
                    {
                        label: 'Hata Adedi',
                        data: counts,
                        backgroundColor: '#4CAF50',
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Kümülatif %',
                        data: cumulativePercent,
                        type: 'line',
                        borderColor: '#ff9800',
                        borderWidth: 2,
                        yAxisID: 'y2',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y1: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Hata Adedi'
                        }
                    },
                    y2: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Kümülatif %'
                        },
                        ticks: {
                            callback: value => value + '%'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });

        // Tablo oluşturma
        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Hata Kodu</th>
                    <th>Toplam Sayı</th>
                </tr>
            </thead>
            <tbody>
                ${sortedErrors.map(([code, count]) => `
                    <tr>
                        <td>${code}</td>
                        <td>${count}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;

        // Toggle fonksiyonu
        toggleBtn.onclick = () => {
            const isCollapsed = wrapper.classList.contains('collapsed');
            if (isCollapsed) {
                wrapper.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
            } else {
                wrapper.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
            }
        };

        wrapper.appendChild(table);
        tableContainer.appendChild(tableHeader);
        tableContainer.appendChild(wrapper);
        resultsDiv.appendChild(tableContainer);

        // Referans tablosu container
        const referenceContainer = document.createElement('div');
        referenceContainer.className = 'table-section';

        // Referans tablosu header
        const referenceHeader = document.createElement('div');
        referenceHeader.className = 'table-header';

        const referenceTitleDiv = document.createElement('div');
        referenceTitleDiv.className = 'table-title';
        referenceTitleDiv.innerHTML = '📋 Hata Kodları Referans Listesi';

        const referenceControlsDiv = document.createElement('div');
        referenceControlsDiv.className = 'table-controls';

        const referenceToggleBtn = document.createElement('button');
        referenceToggleBtn.className = 'toggle-button';
        referenceToggleBtn.innerHTML = '<span class="toggle-icon">▼</span> Göster/Gizle';

        referenceControlsDiv.appendChild(referenceToggleBtn);
        referenceHeader.appendChild(referenceTitleDiv);
        referenceHeader.appendChild(referenceControlsDiv);

        // Referans tablosu wrapper
        const referenceWrapper = document.createElement('div');
        referenceWrapper.className = 'table-wrapper';

        // Referans tablosu
        const referenceTable = document.createElement('table');
        referenceTable.innerHTML = `
            <thead>
                <tr>
                    <th>Hata Kodu Numarası</th>
                    <th>Açıklaması</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>H0</td><td>Diğer (Lütfen açıklama giriniz)</td></tr>
                <tr><td>H9</td><td>Hasarlı Malzeme</td></tr>
                <tr><td>H30</td><td>Görüntü Gelmiyor</td></tr>
                <tr><td>H32</td><td>Sızdırmazlık Uygun Değil</td></tr>
                <tr><td>H45</td><td>EOL Programı Yapılmamış (White Box)</td></tr>
                <tr><td>H49</td><td>Program Atılamama (White Box/EOL)</td></tr>
                <tr><td>H54</td><td>Görüntü Bulanık</td></tr>
                <tr><td>H55</td><td>Leke var</td></tr>
                <tr><td>H60</td><td>XY Hatası</td></tr>
                <tr><td>H61</td><td>Z Hatası</td></tr>
                <tr><td>H62</td><td>2S/S Hatası</td></tr>
                <tr><td>H63</td><td>F Sweep Hatası</td></tr>
                <tr><td>H64</td><td>Error Valitadion Failed Hatası</td></tr>
                <tr><td>H66</td><td>Yapıştırıcı Uygun Değil (Camsı Ürün)</td></tr>
                <tr><td>H67</td><td>Panel Test Hatası</td></tr>
                <tr><td>H68</td><td>Proses Hatası</td></tr>
                <tr><td>H69</td><td>Mtf Nok</td></tr>
                <tr><td>H73</td><td>ID Hatası</td></tr>
                <tr><td>H74</td><td>Lens Çevresi Boşluk (50° üzeri)</td></tr>
                <tr><td>H76</td><td>Shift Hatası</td></tr>
            </tbody>
        `;

        // Toggle fonksiyonu
        referenceToggleBtn.onclick = () => {
            const isCollapsed = referenceWrapper.classList.contains('collapsed');
            if (isCollapsed) {
                referenceWrapper.classList.remove('collapsed');
                referenceToggleBtn.classList.remove('collapsed');
            } else {
                referenceWrapper.classList.add('collapsed');
                referenceToggleBtn.classList.add('collapsed');
            }
        };

        referenceWrapper.appendChild(referenceTable);
        referenceContainer.appendChild(referenceHeader);
        referenceContainer.appendChild(referenceWrapper);
        resultsDiv.appendChild(referenceContainer);

        container.appendChild(resultsDiv);    
    }    

    function createTable(headers, rows, tableId, isErrorTable = false) {
      const section = document.createElement('div');
      section.className = 'table-section';

      // Header kısmı
      const tableHeader = document.createElement('div');
      tableHeader.className = `table-header ${isErrorTable ? 'error-header' : ''}`;
      
      const titleDiv = document.createElement('div');
      titleDiv.className = 'table-title';
      
      const icon = isErrorTable ? '❌' : '✅';
      const title = isErrorTable ? 'Hatalı Kayıtlar' : 'Başarılı Kayıtlar';
      
      titleDiv.innerHTML = `
        ${icon} ${title}
        <span class="table-count">${rows.length} kayıt</span>
      `;
      
      // Kontrol butonları container
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'table-controls';
      
      // Export butonu
      const exportBtn = document.createElement('button');
      exportBtn.className = 'export-button';
      exportBtn.innerHTML = '📊 Excel\'e Aktar';
      exportBtn.onclick = () => {
        const fileName = isErrorTable ? 'Hatali_Kayitlar.xlsx' : 'Basarili_Kayitlar.xlsx';
        exportToExcel(headers, rows, fileName);
      };
      
      // Toggle butonu
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'toggle-button';
      toggleBtn.innerHTML = '<span class="toggle-icon">▼</span> Göster/Gizle';
      
      controlsDiv.appendChild(exportBtn);
      controlsDiv.appendChild(toggleBtn);
      
      tableHeader.appendChild(titleDiv);
      tableHeader.appendChild(controlsDiv);

      // Tablo wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      
      // Tablo oluştur
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      tbody.id = tableId + "-body";

      const headerRow = document.createElement('tr');
      headers.forEach((h, idx) => {
        if (!excludedIndexes.includes(idx)) {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        }
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      rows.forEach(row => {
        const tr = document.createElement('tr');
        if (isErrorTable) tr.classList.add("error");
        row.forEach((cell, idx) => {
          if (!excludedIndexes.includes(idx)) {
            const td = document.createElement('td');
            td.textContent = cell !== undefined ? cell : '';
            tr.appendChild(td);
          }
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);

      // Toggle fonksiyonu
      toggleBtn.onclick = () => {
        const isCollapsed = wrapper.classList.contains('collapsed');
        if (isCollapsed) {
          wrapper.classList.remove('collapsed');
          toggleBtn.classList.remove('collapsed');
        } else {
          wrapper.classList.add('collapsed');
          toggleBtn.classList.add('collapsed');
        }
      };

      section.appendChild(tableHeader);
      section.appendChild(wrapper);
      return section;
    }

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const tablesContainer = document.getElementById('tables');

    document.getElementById('mainTableBtn').addEventListener('click', function() {

        tablesContainer.innerHTML = '';

        if (window.processedSuccessRows && window.processedSuccessRows.length > 0) {
        const mainTable = createTable(
            window.processedHeaders, 
            window.processedSuccessRows, 
            "main-table"
        );
        tablesContainer.appendChild(mainTable);
    }
        
        if (window.processedErrorRows && window.processedErrorRows.length > 0) {
        const errTable = createTable(
            window.processedHeaders, 
            window.processedErrorRows, 
            "error-table", 
            true
        );
        tablesContainer.appendChild(errTable);
    }
});

    document.getElementById('analysisBtn').addEventListener('click', function() {
        tablesContainer.innerHTML = '';
    
            // Analiz container oluştur
        const analysisContainer = document.createElement('div');
        analysisContainer.className = 'analysis-container';
        
        // Başlık ekle
        const title = document.createElement('h3');
        title.textContent = 'Hata Kodları Analizi';
        title.style.marginBottom = '20px';
        
        // Filtre container
        const filterContainer = document.createElement('div');
        filterContainer.className = 'date-filter-container';
  
         // Label ve input container'ları
        const startDateContainer = document.createElement('div');
        startDateContainer.className = 'date-input-container';
        const endDateContainer = document.createElement('div');
        endDateContainer.className = 'date-input-container';

        // Başlangıç tarihi label ve input
        const startLabel = document.createElement('label');
        startLabel.textContent = 'Başlangıç Tarihi:';
        const startDateInput = document.createElement('input');
        startDateInput.type = 'text';
        startDateInput.className = 'date-select';
        startDateInput.placeholder = 'Başlangıç Tarihi Seçin';

        // Bitiş tarihi label ve input
        const endLabel = document.createElement('label');
        endLabel.textContent = 'Bitiş Tarihi:';
        const endDateInput = document.createElement('input');
        endDateInput.type = 'text';
        endDateInput.className = 'date-select';
        endDateInput.placeholder = 'Bitiş Tarihi Seçin';

        // En erken ve en geç tarihleri bul
        const dates = window.processedSuccessRows.map(row => {
            const dateParts = row[6].split('.');
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
        });

        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));

        // Flatpickr ayarları
        const flatpickrConfig = {
            dateFormat: "d.m.Y",
            locale: "tr",
            minDate: minDate,
            maxDate: maxDate
        };

        // Başlangıç tarihi için Flatpickr
        const startFp = flatpickr(startDateInput, {
            ...flatpickrConfig,
            defaultDate: minDate,
            onChange: function(selectedDates, dateStr) {
            // Bitiş tarihinin minimum değerini başlangıç tarihine ayarla
            endFp.set('minDate', selectedDates[0]);
              
            // Eğer bitiş tarihi, yeni başlangıç tarihinden önceyse
            if (endFp.selectedDates[0] && selectedDates[0] > endFp.selectedDates[0]) {
                // Bitiş tarihini başlangıç tarihine eşitle
                endFp.setDate(selectedDates[0]);
            }
              
            updateResults();
          }
        });

        // Bitiş tarihi için Flatpickr
        const endFp = flatpickr(endDateInput, {
            ...flatpickrConfig,
            defaultDate: maxDate,
            minDate: minDate,
            onChange: updateResults
        });

        function updateResults() {
            const startDate = startFp.selectedDates[0];
            const endDate = endFp.selectedDates[0];

            if (startDate && endDate) {
                // Seçilen tarih aralığındaki verileri filtrele
                const filteredData = window.processedSuccessRows.filter(row => {
                    const dateParts = row[6].split('.');
                    const rowDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    return rowDate >= startDate && rowDate <= endDate;
                });

                const errorCodes = filteredData.map(row => row[12]);
                
                // Sonuçları göster
                displayAnalysisResults(errorCodes, analysisContainer);
            }
        }

        // Input'ları container'lara ekle
        startDateContainer.appendChild(startLabel);
        startDateContainer.appendChild(startDateInput);
        endDateContainer.appendChild(endLabel);
        endDateContainer.appendChild(endDateInput);

        // Container'ları ana filter container'a ekle
        filterContainer.appendChild(startDateContainer);
        filterContainer.appendChild(endDateContainer);

        // Her şeyi ana container'a ekle
        analysisContainer.appendChild(title);
        analysisContainer.appendChild(filterContainer);
        
        tablesContainer.appendChild(analysisContainer);

        // İlk sonuçları göster
        updateResults();
    });

    document.getElementById('reportsBtn').addEventListener('click', function() {
      tablesContainer.innerHTML = '';

      const reportsContainer = document.createElement('div');
      reportsContainer.className = 'analysis-container';
      
      const title = document.createElement('h3');
      title.textContent = 'Raporlar';
      title.style.marginBottom = '20px';

      const reportsGrid = document.createElement('div');
      reportsGrid.className = 'reports-grid';

      const reportCards = [
        { title: 'Haftalık', description: 'Haftalara göre detaylı rapor analizi', type:'weekly' },
        { title: 'Aylık', description: 'Aylara göre detaylı rapor analizi', type:'monthly' }
      ];

      reportCards.forEach(report => {
        const card = document.createElement('div');
        card.className = 'report-card';
        card.innerHTML = `
            <h4>${report.title}</h4>
            <p>${report.description}</p>
            <button class="report-btn" data-type="${report.type}">Raporu Görüntüle</button>
        `;
        const reportBtn = card.querySelector('.report-btn');
        // reportBtn event listener'ını güncelleyelim
        reportBtn.addEventListener('click', function() {
            if (this.dataset.type === 'weekly') {
                if (!window.processedSuccessRows || window.processedSuccessRows.length === 0) {
                    reportsContainer.innerHTML = '';
                    const messageTitle = document.createElement('h3');
                    messageTitle.style.textAlign = 'center';
                    messageTitle.style.marginTop = '50px';
                    messageTitle.textContent = 'Lütfen önce bir Excel dosyası yükleyin.';
                    reportsContainer.appendChild(messageTitle);
                    return;
                }
                
                reportsContainer.innerHTML = '';

                const title = document.createElement('h3');
                title.textContent = 'Haftalık Rapor';
                title.style.marginBottom = '20px';
                reportsContainer.appendChild(title);

                const weekSelect = document.createElement('select');
                weekSelect.className = 'date-select';

                // 3. Haftaları al ve seçici içeriğini oluştur
                const weeks = [...new Set(window.processedSuccessRows.map(row => 
                    getWeekFromDate(row[6])
                ))].sort();

                weekSelect.innerHTML = `
                    <option value="">Tüm Haftalar</option>
                    ${weeks.map(week => `<option value="${week}">${week}</option>`).join('')}
                `;
                const weekSelectContainer = document.createElement('div');
                weekSelectContainer.className = 'date-filter-container';
                weekSelectContainer.appendChild(weekSelect);

                const tableTypeSelect = document.createElement('select');
                tableTypeSelect.className = 'date-select';
                tableTypeSelect.style.marginLeft = '20px';  // Hafta seçiciden sonra boşluk bırakmak için
                tableTypeSelect.innerHTML = `
                    <option value="BOTH">SVC-DMS</option>
                    <option value="SVC">SVC</option>
                    <option value="DMS">DMS</option>
                `;

                weekSelectContainer.appendChild(tableTypeSelect);

                // Export seçenekleri ve buton container'ı oluştur
                const exportControls = document.createElement('div');
                exportControls.className = 'export-controls';
                exportControls.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-left: auto;
                    gap: 15px;
                `;

                // Checkbox'lar için container
                const checkboxContainer = document.createElement('div');
                checkboxContainer.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;

                // Excel checkbox
                const excelLabel = document.createElement('label');
                excelLabel.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                `;
                const excelCheckbox = document.createElement('input');
                excelCheckbox.type = 'radio';
                excelCheckbox.name = 'exportType';
                excelCheckbox.value = 'excel';
                excelCheckbox.style.cursor = 'pointer';
                excelLabel.appendChild(excelCheckbox);
                excelLabel.appendChild(document.createTextNode('Excel'));

                // PDF checkbox
                const pdfLabel = document.createElement('label');
                pdfLabel.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                `;
                const pdfCheckbox = document.createElement('input');
                pdfCheckbox.type = 'radio';
                pdfCheckbox.name = 'exportType';
                pdfCheckbox.value = 'pdf';
                pdfCheckbox.style.cursor = 'pointer';
                pdfLabel.appendChild(pdfCheckbox);
                pdfLabel.appendChild(document.createTextNode('PDF'));

                // Dışa Aktar butonu
                const exportButton = document.createElement('button');
                exportButton.textContent = 'Dışa Aktar';
                exportButton.className = 'export-button';
                exportButton.style.cssText = `
                    padding: 8px 16px;
                    background-color: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                `;

                exportButton.addEventListener('click', function() {
                    const selectedFormat = document.querySelector('input[name="exportType"]:checked')?.value;
                    if (!selectedFormat) {
                        alert('Lütfen bir format seçin');
                        return;
                    }

                    // Mevcut export işlemlerini buraya taşı
                    const selectedMonth = monthSelect.value;
                    const selectedWeek = weekSelect.value;
                    const selectedType = tableTypeSelect.value;
                    const tables = document.querySelectorAll('.weekly-report-table');

                    if (selectedFormat === 'excel') {
                        // Excel export
                        const wb = XLSX.utils.book_new();
                        tables.forEach((table, index) => {
                            if (table.style.display !== 'none') {
                                const tableType = ['SVC', 'DMS'][index];
                                const ws_data = [];
                                // Headers
                                const headers = [];
                                table.querySelectorAll('thead th').forEach(th => {
                                    headers.push(th.textContent);
                                });
                                ws_data.push(headers);
                                
                                // Data
                                table.querySelectorAll('tbody tr').forEach(tr => {
                                    const row = [];
                                    tr.querySelectorAll('td').forEach((td, i) => {
                                        if (i === 2) { // Scrap input değeri
                                            row.push(td.querySelector('input').value);
                                        } else {
                                            row.push(td.textContent);
                                        }
                                    });
                                    ws_data.push(row);
                                });
                                
                                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                                XLSX.utils.book_append_sheet(wb, ws, tableType);
                            }
                        });
                        
                        const today = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
                        XLSX.writeFile(wb, `Haftalik_Rapor_${selectedWeek || 'Tum'}_${today}.xlsx`);
                        XLSX.writeFile(wb, `Aylik_Rapor_${selectedMonth || 'Tum'}_${today}.xlsx`);
                    } else if (selectedFormat === 'pdf') {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                        script.onload = function() {
                            const element = document.createElement('div');
                            element.style.padding = '20px';
                            
                            // Başlık ekle
                            const title = document.createElement('h2');
                            title.textContent = `Haftalık Rapor ${selectedWeek || 'Tüm Haftalar'}`;
                            element.appendChild(title);
                            
                            // Tabloları kopyala
                            tables.forEach(table => {
                                if (table.style.display !== 'none') {
                                    element.appendChild(table.cloneNode(true));
                                }
                            });
                            
                            const opt = {
                                margin: 1,
                                filename: `Haftalik_Rapor_${selectedWeek || 'Tum'}_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.pdf`,
                                image: { type: 'jpeg', quality: 0.98 },
                                html2canvas: { scale: 2 },
                                jsPDF: { unit: 'cm', format: 'a4', orientation: 'landscape' }
                            };
                            
                            html2pdf().from(element).set(opt).save();
                        };
                        document.head.appendChild(script);
                    }
                });

                // Elementleri container'lara ekle
                checkboxContainer.appendChild(excelLabel);
                checkboxContainer.appendChild(pdfLabel);
                exportControls.appendChild(checkboxContainer);
                exportControls.appendChild(exportButton);

                // Export kontrollerini weekSelectContainer'a ekle
                weekSelectContainer.appendChild(exportControls);

                reportsContainer.appendChild(weekSelectContainer);
                
                // Benzersiz proses adlarını al (6. sütun)
                const processes = [
                    'SMD BOT',
                    'SMD TOP',
                    'TH Lehimleme',
                    'Panel Test',
                    'Depaneling',
                    'Vidalama',
                    'Lens AA',
                    'Sızdırmazlık',
                    'EOL Flaş',
                    'EOL',
                    'Lazer Markalama'
                ];
                weekSelect.addEventListener('change', function() {
                    const selectedWeek = this.value;
                    const selectedType = tableTypeSelect.value; // Default olarak "SVC" gelecek

                    
                    const existingTables = reportsContainer.querySelectorAll('.weekly-report-table');
                    const existingTitles = reportsContainer.querySelectorAll('h4');
                    existingTables.forEach(table => table.remove());
                    existingTitles.forEach(title => title.remove());

                    const tablesToShow = selectedType === 'BOTH' ? ['SVC', 'DMS'] : [selectedType];

                // Tablo oluştur
                ['SVC', 'DMS'].forEach(tableType => {
                    const tableTitle = document.createElement('h4');
                    tableTitle.textContent = `${tableType}`;
                    tableTitle.style.marginTop = '30px';
                    tableTitle.style.marginBottom = '15px';

                    let filteredData = window.processedSuccessRows.filter(row => 
                        row[7] && row[7].toUpperCase() === tableType
                    );
                    if (selectedWeek) {
                        filteredData = filteredData.filter(row => 
                            getWeekFromDate(row[6]) === selectedWeek
                        );
                    }
                
                const table = document.createElement('table');
                table.className = 'weekly-report-table';
                
                // Tablo başlıkları
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Prosesler</th>
                            <th>OK Adet</th>
                            <th>Scrap Adet</th>
                            <th>Total NOK Adet</th>
                            <th>Yüzde NOK</th>
                            <th>Açıklama</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processes.map(process => {
                          // Her proses için verileri filtrele
                          const processData = filteredData.filter(row => 
                              row[8] && row[8].toUpperCase() === process.toUpperCase()
                          );

                          // 11. sütundaki OK Adet değerlerini topla
                          const okTotal = processData.reduce((total, row) => {
                              const okCount = parseInt(row[11]) || 0;
                              return total + okCount;
                          }, 0);

                          const nokTotal = processData.reduce((total, row) => {
                              if (!row[12] || row[12] === "0") return total;
                              const matches = row[12].match(/(\d+)\*\w+/g) || [];
                              const nokCount = matches.reduce((sum, match) => {
                                  const count = parseInt(match.split('*')[0]);
                                  return sum + (count || 0);
                              }, 0);
                              
                              return total + nokCount;
                          }, 0);
                          
                          const nokPercentage = okTotal > 0 ? ((nokTotal / (okTotal + nokTotal)) * 100).toFixed(2) : '0.00';

                          return `
                            <tr>
                                <td>${process}</td>
                                <td>${okTotal || '0'}</td>
                                <td><input type="number" min="0" 
                                    class="scrap-input" 
                                    value="0" 
                                    style="width: 60px; padding: 8px;"
                                    onblur="this.value = this.value || '0'"></td>
                                <td>${nokTotal || '0'}</td>
                                <td>${nokPercentage}%</td>
                                <td style="white-space: pre-line;">${parseErrorCodes(processData.map(row => row[12]).join('+'))}</td>
                            </tr>
                          `;  
                      }).join('')}
                    </tbody>
                `;
                reportsContainer.appendChild(tableTitle);
                reportsContainer.appendChild(table);
              });
            }); 

                // CSS stil ekle
                const style = document.createElement('style');
                style.textContent = `
                    .weekly-report-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                        background: white;
                        margin-bottom: 40px;
                    }
                    .weekly-report-table th,
                    .weekly-report-table td {
                        padding: 12px;
                        border: 1px solid var(--border);
                        text-align: left;
                    }
                    .weekly-report-table th:first-child,
                    .weekly-report-table td:first-child {
                        width: 120px;  /* Başlık 1 sütunu için genişlik */
                        min-width: 120px; 
                        max-width: 120px; 
                    }
                    .weekly-report-table th:nth-child(2),
                    .weekly-report-table td:nth-child(2),
                    .weekly-report-table th:nth-child(3),
                    .weekly-report-table td:nth-child(3),
                    .weekly-report-table th:nth-child(4),
                    .weekly-report-table td:nth-child(4),
                    .weekly-report-table th:nth-child(5),
                    .weekly-report-table td:nth-child(5) {
                        width: 80px;
                        min-width: 80px;
                        max-width: 80px; 
                    }              
                    .weekly-report-table th {
                        background: #f5f5f5;
                        font-weight: 600;
                    }
                    .weekly-report-table tr:hover {
                        background: #f9f9f9;
                    }
                `;
                document.head.appendChild(style);

                weekSelect.dispatchEvent(new Event('change'));
            } else if (this.dataset.type === 'monthly') {
              if (!window.processedSuccessRows || window.processedSuccessRows.length === 0) {
                  reportsContainer.innerHTML = '';
                  const messageTitle = document.createElement('h3');
                  messageTitle.style.textAlign = 'center';
                  messageTitle.style.marginTop = '50px';
                  messageTitle.textContent = 'Lütfen önce bir Excel dosyası yükleyin.';
                  reportsContainer.appendChild(messageTitle);
                  return;
              }
              
              reportsContainer.innerHTML = '';

              const title = document.createElement('h3');
              title.textContent = 'Aylık Rapor';
              title.style.marginBottom = '20px';
              reportsContainer.appendChild(title);

              // Ay-Yıl seçici
              const monthSelect = document.createElement('select');
              monthSelect.className = 'date-select';

              // Benzersiz ay-yılları al
              const monthYears = [...new Set(window.processedSuccessRows.map(row => 
                  getMonthYear(row[6])
              ))].sort().reverse();

              monthSelect.innerHTML = `
                  <option value="">Tüm Aylar</option>
                  ${monthYears.map(month => `<option value="${month}">${month}</option>`).join('')}
              `;

              const monthSelectContainer = document.createElement('div');
              monthSelectContainer.className = 'date-filter-container';
              monthSelectContainer.appendChild(monthSelect);

              // SVC-DMS seçici ve diğer kontroller için haftalık rapordan kopyala
              const tableTypeSelect = document.createElement('select');
              tableTypeSelect.className = 'date-select';
              tableTypeSelect.style.marginLeft = '20px';
              tableTypeSelect.innerHTML = `
                  <option value="BOTH">SVC-DMS</option>
                  <option value="SVC">SVC</option>
                  <option value="DMS">DMS</option>
              `;
              monthSelectContainer.appendChild(tableTypeSelect);

              // Export kontrolleri (haftalık rapordan aynı şekilde kopyala)
              const exportControls = document.createElement('div');
              exportControls.className = 'export-controls';
              exportControls.style.cssText = `
                  display: flex;
                  align-items: center;
                  margin-left: auto;
                  gap: 15px;
              `;

              // Radio butonlar için container
              const checkboxContainer = document.createElement('div');
              checkboxContainer.style.cssText = `
                  display: flex;
                  align-items: center;
                  gap: 15px;
              `;

              // Excel radio
              const excelLabel = document.createElement('label');
              excelLabel.style.cssText = `
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  cursor: pointer;
              `;
              const excelRadio = document.createElement('input');
              excelRadio.type = 'radio';
              excelRadio.name = 'monthlyExportType';
              excelRadio.value = 'excel';
              excelRadio.style.cursor = 'pointer';
              excelLabel.appendChild(excelRadio);
              excelLabel.appendChild(document.createTextNode('Excel'));

              // PDF radio
              const pdfLabel = document.createElement('label');
              pdfLabel.style.cssText = `
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  cursor: pointer;
              `;
              const pdfRadio = document.createElement('input');
              pdfRadio.type = 'radio';
              pdfRadio.name = 'monthlyExportType';
              pdfRadio.value = 'pdf';
              pdfRadio.style.cursor = 'pointer';
              pdfLabel.appendChild(pdfRadio);
              pdfLabel.appendChild(document.createTextNode('PDF'));

              checkboxContainer.appendChild(excelLabel);
              checkboxContainer.appendChild(pdfLabel);

              // Export butonu
              const exportButton = document.createElement('button');
              exportButton.textContent = 'Dışa Aktar';
              exportButton.className = 'export-button';
              exportButton.style.cssText = `
                  padding: 8px 16px;
                  background-color: #4CAF50;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 14px;
              `;

              exportControls.appendChild(checkboxContainer);
              exportControls.appendChild(exportButton);
              monthSelectContainer.appendChild(exportControls);
              reportsContainer.appendChild(monthSelectContainer);

              // monthSelect.addEventListener('change', function() kısmında şu değişiklikleri yapalım:
              monthSelect.addEventListener('change', function() {
                  const selectedMonth = this.value;
                  const selectedType = tableTypeSelect.value;

                  const existingTables = reportsContainer.querySelectorAll('.weekly-report-table');
                  const existingTitles = reportsContainer.querySelectorAll('h4');
                  existingTables.forEach(table => table.remove());
                  existingTitles.forEach(title => title.remove());

                  ['SVC', 'DMS'].forEach(tableType => {
                      if (selectedType === 'BOTH' || selectedType === tableType) {
                          const processes = [
                              'SMD BOT',
                              'SMD TOP',
                              'TH Lehimleme',
                              'Panel Test',
                              'Depaneling',
                              'Vidalama',
                              'Lens AA',
                              'Sızdırmazlık',
                              'EOL Flaş',
                              'EOL',
                              'Lazer Markalama'
                          ];
                          const tableTitle = document.createElement('h4');
                          tableTitle.textContent = `${tableType}`;
                          tableTitle.style.marginTop = '30px';
                          tableTitle.style.marginBottom = '15px';

                          let filteredData = window.processedSuccessRows.filter(row => 
                              row[7] && row[7].toUpperCase() === tableType
                          );

                          if (selectedMonth) {
                              filteredData = filteredData.filter(row => 
                                  getMonthYear(row[6]) === selectedMonth
                              );
                          }

                          // Tablo oluştur
                          const table = document.createElement('table');
                          table.className = 'weekly-report-table';
                          
                          // Tablo başlıkları
                          table.innerHTML = `
                              <thead>
                                  <tr>
                                      <th>Prosesler</th>
                                      <th>OK Adet</th>
                                      <th>Scrap Adet</th>
                                      <th>Total NOK Adet</th>
                                      <th>Yüzde NOK</th>
                                      <th>Açıklama</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${processes.map(process => {
                                      const processData = filteredData.filter(row => 
                                          row[8] && row[8].toUpperCase() === process.toUpperCase()
                                      );

                                      const okTotal = processData.reduce((total, row) => {
                                          const okCount = parseInt(row[11]) || 0;
                                          return total + okCount;
                                      }, 0);

                                      const nokTotal = processData.reduce((total, row) => {
                                          if (!row[12] || row[12] === "0") return total;
                                          const matches = row[12].match(/(\d+)\*\w+/g) || [];
                                          return total + matches.reduce((sum, match) => 
                                              sum + (parseInt(match.split('*')[0]) || 0), 0);
                                      }, 0);
                                      
                                      const nokPercentage = ((nokTotal / (okTotal + nokTotal)) * 100).toFixed(2);

                                      return `
                                          <tr>
                                              <td>${process}</td>
                                              <td>${okTotal || '0'}</td>
                                              <td><input type="number" min="0" 
                                                  class="scrap-input" 
                                                  value="0" 
                                                  style="width: 60px; padding: 8px;"
                                                  onblur="this.value = this.value || '0'"></td>
                                              <td>${nokTotal || '0'}</td>
                                              <td>${nokPercentage}%</td>
                                              <td style="white-space: pre-line;">${parseErrorCodes(processData.map(row => row[12]).join('+'))}</td>
                                          </tr>
                                      `;
                                  }).join('')}
                              </tbody>
                          `;
                          
                          reportsContainer.appendChild(tableTitle);
                          reportsContainer.appendChild(table);
                      }
                  });
              });

              // İlk yükleme
              monthSelect.dispatchEvent(new Event('change'));
          }
        });
        
        reportsGrid.appendChild(card);
      });
      reportsContainer.appendChild(title);
      reportsContainer.appendChild(reportsGrid);
      tablesContainer.appendChild(reportsContainer);
    });
    // Drag and drop olayları
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFile(e.dataTransfer.files[0]);
    });

    // File input değişiklik olayı
    fileInput.addEventListener('change', e => {
      if (e.target.files[0]) {
        handleFile(e.target.files[0]);
      }
    });

    // Drop zone tıklama olayı - dosya input'unu temizle
    dropZone.addEventListener('click', (e) => {
      // Eğer tıklama file input'un kendisinden geliyorsa, hiçbir şey yapma
      if (e.target === fileInput) return;
      
      // File input'u temizle ve tıkla
      fileInput.value = '';
      fileInput.click();
    });
    
    function handleFile(file) {
      if (!file) return;

      document.getElementById('buttonContainer').style.display = 'none';

      showProgress();
      tablesContainer.innerHTML = '';

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headers = json[0];
        const successRows = [];
        const errorRows = [];
        let successCount = 0;
        let errorCount = 0;
        const totalRows = json.length - 1;

        // İlerleme göstergesi için batch işleme
        function processRows(startIndex) {
          const batchSize = 50;
          const endIndex = Math.min(startIndex + batchSize, json.length);

          for (let i = startIndex; i < endIndex; i++) {
            const row = json[i];
            if (i === 0) { // Header satırı için kontrol etme
                    continue;
                }
                
                // Email kontrolü (4. sütun) ve ID kontrolü (1. sütun)
            if (row[3] === "alihanaykanat@buyutech.com.tr" || 
                (typeof row[0] === 'number' && row[0] < 189)) {
                continue; // Bu satırı atla
                }
            const newRow = [...row];
            let isError = false;

            try {
              if (typeof row[6] === 'number') {
                const dateObj = excelDateToJSDate(row[6]);
                const formatted = dateObj.toLocaleDateString('tr-TR');
                newRow[6] = formatted;
                if (!isValidDateFormat(formatted)) isError = true;
              }

              [9, 10].forEach(idx => {
                if (typeof row[idx] === 'number') {
                  const hourDecimal = row[idx] * 24;
                  const hh = String(Math.floor(hourDecimal)).padStart(2, '0');
                  const mm = String(Math.round((hourDecimal % 1) * 60)).padStart(2, '0');
                  newRow[idx] = `${hh}:${mm}`;
                } else if (typeof row[idx] === 'string') {
                  newRow[idx] = row[idx];
                }
                if (!isTimeStringValid(newRow[idx])) isError = true;
              });

              if (!isPatternValid(newRow[12], Hatalar_list)) isError = true;
              if (!isPatternValid(newRow[14], Duruslar_list)) isError = true;

            } catch (err) {
              console.error(`Satır ${i + 1} hatalı:`, err);
              isError = true;
            }

            if (isError) {
              errorRows.push(newRow);
              errorCount++;
            } else {
              successRows.push(newRow);
              successCount++;
            }
          }

          updateProgress(endIndex - 1, totalRows);

          if (endIndex < json.length) {
            // Sonraki batch'i işlemek için kısa bir bekleme
            setTimeout(() => processRows(endIndex), 10);
          } else {
            // İşlem tamamlandı
            finishProcessing();
          }
        }

        function finishProcessing() {
          hideProgress();

          document.getElementById('buttonContainer').style.display = 'flex';

          window.processedHeaders = headers;
          window.processedSuccessRows = successRows;
          window.processedErrorRows = errorRows;

          // Dosya işlemi tamamlandıktan sonra input'u temizle
          fileInput.value = '';
        }

        // İşleme başla
        if (totalRows > 0) {
          processRows(1);
        } else {
          hideProgress();
          fileInput.value = '';
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>